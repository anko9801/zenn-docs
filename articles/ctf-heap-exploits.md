---
title: "ãƒ’ãƒ¼ãƒ—é ˜åŸŸã‚’å¼„ã£ã¦ Heap Exploit ã‚’ç†è§£ã—ã¦ã¿ã‚‹"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CTF", "pwn"]
published: true
---

pwn ã¨ã„ã†ã®ã¯ãƒ¡ãƒ¢ãƒªã®æ›¸ãæ›ãˆã‚„èª­ã¿å–ã‚Šãªã©ã®ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è„†å¼±æ€§ã‚’ç”¨ã„ã¦æ„å›³ã—ãªã„å‹•ä½œã‚’å¼•ãèµ·ã“ã•ã›ã‚‹ç«¶æŠ€ã§æœ€ã‚‚ãƒãƒƒã‚­ãƒ³ã‚°ã£ã½ã„åˆ†é‡ã§ã™ã€‚

- [ä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã‚’ã—ã¦ Stack Exploit ã‚’ç†è§£ã—ã¦ã¿ã‚‹](https://zenn.dev/anko/articles/ctf-pwn-stack-exploits)
- [ãƒ’ãƒ¼ãƒ—é ˜åŸŸã‚’å¼„ã£ã¦ Heap Exploit ã‚’ç†è§£ã—ã¦ã¿ã‚‹](https://zenn.dev/anko/articles/ctf-heap-exploits)

ä»Šå›ã¯ãƒ’ãƒ¼ãƒ—é ˜åŸŸã‚’æ”»æ’ƒã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚ã“ã“ã§ã¯ 64bit ã‚·ã‚¹ãƒ†ãƒ ã‚’å‰æã¨ã—ã¾ã™ã€‚

## malloc / free ã®ä»•çµ„ã¿

ç¾ä»£ã«ãŠã„ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ å®Ÿè¡Œä¸­ã«æ–°ã—ããƒ¡ãƒ¢ãƒªãŒå¿…è¦ã«ãªã‚‹ã“ã¨ã¯éå¸¸ã«ã‚ˆãã‚ã‚Šã¾ã™ã€‚ãã®ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ã‚¹ã‚¿ãƒƒã‚¯é ˜åŸŸã§ã¯é›£ã—ã„ã®ã§ã€ãƒ’ãƒ¼ãƒ—é ˜åŸŸã¨ã„ã†ãƒ¡ãƒ¢ãƒªé ˜åŸŸã‚’æ–°ãŸã«ç”¨æ„ã—ã¦ãƒ¡ãƒ¢ãƒªã®è¦æ±‚ã®åº¦ã«ã€Œã©ã“ã©ã“ã®ãƒ¡ãƒ¢ãƒªã‚’ä½¿ã£ã¦ãã ã•ã„ã€ã¨å‰²ã‚Šå½“ã¦ã‚‹ã¨ã„ã£ãŸç®¡ç†æ–¹æ³•ã‚’å–ã‚Šã¾ã™ã€‚ãã—ã¦ glibc ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ãŠã‘ã‚‹ãƒ’ãƒ¼ãƒ—é ˜åŸŸã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ã„ã†ã®ãŒ `malloc()` `free()` ã§ã™ã€‚

```c
void *malloc(size_t size);
void free(void *ptr);
```

ã“ã® `malloc()` `free()` ã®å‡¦ç†ã‚’ç†è§£ã™ã‚‹ã®ãŒ Heap Exploit ã®å¤§äº‹ãªå¤§äº‹ãªå¤§ããªä¸€æ­©ã¨ãªã‚Šã¾ã™ã€‚

ã“ã†ã„ã£ãŸãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’ Allocator ã¨ã„ã£ã¦ã€ä»Šå›ã¯ glibc ã® Allocator ã®ã¿ã‚’è§£èª¬ã—ã¾ã™ãŒã€ä»–ã® Allocator (jemalloc, tcmalloc, mimalloc, libmalloc ãªã©) ã‚‚ã»ã¨ã‚“ã©åŒã˜å½¢ãªã®ã§ Windows ã‚„ MacOS ãªã©ã®æ”»æ’ƒã«ã‚‚é€šã˜ã¾ã™ã€‚

ã•ã¦ã€ã“ã® `malloc()` `free()` ã‚’è¦‹äº‹ã«è§£èª¬ã—ã¦ã„ã‚‹ä¼èª¬ã®å‹•ç”»ãŒã‚ã‚Šã¾ã™ã€‚é€šç§° malloc å‹•ç”»ã¨ã„ã£ã¦ pwner èª°ã—ã‚‚ãŒè¦‹ã¦ã„ã‚‹ã®ã§å¿…ãšè¦‹ã¾ã—ã‚‡ã†ã€‚è¦‹ã‚‹å‰ã¨è¦‹ãŸå¾Œã§ã¯è§£åƒåº¦ãŒæ®µé•ã„ã ã¨æ€ã„ã¾ã™ã€‚

https://www.youtube.com/watch?v=0-vWT-t0UHg

ã‚ã¨ glibc ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ malloc.c ã®èª­æ›¸ã‚‚ãŠã™ã™ã‚ã§ã€æ¬¡ã®è¨˜äº‹ã§ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚æ™‚é–“ãŒã‚ã£ãŸã‚‰æ˜¯é malloc.c ã‚’èª­æ›¸ã—ã¾ã—ã‚‡ã†ã€‚

- [malloc.c ã‚’èª­ã‚€ (malloc / free)](https://zenn.dev/anko/articles/malloc-malloc-free)
- [malloc.c ã‚’èª­ã‚€ (bins)](https://zenn.dev/anko/articles/malloc-each-bins)
- [malloc.c ã‚’èª­ã‚€ (arena)](https://zenn.dev/anko/articles/malloc-arena)

## ãŠãŠã–ã£ã±ãªç†è§£

ãƒ’ãƒ¼ãƒ—é ˜åŸŸã§ã¯ **ãƒãƒ£ãƒ³ã‚¯** (chunk) ã¨å‘¼ã°ã‚Œã‚‹æ§‹é€ ä½“ãŒå¤§é‡ã«ã‚ã‚Šã€ãã‚Œãã‚Œä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒãƒ£ãƒ³ã‚¯ã ã£ãŸã‚Šã€è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã ã£ãŸã‚Šã—ã¾ã™ã€‚malloc ã™ã‚‹ã¨è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®ä¸­ã‹ã‚‰åˆ‡ã‚Šå‡ºã•ã‚Œã€ãã®ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãŒè¿”ã•ã‚Œã¾ã™ã€‚é€†ã« free ã™ã‚‹ã¨æ—¢ã«ç¢ºä¿ã—ãŸãƒãƒ£ãƒ³ã‚¯ã«è§£æ”¾ã—ãŸã“ã¨ã‚’æ›¸ãè¾¼ã¿ã€free list ã«ç¹‹ã’ã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ãƒãƒ£ãƒ³ã‚¯ã¯æ¬¡ã®ã‚ˆã†ãªæ§‹é€ ã¨ãªã£ã¦ã„ã¾ã™ã€‚

- ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã¯ 0x20 ãƒã‚¤ãƒˆä»¥ä¸Šã§ 0x10 ã®å€æ•°ã¨ãªã£ã¦ã„ã‚‹ã€‚
- ç¢ºä¿ã—ãŸãƒ‡ãƒ¼ã‚¿ã®ç›´å‰ã«ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãªã©ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒæ›¸ãè¾¼ã¾ã‚Œã¦ãŠã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®æœ«å°¾ 8 ãƒã‚¤ãƒˆã¯æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã¨è¢«ã£ã¦ã„ã‚‹ã€‚

![](/images/pwn/chunk.png =480x)

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å | èª¬æ˜ |
| :-- | --- |
| `prev_size` | ä¸€ã¤å‰ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã€‚`PREV_INUSE` ãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ãªã„ã¨ãã«æ›¸ãè¾¼ã¾ã‚Œã¦ã„ã‚‹ã€‚ |
| `size` | ã“ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã€‚ä¸‹ä½ 3bit ã¯ãƒ•ãƒ©ã‚°ã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹ã€‚ |
| `NON_MAIN_ARENA` | ãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã—ã¦ã„ã‚‹ã®ãŒ `main_arena` ã§ã‚ã‚‹ã‹ã©ã†ã‹ (ãƒ’ãƒ¼ãƒ—é ˜åŸŸã®ç®¡ç†éƒ¨ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã«å¿…è¦) |
| `IS_MMAPED` | ãƒ¡ãƒ¢ãƒªãŒ mmap ã§ç¢ºä¿ã•ã‚ŒãŸã‹ (free æ™‚ã® munmap ã§è§£æ”¾ã™ã‚‹ã‹ã®åˆ¤æ–­ã«å¿…è¦) |
| `PREV_INUSE` | å‰ã®ãƒãƒ£ãƒ³ã‚¯ãŒä½¿ç”¨ä¸­ã‹ã€‚ä½¿ç”¨ä¸­ã§ãªã‘ã‚Œã° `prev_size` ã«å‰ã®ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒæ›¸ãè¾¼ã¾ã‚Œã¦ã„ã‚‹ã€‚ |

free list ã¨ã¯ãƒãƒ£ãƒ³ã‚¯ã‚’é€£çµãƒªã‚¹ãƒˆã®ã“ã¨ã§ã“ã® free list ã‚’æ›¸ãæ›ãˆã‚‹ã“ã¨ã§ Heap Exploit ã—ã¾ã™ã€‚æ¬¡ã¯ã“ã®æ§‹é€ ã¨å…·ä½“çš„ãªå‹•ä½œã‚’è§£èª¬ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

## ãƒãƒ£ãƒ³ã‚¯ã®ç®¡ç†

free list ã®æ­£ä½“ã¯ bins ã¨å‘¼ã°ã‚Œã‚‹ãƒªã‚¹ãƒˆç¾¤ã§ã™ã€‚bins ã¯ã„ãã¤ã‹ã®ç¨®é¡ãŒã‚ã£ã¦ã‚µã‚¤ã‚ºã«ã‚ˆã£ã¦ç®¡ç†ã®ä»•æ–¹ã‚’å¤‰ãˆã‚‹ã“ã¨ã§æœ€é©åŒ–ã—ã¦ã„ã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ 2 ã¤ã‚ã‚Šã€å˜æ–¹å‘ãƒªã‚¹ãƒˆ (LIFO) ã¨åŒæ–¹å‘ãƒªã‚¹ãƒˆ (FIFO) ãŒã‚ã‚Šã¾ã™ã€‚ãƒªã‚¹ãƒˆã®èµ°æŸ»ã«ã¯ forward pointer (fd) ã¨ back pointer (bk) ã‚’ä½¿ã„ã€ã“ã‚Œã‚‰ã®å…ˆé ­ãƒã‚¤ãƒ³ã‚¿ã¨æœ«å°¾ãƒã‚¤ãƒ³ã‚¿ã¯ arena ã¨ã„ã†ãƒ’ãƒ¼ãƒ—é ˜åŸŸã®å…ˆé ­éƒ¨åˆ†ã«æ›¸ãè¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚ãã‚Œãã‚Œã®æŒ¿å…¥ (link) ã‚„å‰Šé™¤ (unlink) ã®å‡¦ç†ã¯ç†è§£ã—ã¦ã„ã‚‹å‰æã§è©±ã‚’é€²ã‚ã¾ã™ã€‚

bins ã®ä¸€è¦§ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

| bins ã®ç¨®é¡ | ã‚µã‚¤ã‚º | èª¬æ˜ | ãƒ‡ãƒ¼ã‚¿æ§‹é€  |
| --- | --- | --- | --- |
| tcache bins | ~0x410 | æœ€åˆã«å…¥ã‚Œã‚‰ã‚Œã‚‹ just-fit ãª bin | å˜æ–¹å‘ãƒªã‚¹ãƒˆ |
| fastbins | ~0x80 | é »ç¹ã«ç¢ºä¿ãƒ»è§£æ”¾ãŒèµ·ã“ã‚‹å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ just-fit ãª bin | å˜æ–¹å‘ãƒªã‚¹ãƒˆ |
| unsortedbin | ä»»æ„ | æœ€è¿‘ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ bin | åŒæ–¹å‘ãƒªã‚¹ãƒˆ |
| smallbins | ~0x3f0 | å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ just-fit ãª bin | åŒæ–¹å‘ãƒªã‚¹ãƒˆ |
| largebins | 0x400~ | å¤§ããªãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ bin | åŒæ–¹å‘ãƒªã‚¹ãƒˆ + ã‚¹ã‚­ãƒƒãƒ—ãƒªã‚¹ãƒˆ |

ä¸€èˆ¬ã«å˜æ–¹å‘ã®ã»ã†ãŒå‡¦ç†ãŒé«˜é€Ÿãªã®ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ‹…å½“ã® tcache bins ã¨ fastbins ã¯å˜æ–¹å‘ãƒªã‚¹ãƒˆã§ã™ãŒåŒæ–¹å‘ãƒªã‚¹ãƒˆã«æ¯”ã¹ã¦è„†å¼±ãªã®ã§ä½¿ç”¨ã™ã‚‹ã¹ãã¨ã“ã‚ã¯æœ€å°é™ã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚

ãã—ã¦ malloc / free ã—ãŸã¨ãã«æ¬¡ã®ã‚ˆã†ãªé †ã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚

```mermaid
graph TD
    0(malloc å‘¼ã³å‡ºã—) --> A
    A(tcache bins) --> B(fastbins)
    B --> |smallbins ç¯„å›²å†…| C(smallbins)
    B --> |largebins ç¯„å›²å†…| D(fastbins ã®çµ±åˆ)
    C --> E(unsortedbin)
    D --> E
    E --> F(smallbins, largebins ã«æŒ¯ã‚Šåˆ†ã‘)
    F --> G(top chunk ã‹ã‚‰åˆ‡ã‚Šå‡ºã—)
    G --> |fastbins ã«æ®‹ã£ã¦ã‚‹| H(fastbins ã®çµ±åˆ)
    G --> |fastbins ã«æ®‹ã£ã¦ãªã„| I(sysmalloc)
    H --> E
```

```mermaid
graph TD
    0(free å‘¼ã³å‡ºã—) --> A
    A(tcache bins) --> B(fastbins)
    B --> C(éš£ã¨çµ±åˆã—ã¦ unsortedbin)
```

æœ€åˆã¯ãã“ã¾ã§ç†è§£ã™ã‚‹å¿…è¦ã¯ãªã„ã§ã™ãŒã©ã¡ã‚‰ã‚‚æœ€åˆã« tcache bins ã‚’èµ°æŸ»ã™ã‚‹ã“ã¨ã¯æ”»æ’ƒã§ã¨ã¦ã‚‚é »å‡ºãªã®ã§è¦šãˆã¦ãŠã„ã¦ãã ã•ã„ã€‚

### tcache bins

| | èª¬æ˜ |
| --- | --- |
| å°å…¥æ™‚æœŸ | glibc v2.26 ä»¥é™ |
| æ§‹é€  | å˜æ–¹å‘ãƒªã‚¹ãƒˆ |
| bin ã®æ•° | ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x20 ã‹ã‚‰ 0x410 ã¾ã§ã® 64 ç¨®é¡ã® tcache bin |
| å½¹å‰² | å‚ç…§å±€æ‰€æ€§ã‚’é«˜ã‚ã‚‹ |
| å…ˆé ­ | ãƒ’ãƒ¼ãƒ—é ˜åŸŸã®å…ˆé ­ã«ã‚ã‚‹ arena ã®å¾Œã«ã‚ã‚‹ `tcache_perthread_struct` |

ãƒªã‚¹ãƒˆã®é•·ã•ã¯ 7 å€‹ã«åˆ¶é™ã•ã‚Œã¦ã„ã¦ tcache ãŒæº€æ¯ã«ãªã‚‹ã¨ä»–ã® bins ã«ç§»ã•ã‚Œã¾ã™ã€‚ã‚µã‚¤ã‚ºã”ã¨ã«åˆ†ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ just-fit ã§è¿”ã›ã¾ã™ã€‚æœ«å°¾ã® fd ã¯ NULL ã«ãªã‚Šã¾ã™ã€‚

![](/images/pwn/tcache.png =480x)

tcache bins ã®å®Ÿä½“ã¯ `tcache_perthread_struct` æ§‹é€ ä½“ã§ã™ã€‚ `entries` ã§å„ãƒªã‚¹ãƒˆã® HEAD ã®ãƒãƒ£ãƒ³ã‚¯ã«ç¹‹ã’ã¦ã€ `counts` ã§ãƒªã‚¹ãƒˆã®é•·ã•ã‚’ç®¡ç†ã—ã€7 å€‹ã«ãªã£ãŸã‚‰å—ã‘ä»˜ã‘ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚ãƒãƒ£ãƒ³ã‚¯ãŒ tcache bin ã«å…¥ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã« `tcache_entry` æ§‹é€ ä½“ãŒ overlap ã•ã‚Œã¦ãƒªã‚¹ãƒˆã«å…¥ã‚Šã¾ã™ã€‚

```c
typedef struct tcache_entry
{
  struct tcache_entry *next;              // æ¬¡ã® tcache_entry ã¸ã®ãƒã‚¤ãƒ³ã‚¿
  struct tcache_perthread_struct *key;    // ä¹±æ•°ã‚’ç”¨ã„ã¦ double free ã‚’æ¤œçŸ¥
} tcache_entry;

typedef struct tcache_perthread_struct
{
  uint16_t counts[TCACHE_MAX_BINS];       // å„ bin ã®é•·ã•ã®ä¸€è¦§
  tcache_entry *entries[TCACHE_MAX_BINS]; // å„ bin ã®æœ€åˆã® tcache ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã®ä¸€è¦§
} tcache_perthread_struct;
```

### fastbins

| | èª¬æ˜ |
| --- | --- |
| å°å…¥æ™‚æœŸ | glibc v2.3 ä»¥é™ |
| æ§‹é€  | å˜æ–¹å‘ãƒªã‚¹ãƒˆ |
| bin ã®æ•° | ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x20 ã‹ã‚‰ 0x80 ã¾ã§ 7 ç¨®é¡ã® fastbin |
| å½¹å‰² | å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |
| å…ˆé ­ | `arena.fastbinsY` ã§ç®¡ç† |

ãƒãƒ£ãƒ³ã‚¯ã¯å°ã•ã„ã»ã©é »ç¹ã«ç¢ºä¿ãƒ»é–‹æ”¾ã•ã‚Œã¾ã™ã€‚ãã“ã§å°ã•ãªã‚‚ã®ã ã‘å…ˆã«å‡¦ç†ã™ã‚‹ã“ã¨ã§é«˜é€ŸåŒ–ã§ãã¾ã™ã€‚

![](/images/pwn/fastbin.png =480x)

### unsortedbin / smallbins / largebins

ã“ã‚Œã‚‰ 3 ã¤ã® bins ã¯æ¯”è¼ƒçš„å¤ã„ãƒãƒ£ãƒ³ã‚¯ã‚’å–ã‚Šæ‰±ã„ã¾ã™ã€‚ãŸã ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ãã“ã¾ã§å¤šããªã„ã®ã§é€šå¸¸ã®ã‚¢ãƒ—ãƒªã«ãŠã‘ã‚‹ malloc / free ã§ã¯ã“ã‚Œã‚‰ã® bins ã‚’ä½¿ã†ã¨è€ƒãˆã¦ã‚ˆã„ã§ã™ã€‚

|  | unsortedbin ã®èª¬æ˜ |
| --- | --- |
| å°å…¥æ™‚æœŸ | å¤ã„ |
| æ§‹é€  | åŒæ–¹å‘ãƒªã‚¹ãƒˆ |
| bin ã®æ•° | 1 ã¤ |
| å½¹å‰² | å‚ç…§å±€æ‰€æ€§ã‚’é«˜ã‚ã‚‹ |
| å…ˆé ­ãƒ»æœ«å°¾ | `arena.bin` ã§ç®¡ç† |

unsortedbin ã¯ tcache ã‚„ fastbins ã®ãŠã“ã¼ã‚Œã‚„ fastbins ã‚’çµ±åˆã—ãŸãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã—ã¾ã™ã€‚ãã—ã¦ malloc ã§ unsortedbin ã‚’èµ°æŸ»ã—ãŸã¨ãã«ã‚µã‚¤ã‚ºãŒä¸€è‡´ã—ãªã‘ã‚Œã°å¤–ã•ã‚Œã€å°ã•ã„ã‚‚ã®ã¯ smallbins ã«ã€å¤§ããªã‚‚ã®ã¯ largebins ã«ç¹‹ãŒã‚Œã¾ã™ã€‚

![](/images/pwn/smallbin.png =480x)

|  | smallbins ã®èª¬æ˜ |
| --- | --- |
| å°å…¥æ™‚æœŸ | å¤ã„ |
| æ§‹é€  | åŒæ–¹å‘ãƒªã‚¹ãƒˆ |
| bin ã®æ•° | ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x400 æœªæº€ã® 62 ç¨®é¡ã® smallbin |
| å½¹å‰² | å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ |
| å…ˆé ­ãƒ»æœ«å°¾ | `arena.bin` ã§ç®¡ç† |

![](/images/pwn/smallbin.png =480x)

|  | largebins ã®èª¬æ˜ |
| --- | --- |
| å°å…¥æ™‚æœŸ | å¤ã„ |
| æ§‹é€  | åŒæ–¹å‘ãƒªã‚¹ãƒˆ + ã‚¹ã‚­ãƒƒãƒ—ãƒªã‚¹ãƒˆ |
| bin ã®æ•° | ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x400 ä»¥ä¸Šã® 63 ç¨®é¡ã® largebin |
| å½¹å‰² | å¤§ããªãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ |
| å…ˆé ­ãƒ»æœ«å°¾ | `arena.bin` ã§ç®¡ç† |

å¤§ããªã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ã‚‚ 16 ãƒã‚¤ãƒˆã”ã¨ã«ç®¡ç†ã™ã‚‹ã®ã¯ç¾å®Ÿçš„ã§ã¯ãªã„ã®ã§ã€ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚‹ã«ã¤ã‚Œã¦å¹…ã‚‚æŒ‡æ•°çš„ã«å¤§ããã™ã‚‹ã“ã¨ã§ãƒªã‚¹ãƒˆã®æ•°ã‚’å¹³å‡åŒ–ã—ã€æœ€æ‚ªè¨ˆç®—é‡ã‚’æ¸›ã‚‰ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã¯åŒæ–¹å‘ãƒªã‚¹ãƒˆã®ãƒ¡ãƒ³ãƒã«åŠ ãˆã¦ fd_nextsize bk_nextsize ãŒã‚ã‚Šã€ãã‚Œãã‚Œãƒãƒ£ãƒ³ã‚¯ã®å¹…ã®ä¸­ã§æ¬¡ã«å¤§ããªãƒãƒ£ãƒ³ã‚¯ã¨æ¬¡ã«å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãŒæ ¼ç´ã•ã‚Œã¾ã™ã€‚ã¾ãŸ largebins ã‹ã‚‰ç¢ºä¿ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªã¯ last_remainder ã«ã¯ã‚»ãƒƒãƒˆã•ã‚Œã¾ã›ã‚“ã€‚

![](/images/pwn/largebin.png =480x)

ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºã¨ bins ã®é–¢ä¿‚ãªã©ã®æƒ…å ±ã«ã¤ã„ã¦è¡¨ã«ã¾ã¨ã‚ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

| bins ã®ç¨®é¡ | ç¯„å›² | ç¯„å›² (ãƒã‚¤ãƒˆè¡¨ç¤º) | é–“éš” | å€‹æ•° | `bin_at(n)` |
| --- | --- | --- | --- | :-: | --- |
| unsortedbin | 0x20 ~ | ã™ã¹ã¦ | infinity | 1 | 1 |
| smallbins | 0x20 ~ 0x3F0 | 1KB æœªæº€ | 0x10 | 62 | 2 ~ 63 |
| largebins | 0x400 ~ 0xC30 | 1KB ä»¥ä¸Š 3KB æœªæº€ | 0x40 | 35 | 64 ~ 96 |
| largebins | 0xC40 ~ 0x29F0 | 3KB ä»¥ä¸Š 12KB æœªæº€ | 0x200 | 15 | 97 ~ 111 |
| largebins | 0x3000 ~ 0xAFF0 | 12KB ä»¥ä¸Š 44KB æœªæº€ | 0x1000 | 9 | 112 ~ 120 |
| largebins | 0xB000 ~ 0x27FF0 | 44KB ä»¥ä¸Š 160KB æœªæº€ | 0x8000 | 3 | 121 ~ 123 |
| largebins | 0x28000 ~ 0xBFFF0 | 160KB ä»¥ä¸Š 768KB æœªæº€ | 0x40000 | 2 | 124 ~ 125 |
| largebins | 0xC0000 ~  | 768KB ä»¥ä¸Š | infinity | 1 | 126 |

### main arena

ã“ã‚Œã‚‰ã® bins ã¯ã‚¢ãƒªãƒ¼ãƒŠã¨ã„ã†æ©Ÿæ§‹ã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã¾ã™ã€‚ã‚¢ãƒªãƒ¼ãƒŠã¯å˜æ–¹å‘ãƒªã‚¹ãƒˆã§ã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã«å…ˆé ­ã‚’ `main_arena` ã¨ã„ã†å¤‰æ•°ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã‚¢ãƒªãƒ¼ãƒŠã¯ `malloc_state` æ§‹é€ ä½“ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

```c
struct malloc_state
{
  __libc_lock_define (, mutex);     // arena ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ serialize ã™ã‚‹
  int flags;                        // ãƒ’ãƒ¼ãƒ—ãƒ¡ãƒ¢ãƒªãŒé€£ç¶šã§ã‚ã‚‹ã‹

  int have_fastchunks;              // fastbins ãŒç©ºã§ã¯ãªã„ã“ã¨ã‚’è¡¨ã™çœŸå½å€¤
  mfastbinptr fastbinsY[NFASTBINS]; // fastbins

  mchunkptr top;                    // ãƒ’ãƒ¼ãƒ—é ˜åŸŸã®æœ€å¾Œã«ã‚ã‚‹æœªä½¿ç”¨ã®å¤§ããªãƒãƒ£ãƒ³ã‚¯
  mchunkptr last_remainder;         // åˆ†å‰²ã—ã¦ç¢ºä¿ã—ãŸéš›ã«ä½™ã£ãŸé ˜åŸŸã®æœ€æ–°ã®ãƒãƒ£ãƒ³ã‚¯

  mchunkptr bins[NBINS * 2 - 2];    // unsortedbin smallbins largebins ã®å…ˆé ­ãƒ»æœ«å°¾
  unsigned int binmap[BINMAPSIZE];  // ã“ã‚Œã‚‰ã‚’ç´ æ—©ãè¦‹ã¤ã‘ã‚‹ç‚ºã«ä½¿ã‚ã‚Œã‚‹ãƒ“ãƒƒãƒˆãƒ™ã‚¯ã‚¿

  struct malloc_state *next;        // arena ã®å˜æ–¹å‘ãƒªã‚¹ãƒˆ
  struct malloc_state *next_free;   // ä½¿ã‚ã‚Œã¦ã„ãªã„ arena ã®å˜æ–¹å‘ãƒªã‚¹ãƒˆ
  INTERNAL_SIZE_T attached_threads; // arena ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã®æ•°

  INTERNAL_SIZE_T system_mem;       // arena ã«ã‚ˆã£ã¦ç¾åœ¨ç¢ºä¿ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ¢ãƒªã®åˆè¨ˆå€¤
  INTERNAL_SIZE_T max_system_mem;   // system_mem ã®æœ€å¤§å€¤
};
```

### malloc hooks

glibc ã«ã¯ã„ãã¤ã‹ã® hook ãŒã‚ã‚Šã¾ã™ãŒ malloc é–¢é€£ã® hooks ã¯ Heap Exploit ã«ã¦éå¸¸ã«ã‚ˆãä½¿ã‚ã‚Œã¦ã„ã¾ã—ãŸã€‚

| é–¢æ•°å | æ¡ä»¶ |
| --- | --- |
| `__malloc_hook` | `malloc()` å‘¼ã³å‡ºã—æ™‚ |
| `__free_hook` | `free()` å‘¼ã³å‡ºã—æ™‚ |
| `__realloc_hook` | `realloc()` å‘¼ã³å‡ºã—æ™‚ |
| `__after_morecore_hook` | `malloc()` å‘¼ã³å‡ºã—æ™‚ |
| `__malloc_initialize_hook` | åˆæœŸ `malloc()` æ™‚ |
| `__memalign_hook` | `aligned_alloc()` `memalign()` `posix_memalign()` `valloc()` å‘¼ã³å‡ºã—æ™‚ |
| `_dl_open_hook` | å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ãƒ¼ãƒ‰æ™‚ |

ã—ã‹ã—ã“ã‚Œã‚‰ã® hooks ã¯ glibc v2.34 ä»¥é™ã§å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚

## ãƒ’ãƒ¼ãƒ—é ˜åŸŸã§ã®æ›¸ãæ›ãˆ

ãƒ’ãƒ¼ãƒ—é ˜åŸŸã«ãŠã„ã¦ã¯ `fd` `bk` ã®æ›¸ãæ›ãˆãŒç›®æ¨™ã§ã™ã€‚ã“ã‚ŒãŒã§ãã‚Œã° free list ã®ãƒªã‚¹ãƒˆæ§‹é€ ã‚’å£Šã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ malloc / free ã‚’ç¹°ã‚Šè¿”ã™ã¨ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸æ›¸ãæ›ãˆãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã¾ãšã¯å˜æ–¹å‘ãƒªã‚¹ãƒˆã§ã‚ã‚‹ tcache bins ã¨ fastbins ã«ãŠã„ã¦ `free()` `malloc()` ãŒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚ LIFO ãªã®ã§æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```
free A: head -> A -> tail
free B: head -> B -> A -> tail
free C: head -> C -> B -> A -> tail
free D: head -> D -> C -> B -> A -> tail
malloc: head -> C -> B -> A -> tail
malloc: head -> B -> A -> tail
malloc: head -> A -> tail
malloc: head -> tail
```

å®Ÿéš›ä¸Š `tail` ã¨ã¯ `NULL` ã®ã“ã¨ã§ã™ã€‚

### arena ã®æ›¸ãæ›ãˆ
malloc ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ãƒ’ãƒ¼ãƒ—é ˜åŸŸã®å…ˆé ­ã‚’è¨ˆç®—ã§ãã‚Œã° arena ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚ã‹ã‚Šã¾ã™ã€‚ãã“ã«

```
             head -> tail
write arena: head -> victim
malloc:      head
```

### Use After Free
free() ãŒå‘¼ã°ã‚ŒãŸå¾Œã§ã‚‚èª­ã¿æ›¸ããŒå‡ºæ¥ã¦ã—ã¾ã†è„†å¼±æ€§ã€‚ã“ã‚ŒãŒä¸€ç•ªæ‰‹ã£å–ã‚Šæ—©ã `fd` `bk` ã®èª­ã¿æ›¸ããŒå‡ºæ¥ã¾ã™ã€‚

è§£æ”¾ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’ dangling pointer (ã¶ã‚‰ã•ãŒã£ãŸãƒã‚¤ãƒ³ã‚¿) ã¨è¨€ã„ã¾ã™ã€‚

ä¾‹ãˆã° tcache ã«å…¥ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã® next ã‚’æ›¸ãæ›ãˆã¦ malloc ã™ã‚‹ã“ã¨ã§ AAW ã§ãã‚‹ tcache poisoning ãŒã‚ã‚‹ã€‚

```
free A:     head -> A -> tail
write next: head -> A -> victim
malloc:     head -> victim
malloc:     head
```

ä»–ã«ã‚‚ unsortedbin ã«



tcache poisoning ã—ã¦ `__free_hook` ã‚’æ›¸ãæ›ãˆã‚‹ã€‚
åŒã˜é ˜åŸŸã«æ‚ªæ„ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºä¿ã—ã¦åˆ©ç”¨ã•ã›ã‚‹äº‹ã§ã€é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã‚’æ›¸ãæ›ãˆã‚‹ã€‚

[SECCON Beginners CTF 2019 - Babyheap - HackMD](https://hackmd.io/@Xornet/H1hYUUR2I)

æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

| bins ã®ç¨®é¡ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | èª¬æ˜ |
| --- | --- | --- |
| smallbins | | `victim.bk->fd == victim` |

`fd` `bk` ã‚’è‡ªåˆ†è‡ªèº«ã«å‘ã‘ã‚‹ (2.27) ã“ã¨ã§ãƒã‚¤ãƒ‘ã‚¹

### Heap based Buffer Overflow
Heap ä¸Šã§ã® BOF ã§ã™ã€‚è¤‡æ•°å› malloc ã™ã‚‹ã¨å‚ç…§å±…æ‰€æ€§ãªã©ã®ç†ç”±ã‹ã‚‰é€£ç¶šã«ä¸¦ã¶ã“ã¨ãŒå¤šã„ã§ã™ã€‚ãã†ã™ã‚‹ã¨ä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒãƒ£ãƒ³ã‚¯ã‹ã‚‰ BOF ã—ã¦åˆ¥ã®ãƒãƒ£ãƒ³ã‚¯ã®æ›¸ãæ›ãˆãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€å¤‰æ•°ã®æ›¸ãæ›ãˆã‚„ `fd` `bk` ã®æ›¸ãæ›ãˆãŒå‡ºæ¥ã¾ã™ã€‚

### Double Free
2 å› free ã™ã‚‹ã¨å‚ç…§ãŒãƒ«ãƒ¼ãƒ—ã™ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Š fd ã«æ„å›³ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãè¾¼ã‚ã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

```
        head -> tail
free A: head -> A -> tail
free A: head -> A -> A -> A -> ...
```
```
        head -> tail
free A: head -> A -> tail
free B: head -> B -> A -> tail
free A: head -> A -> B -> A -> B -> ...
```

ã“ã‚Œã«å¯¾ã—ã¦ double-free æ¤œçŸ¥ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹ãŒã‚ã‚‹ã€‚

| bins ã®ç¨®é¡ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | èª¬æ˜ |
| --- | --- | --- |
| tcache bins | glibc 2.29 ä»¥é™ | `key` `tcache_perthread_struct` æ§‹é€ ä½“ |
| fastbins | | åŒã˜é ˜åŸŸã‚’ 2 å›é€£ç¶šã§ free ã™ã‚‹ã¨ fasttop ã§è½ã¡ã‚‹ |

tcache ã‚’æ”»æ’ƒã™ã‚‹ã®ã¯ double-free æ¤œçŸ¥ãŒã‚ã‚‹ã®ã§å°‘ã—é›£ã—ã„ã€‚

## ãƒ’ãƒ¼ãƒ—é ˜åŸŸã§ã®æ”»æ’ƒæ–¹æ³•
ãƒ’ãƒ¼ãƒ—é ˜åŸŸã§ã¯å¤§é‡ã®æ”»æ’ƒæ‰‹æ³•ãŒè¦‹ã¤ã‹ã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ãã‚Œãã‚Œç‹¬è‡ªæ€§ãŒã‚ã‚‹ã‚‚ã®ã®å…±é€šã™ã‚‹éƒ¨åˆ†ãŒæ•°å¤šãã‚ã‚‹ã®ã§ã€ãã®æ‰‹æ³•ã‚’ç´°ã‹ãåˆ†ã‘ã‚Œã°ãƒ‘ã‚ºãƒ«ã®ã‚ˆã†ã«çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§å¤šãã®æ‰‹æ³•ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

tcache ä»¥å¤–ã‚’æ”»æ’ƒã™ã‚‹ã«ã¯ã¾ãš tcache ã‚’åŸ‹ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
tcache ã‚’åŸ‹ã‚ã‚‹ç‚ºã«ã¯ 7 å€‹

```c
for (int i=0; i<8; i++) {
    ptrs[i] = malloc(8);
}
for (int i=0; i<7; i++) {
    free(ptrs[i]);
}
```

### Safe Linking
fastbins ã¨ tcache ã«ãŠã„ã¦ `next` ã®ãƒã‚¤ãƒ³ã‚¿ã‚’ãƒã‚¹ã‚¯ã—ã€ã‚¢ãƒ©ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã‚‚ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

```c
#define PROTECT_PTR(pos, ptr) \
  ((__typeof (ptr)) ((((size_t) pos) >> 12) ^ ((size_t) ptr)))
#define REVEAL_PTR(ptr)  PROTECT_PTR (&ptr, ptr)
```

| æ¡ä»¶ | å¯èƒ½ãªå‡¦ç† |
| --- | --- |
| æ•´åˆæ€§ã‚’æº€ãŸã—ãŸ `fd` `bk` ã®æ›¸ãæ›ãˆ | `free()` ã§ free list ã«å½ãƒãƒ£ãƒ³ã‚¯æŒ¿å…¥ã€‚2 å›ç›®ä»¥é™ã¯ `free()` å¤±æ•—ã™ã‚‹ |
| å½ãƒãƒ£ãƒ³ã‚¯ã®ç¢ºä¿ãƒ»æ›¸ãè¾¼ã¿ | ä»»æ„ã‚¢ãƒ‰ãƒ¬ã‚¹æ›¸ãè¾¼ã¿ |
| unsortedbin ã® `bk` ã®æ›¸ãæ›ãˆ | unlink æ™‚ã« `bk->fd = bk + 0x10` ã« `&main_arena.top` ãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹ (< 2.28) |
| unsortedbin ã® `fd` ã®èª­ã¿å–ã‚Š | `&main_arena.bins` ã§ libc leak |
| æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã® `PREV_INUSE` ã‚’ã‚¯ãƒªã‚¢<br> `fd` `bk` `prev_size` ã‚’æ›¸ãæ›ãˆ | `free()` ã® consolidation backward ã§ unsortedbin ã«å½ãƒãƒ£ãƒ³ã‚¯æŒ¿å…¥ |
| `global_max_fast` ã®æ›¸ãæ›ãˆ | `free()` ã§ fastbins ä»¥é™ã«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãè¾¼ã‚ã‚‹ |
| `main_arena` ã§ `NON_MAIN_ARENA` ã‚’ç«‹ã¦ã‚‹ | arena ã®ä½ç½®ã‚’ãšã‚‰ã—ã¦æ›¸ãè¾¼ã‚ã‚‹ |
| top chunk ã®ã‚µã‚¤ã‚ºä»¥ä¸Šã® `malloc()` | top chunk ãŒ `free()` ã•ã‚Œã‚‹ |
| `arena_key` ã‚’æ›¸ãæ›ãˆã‚‹ (< 2.4) | |

### unsortedbin attack
unsortedbin ã® unlink æ™‚ã« `bk->fd` ã« `main_arena.top` ã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹ã“ã¨ã‚’åˆ©ç”¨ã—ãŸæ”»æ’ƒã€‚`bk` ã‚’ `global_max_fast` ã«å‘ã‘ã‚‹ã“ã¨ã§æ”¹ã–ã‚“ã—ã¦ fastbins ã®ç¯„å›²ã‚’æ‹¡å¤§ã§ãã‚‹ã€‚

- [Security Fest 2019 - Baby5 (Unsorted Bin) - HackMD](https://hackmd.io/@Xornet/rycqVwQpL)
- [næ—¥1CTFãƒãƒ£ãƒ¬ãƒ³ã‚¸ - HackMD](https://hackmd.io/@Xornet/BkemeSAhU)

### House of XXX
House of XXX ã¯ 2001 å¹´é ƒã« "Vudo Malloc Tricks" ã‚„ "Once Upon A free()" ã§ç´¹ä»‹ã•ã‚ŒãŸã“ã¨ã‹ã‚‰å§‹ã¾ã£ãŸ glibc malloc ã¸ã®æ”»æ’ƒæ‰‹æ³•ã®ç·ç§°ã§ã™ã€‚

| æ”»æ’ƒå | glibc | ã‚¢ã‚¤ãƒ‡ã‚¢ |
| --- | --- | --- |
| [House of Prime](https://dl.packetstormsecurity.net/papers/attack/MallocMaleficarum.txt) | < 2.4 | 8 ãƒã‚¤ãƒˆãƒãƒ£ãƒ³ã‚¯ã‚’ `free()` ã—ã¦ `fastbinsY[-1] == max_fast` ã‚’æ›¸ãæ›ãˆã¦ã€ `fastbinsY[289] == arena_key` ã‚’æ›¸ãæ›ãˆã‚‹ |
| House of Corrosion | 2.26 < glibc < 2.30 | `global_max_fast` ã‚’æ›¸ãæ›ãˆ<br> `stderr` ã‚’æ”¹ã–ã‚“ã™ã‚‹ |
| [House of Mind](https://dl.packetstormsecurity.net/papers/attack/MallocMaleficarum.txt) | < 2.11 | ãƒãƒ£ãƒ³ã‚¯ã® `NON_MAIN_ARENA` |
| House of Orange | < 2.26 | top chunk ã®ã‚µã‚¤ã‚ºã‚’ç¸®ã‚ã‚‹ `malloc()` ã‚’å‘¼ã¶ã¨ `sysmalloc()` ã§ `_int_free()` ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹  unsortedbin attack  `_IO_list_all` abort() ã™ã‚‹ã¨ _IO_flush_all_lockp() ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ |
| [House of Einherjar](https://www.slideshare.net/codeblue_jp/cb16-matsukuma-ja-68459648) | | PREV_INUSE ã®æ›¸ãæ›ãˆ unlink attack |
| House of Botcake | | ãƒãƒ£ãƒ³ã‚¯ A, B ã® back consolidation ã§ unsortedbin (A+B) ã‹ã¤ tcachebins (A,B) ã«å…¥ã£ã¦ã„ã‚‹çŠ¶æ…‹ã‚’ä½œã‚Œã‚‹ |
| [House of Muney](https://maxwelldulin.com/BlogPost/House-of-Muney-Heap-Exploitation) | | |

## glibc ã®ãƒ“ãƒ«ãƒ‰
ç‰¹å®šã® glibc ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã®æ”»æ’ƒã‚’è©¦ã—ãŸã„ã¨ãã«ãã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® glibc ã¨ãƒã‚¤ãƒŠãƒªã®ç´ä»˜ã‘ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

æ¬¡ã® URL ã§å¿…è¦ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® glibc ã®ã‚½ãƒ¼ã‚¹ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¨å‹•çš„ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (.so) ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚(ã“ã†ã™ã‚‹ã¨ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚‚ä»˜ã„ã¦ãã‚‹ã®ã§å¬‰ã—ã„)

- http://ftp.gnu.org/gnu/glibc/

```shell
mkdir build; cd build
../glibc-version/congifure --prefix=/path/to/build
make
make install
```

`ldd` ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã«ç´ä»˜ã„ã¦ã„ã‚‹å‹•çš„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ•™ãˆã¦ãã‚Œã¾ã™ã€‚
`pwninit` ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã¨å‹•çš„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åŒã˜éšå±¤ã«å…¥ã‚Œã¦ãŠã‘ã°ç´ä»˜ã‘ã¦ãã‚Œã¾ã™ã€‚

https://github.com/io12/pwninit

## ã¾ã¨ã‚
Heap Exploit ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚

ã“ã‚ŒãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚Œã° pwn ä¸­ç´šè€…ã¨è¨€ãˆãã†ã§ã™ã€‚

æ¬¡ã¯ Linux Kernel ã¨è¡ŒããŸã„ã§ã™ãŒã“ã‚Œã«é–¢ã—ã¦ã¯ ptr-yudai å…ˆç”Ÿã®è¨˜äº‹ã‚’èª­ã‚€ã®ãŒã„ã„ã§ã—ã‚‡ã†ã€‚

https://pawnyable.cafe/

## å‚è€ƒè³‡æ–™
- [how2heap](https://github.com/shellphish/how2heap)
- [Overview of GLIBC heap exploitation techniques](https://0x434b.dev/overview-of-glibc-heap-exploitation-techniques/)
- [A painter and a black cat - CTF Pwn](https://raintrees.net/projects/a-painter-and-a-black-cat/wiki/CTF_Pwn)
- [ã‚‚ã‚‚ã„ã‚ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ - glibc malloc exploit techniques](https://inaz2.hatenablog.com/entry/2016/10/13/203019)
- [malloc(3)ã®ãƒ¡ãƒ¢ãƒªç®¡ç†æ§‹é€ ](https://www.valinux.co.jp/technologylibrary/document/linux/malloc0001/)
- [malloc å‹•ç”»ã®è³‡æ–™](https://speakerdeck.com/kosaki/mallocnolu-glibcbian)
- [heap-exploitation](https://heap-exploitation.dhavalkapil.com/)
- [Heap Exploitã®ã“ã‚Œã¾ã§ã¨ç¾çŠ¶](https://www.ffri.jp/assets/files/monthly_research/MR201312_History%20and%20Current%20State%20of%20Heap%20Exploit_JPN.pdf)
