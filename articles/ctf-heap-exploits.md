---
title: "ã€CTF æ¢è¨ªè¨˜ã€‘Heap Exploit"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CTF", "pwn"]
published: true
---

ãƒ’ãƒ¼ãƒ—é ˜åŸŸã‚’æ”»æ’ƒã—ã¦ã¿ã‚‹è©±ã€‚ã“ã“ã§ã¯ 64bit ã‚·ã‚¹ãƒ†ãƒ ã‚’å‰æã¨ã—ã¾ã™ã€‚

## malloc / free ã®ä»•çµ„ã¿

`malloc()` ã§ãƒ’ãƒ¼ãƒ—é ˜åŸŸã«ã‚ã‚‹ãƒ¡ãƒ¢ãƒªã‚’ç¢ºä¿ã—ã¦ãã®ãƒã‚¤ãƒ³ã‚¿ã‚’è¿”ã—ã€`free()` ã¯ãã®ãƒã‚¤ãƒ³ã‚¿ã®ãƒ¡ãƒ¢ãƒªã‚’é–‹æ”¾ã—ã¦ãã‚Œã¾ã™ã€‚

```c
void *malloc(size_t size);
void free(void *ptr);
```
ã“ã®ãƒ’ãƒ¼ãƒ—é ˜åŸŸã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã‚ã‚‹ malloc / free é–¢æ•°ã®å‡¦ç†ã‚’ç†è§£ã™ã‚‹ã®ãŒ Heap Exploit ã®å¤§äº‹ãªå¤§ããªä¸€æ­©ã¨ãªã‚Šã¾ã™ã€‚

ã¨ã‚Šã‚ãˆãšã“ã®ä¼èª¬ã® malloc å‹•ç”»ã‚’è¦‹ã¾ã—ã‚‡ã†ã€‚

https://www.youtube.com/watch?v=0-vWT-t0UHg

ã‚ã¨ malloc.c ã®èª­æ›¸ã¯æ¬¡ã®è¨˜äº‹ã«ã¾ã¨ã‚ã¾ã—ãŸã€‚ãã‚Œãã‚Œå¤§åˆ†çŸ­ãã¾ã¨ã¾ã£ãŸã®ã§å…ˆã«èª­ã‚“ã§ã‚‚ã‚‰ã„ãŸã„ã§ã™ã€‚

- [malloc.c ã‚’èª­ã‚€ (malloc / free)](https://zenn.dev/anko/articles/malloc-malloc-free)
- [malloc.c ã‚’èª­ã‚€ (bins)](https://zenn.dev/anko/articles/malloc-each-bins)
- [malloc.c ã‚’èª­ã‚€ (arena)](https://zenn.dev/anko/articles/malloc-arena)

## ãŠãŠã–ã£ã±ãªç†è§£

ãƒ’ãƒ¼ãƒ—é ˜åŸŸã§ã¯ãƒãƒ£ãƒ³ã‚¯ã¨å‘¼ã°ã‚Œã‚‹æ§‹é€ ä½“ãŒå¤§é‡ã«ã‚ã‚Šã€ãã‚Œãã‚Œä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒãƒ£ãƒ³ã‚¯ã ã£ãŸã‚Šã€è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã ã£ãŸã‚Šã—ã¾ã™ã€‚`malloc` ã™ã‚‹ã¨è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®ä¸­ã‹ã‚‰ãƒãƒ£ãƒ³ã‚¯ãŒåˆ‡ã‚Šå‡ºã•ã‚Œã€ãã®ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãŒè¿”ã•ã‚Œã¾ã™ã€‚é€†ã« `free` ã™ã‚‹ã¨è§£æ”¾ã•ã‚ŒãŸæ—¨ã®ãƒ¡ã‚¿æƒ…å ±ã‚’ãƒãƒ£ãƒ³ã‚¯ã«æ›¸ãè¾¼ã¿ã€free list ã«ç¹‹ã’ã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ãƒãƒ£ãƒ³ã‚¯ã¯æ¬¡ã®ã‚ˆã†ãªæ§‹é€ ã¨ãªã£ã¦ã„ã¾ã™ã€‚

- ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã¯ 0x20 ãƒã‚¤ãƒˆä»¥ä¸Šã§ 0x10 ã®å€æ•°ã¨ãªã£ã¦ã„ã‚‹ã€‚
- ç¢ºä¿ã—ãŸãƒ‡ãƒ¼ã‚¿ã®ç›´å‰ã«ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãªã©ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒæ›¸ãè¾¼ã¾ã‚Œã¦ãŠã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®æœ«å°¾ 8 ãƒã‚¤ãƒˆã¯æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã¨è¢«ã£ã¦ã„ã‚‹ã€‚

![](/images/pwn/chunk.png =480x)

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å | èª¬æ˜ |
| :-: | --- |
| prev_size | ä¸€ã¤å‰ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã€‚PREV_INUSE ãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ãªã„ã¨ãã«æ›¸ãè¾¼ã¾ã‚Œã¦ã„ã‚‹ã€‚ |
| size | ã“ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã€‚ä¸‹ä½ 3bit ã¯ãƒ•ãƒ©ã‚°ã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹ã€‚ |
| NON_MAIN_ARENA | ãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã—ã¦ã„ã‚‹ã®ãŒ `main_arena` ã§ã‚ã‚‹ã‹ã©ã†ã‹ (ãƒ’ãƒ¼ãƒ—é ˜åŸŸã®ç®¡ç†éƒ¨ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã«å¿…è¦) |
| IS_MMAPED | ãƒ¡ãƒ¢ãƒªãŒ mmap ã§ç¢ºä¿ã•ã‚ŒãŸã‹ (free æ™‚ã® munmap ã§è§£æ”¾ã™ã‚‹ã‹ã®åˆ¤æ–­ã«å¿…è¦) |
| PREV_INUSE | å‰ã®ãƒãƒ£ãƒ³ã‚¯ãŒä½¿ç”¨ä¸­ã‹ã€‚ä½¿ç”¨ä¸­ã§ãªã‘ã‚Œã° prev_size ã«å‰ã®ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒæ›¸ãè¾¼ã¾ã‚Œã¦ã„ã‚‹ã€‚ |

ã¾ãŸ `free` ã™ã‚‹ã¨ãã«é«˜é€Ÿã«å‡¦ç†ã™ã‚‹ãŸã‚ã«è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®ä¸€è¦§ free list ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

ã“ã® free list ãŒ Heap Exploit ã®ä¸­ã§é‡è¦ãªã®ã§æ¬¡ã§ã¯ã“ã®æ§‹é€ ã¨å…·ä½“çš„ãªå‹•ä½œã‚’è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

## ãƒãƒ£ãƒ³ã‚¯ã®ç®¡ç†

free list ã®æ­£ä½“ã¯ bins ã¨å‘¼ã°ã‚Œã‚‹ãƒªã‚¹ãƒˆç¾¤ã§ã™ã€‚bins ã¯ã„ãã¤ã‹ã®ç¨®é¡ãŒã‚ã£ã¦ã‚µã‚¤ã‚ºã«ã‚ˆã£ã¦ç®¡ç†ã®ä»•æ–¹ã‚’å¤‰ãˆã‚‹ã“ã¨ã§æœ€é©åŒ–ã—ã¦ã„ã¾ã™ã€‚

| bins ã®ç¨®é¡ | ã‚µã‚¤ã‚º | èª¬æ˜ | ãƒ‡ãƒ¼ã‚¿æ§‹é€  |
| --- | --- | --- | --- |
| tcache bins | 0x20 ~ 0x410 | æœ€åˆã«å…¥ã‚Œã‚‰ã‚Œã‚‹ just-fit ãª bin | å˜æ–¹å‘ãƒªã‚¹ãƒˆ |
| fastbins | 0x20 ~ 0x80 | tcache ãŒæº€æ¯ã«ãªã£ãŸã‚‰å…¥ã‚Œã‚‰ã‚Œã‚‹ just-fit ãª bin | å˜æ–¹å‘ãƒªã‚¹ãƒˆ |
| unsortedbin | 0x20 ~ | æœ€è¿‘ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸãƒãƒ£ãƒ³ã‚¯ãŒå…¥ã‚Œã‚‰ã‚Œã‚‹ bin | åŒæ–¹å‘ãƒªã‚¹ãƒˆ |
| smallbins | 0x20 ~ 0x3f0 | unsortedbin ã‹ã‚‰æ¥ã‚‹å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ just-fit ãª bin | åŒæ–¹å‘ãƒªã‚¹ãƒˆ |
| largebins | 0x400 ~ | unsortedbin ã‹ã‚‰æ¥ã‚‹å¤§ããªãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ bin | åŒæ–¹å‘ãƒªã‚¹ãƒˆ + ã‚¹ã‚­ãƒƒãƒ—ãƒªã‚¹ãƒˆ |

ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ 2 ã¤ã‚ã‚Šã€ãã‚Œãã‚Œã®æŒ¿å…¥ (link) ã‚„å‰Šé™¤ (unlink) ã®å‡¦ç†ã¯ç†è§£ã—ã¦ã„ã‚‹å‰æã§è©±ã‚’é€²ã‚ã¾ã™ã€‚

- å˜æ–¹å‘ãƒªã‚¹ãƒˆã¯å˜æ–¹å‘ã«ã—ã‹ç§»å‹•ã§ããªã„ç¹‹ãå¤‰ãˆãŒç°¡å˜ãªé«˜é€Ÿãªãƒªã‚¹ãƒˆã§ã™ã€‚LIFO ã§å…ˆé ­ã¯ arena ã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒãƒ£ãƒ³ã‚¯ã®ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã®å…ˆé ­ 8 ãƒã‚¤ãƒˆã¯ forward pointer (fd) ã¨ã—ã¦ä½¿ã‚ã‚Œã€æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã®ãƒã‚¤ãƒ³ã‚¿ãƒ¼ãŒæ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚æœ«å°¾ã® fd ã¯ NULL ã«ãªã‚Šã¾ã™ã€‚
- åŒæ–¹å‘ãƒªã‚¹ãƒˆã¯åŒæ–¹å‘ç§»å‹•ã§ãã‚‹å††å½¢ã®ãƒªã‚¹ãƒˆã§ã™ã€‚FIFO ã§å…ˆé ­ã¨æœ«å°¾ã¯ arena ã§ç®¡ç†ã•ã‚Œã¦ã„ã¦ã€ãƒãƒ£ãƒ³ã‚¯ã®ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã®å…ˆé ­ 16 ãƒã‚¤ãƒˆã¯ forward pointer (fd), back pointer (bk) ã¨ã—ã¦ä½¿ã‚ã‚Œã¾ã™ã€‚


### tcache bins

glibc v2.26 ä»¥é™ã«è¿½åŠ ã•ã‚ŒãŸ binã€‚å‚ç…§å±€æ‰€æ€§ã‚’é«˜ã‚ã‚‹ç‚ºã« `malloc / free` ã§ä¸€ç•ªæœ€åˆã«å‡¦ç†ã•ã‚Œã‚‹ã®ãŒ tcache bins ã§ã™ã€‚tcache bins ã¯ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x20 ã‹ã‚‰ 0x410 ã¾ã§ã® 64 ç¨®é¡ã® tcache bin ã‚’æŒã¡ã€ãã‚Œãã‚Œå˜æ–¹å‘ãƒªã‚¹ãƒˆã¨ãªã£ã¦ã„ã¾ã™ã€‚ãƒªã‚¹ãƒˆã®é•·ã•ã¯ 7 å€‹ã«åˆ¶é™ã•ã‚Œã¦ã„ã¦ tcache ãŒæº€æ¯ã«ãªã‚‹ã¨ä»–ã® bins ã«ç§»ã•ã‚Œã¾ã™ã€‚ã‚µã‚¤ã‚ºã”ã¨ã«åˆ†ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ just-fit ã§è¿”ã›ã¾ã™ã€‚

![](/images/pwn/tcache.png =480x)

tcache bins ã®å®Ÿä½“ã¯ `tcache_perthread_struct` æ§‹é€ ä½“ã§ã™ã€‚ `entries` ã§å„ãƒªã‚¹ãƒˆã® HEAD ã®ãƒãƒ£ãƒ³ã‚¯ã«ç¹‹ã’ã¦ã€ `counts` ã§ãƒªã‚¹ãƒˆã®é•·ã•ã‚’ç®¡ç†ã—ã€7 å€‹ã«ãªã£ãŸã‚‰å—ã‘ä»˜ã‘ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚ãƒãƒ£ãƒ³ã‚¯ãŒ tcache bin ã«å…¥ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã« `tcache_entry` æ§‹é€ ä½“ãŒ overlap ã•ã‚Œã¦ãƒªã‚¹ãƒˆã«å…¥ã‚Šã¾ã™ã€‚

```c
typedef struct tcache_entry
{
  struct tcache_entry *next;              // æ¬¡ã® tcache_entry ã¸ã®ãƒã‚¤ãƒ³ã‚¿
  struct tcache_perthread_struct *key;    // ä¹±æ•°ã‚’ç”¨ã„ã¦ double free ã‚’æ¤œçŸ¥
} tcache_entry;

typedef struct tcache_perthread_struct
{
  uint16_t counts[TCACHE_MAX_BINS];       // å„ bin ã®é•·ã•ã®ä¸€è¦§
  tcache_entry *entries[TCACHE_MAX_BINS]; // å„ bin ã®æœ€åˆã® tcache ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã®ä¸€è¦§
} tcache_perthread_struct;
```


### fastbins

glibc v2.3 ã‹ã‚‰ã‚ã‚‹å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ binã€‚fastbins ã¯ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x20 ã‹ã‚‰ 0x80 ã¾ã§ 7 ç¨®é¡ã® fastbin ã‚’æŒã¡ã€å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã¯é »ç¹ã«ç¢ºä¿ãƒ»é–‹æ”¾ãŒèµ·ãã‚„ã™ã„ã®ã§ãã‚Œãã‚Œå˜æ–¹å‘ãƒªã‚¹ãƒˆã¨ãªã£ã¦ã„ã¾ã™ã€‚

![](/images/pwn/fastbin.png =480x)

```c
struct malloc_state
{
    ...
    int have_fastchunks;
    mfastbinptr fastbinsY[NFASTBINS];
    ...
};
```


### unsortedbin

tcache ã‚„ fastbins ã®ãŠã“ã¼ã‚Œã‚„ fastbins ã® consolidation ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã‚’ unsortedbin ãŒç®¡ç†ã—ã¾ã™ã€‚unsortedbin ã¯ 1 ã¤ã®åŒæ–¹å‘ãƒªã‚¹ãƒˆã¨ãªã£ã¦ã„ã¾ã™ã€‚unsortedbin ã§ã‚½ãƒ¼ãƒˆãŒèµ·ã“ã‚‹ã¨ smallbins ã‹ largebins ã«ç¹‹ãŒã‚Œã¾ã™ã€‚

![](/images/pwn/smallbin.png =480x)

unsortedbin ã®å…ˆé ­ãƒ»æœ«å°¾ã¯ `bin_at(1)` ã¤ã¾ã‚Š `arena` ã® `bins[0]` ã¨ `bins[1]` ã«æ ¼ç´ã•ã‚Œã€unsortedbin ã®æœ«å°¾ãƒãƒ£ãƒ³ã‚¯ã® `fd` ã¯ `main_arena.top` ã‚’æŒ‡ã—ã¾ã™ã€‚


### smallbins

unsortedbin ã«å…¥ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã§å°ã•ã„ãƒãƒ£ãƒ³ã‚¯ã¯ smallbins ã«ç¹‹ãŒã‚Œã¾ã™ã€‚smallbins ã¯ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x20 ã‹ã‚‰ 0x3f0 ã¾ã§ 62 ç¨®é¡ã® smallbin ã‚’æŒã¡ã€ãã‚Œãã‚ŒåŒæ–¹å‘ãƒªã‚¹ãƒˆã¨ãªã£ã¦ã„ã¾ã™ã€‚

![](/images/pwn/smallbin.png =480x)

smallbins ã®å…ˆé ­ãƒ»æœ«å°¾ã¯ `bin_at(2)` ã‹ã‚‰ `bin_at(63)` ã¾ã§ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚

```c
#define SMALLBIN_WIDTH    MALLOC_ALIGNMENT
#define SMALLBIN_CORRECTION (MALLOC_ALIGNMENT > CHUNK_HDR_SZ)

#define smallbin_index(sz) \
  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) >> 4) : (((unsigned) (sz)) >> 3))\
   + SMALLBIN_CORRECTION)
```

### largebins

å¤§ããªã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ã‚‚ 16 ãƒã‚¤ãƒˆã”ã¨ã«ç®¡ç†ã™ã‚‹ã®ã¯ç¾å®Ÿçš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚‹ã«ã¤ã‚Œã¦å¹…ã‚‚æŒ‡æ•°çš„ã«å¤§ããã™ã‚‹ã“ã¨ã§ãƒªã‚¹ãƒˆã®æ•°ã‚’å¹³å‡åŒ–ã—ã€æœ€æ‚ªè¨ˆç®—é‡ã‚’æ¸›ã‚‰ã™ã“ã¨ãŒã§ãã¾ã™ã€‚largebins ã¯ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x400 ~ 0x430, 0x440 ~ 0x470, â€¦, 0x1000000 ~ 0x1fffff0, 0x2000000 ~ ã® 63 ç¨®é¡ã® largebin ã‚’æŒã¡ã€ãã‚Œãã‚Œã‚µã‚¤ã‚ºã«å¿œã˜ã¦é †åºç«‹ã¦ãŸåŒæ–¹å‘ãƒªã‚¹ãƒˆã¨ãªã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯åŒæ–¹å‘ãƒªã‚¹ãƒˆã®ãƒ¡ãƒ³ãƒã«åŠ ãˆã¦ `fd_nextsize` `bk_nextsize` ãŒã‚ã‚Šã€ãã‚Œãã‚Œãƒãƒ£ãƒ³ã‚¯ã®å¹…ã®ä¸­ã§æ¬¡ã«å¤§ããªãƒãƒ£ãƒ³ã‚¯ã¨æ¬¡ã«å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãŒæ ¼ç´ã•ã‚Œã¾ã™ã€‚

![](/images/pwn/largebin.png =480x)

largebins ã®å…ˆé ­ãƒ»æœ«å°¾ã¯ `bin_at(64)` ã‹ã‚‰ `bin_at(126)` ã¾ã§ã«æ ¼ç´ã•ã‚Œã¾ã™ã€‚
largebins ã‹ã‚‰ç¢ºä¿ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªã¯ `last_remainder` ã¯ã‚»ãƒƒãƒˆã•ã‚Œã¾ã›ã‚“ã€‚

```c
#define largebin_index_64(sz)                                                \
  (((((unsigned long) (sz)) >> 6) <= 48) ?  48 + (((unsigned long) (sz)) >> 6) :\
   ((((unsigned long) (sz)) >> 9) <= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\
   ((((unsigned long) (sz)) >> 12) <= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\
   ((((unsigned long) (sz)) >> 15) <= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\
   ((((unsigned long) (sz)) >> 18) <= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\
   126)

#define largebin_index(sz) \
  (SIZE_SZ == 8 ? largebin_index_64 (sz)                                     \
   : MALLOC_ALIGNMENT == 16 ? largebin_index_32_big (sz)                     \
   : largebin_index_32 (sz))
```

## ã‚°ãƒ­ãƒ¼ãƒãƒ«é ˜åŸŸ
### main_arena

ã“ã‚Œã‚‰ã® bins ã¯ã‚¢ãƒªãƒ¼ãƒŠã¨ã„ã†æ©Ÿæ§‹ã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã¾ã™ã€‚ã‚¢ãƒªãƒ¼ãƒŠã¯å˜æ–¹å‘ãƒªã‚¹ãƒˆã§ã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã«å…ˆé ­ã‚’ `main_arena` ã¨ã„ã†å¤‰æ•°ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã‚¢ãƒªãƒ¼ãƒŠã¯ `malloc_state` æ§‹é€ ä½“ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

```c
struct malloc_state
{
  __libc_lock_define (, mutex);     // arena ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ serialize ã™ã‚‹
  int flags;                        // ãƒ’ãƒ¼ãƒ—ãƒ¡ãƒ¢ãƒªãŒé€£ç¶šã§ã‚ã‚‹ã‹

  int have_fastchunks;              // fastbins ãŒç©ºã§ã¯ãªã„ã“ã¨ã‚’è¡¨ã™çœŸå½å€¤
  mfastbinptr fastbinsY[NFASTBINS]; // fastbins

  mchunkptr top;                    // ãƒ’ãƒ¼ãƒ—é ˜åŸŸã®æœ€å¾Œã«ã‚ã‚‹æœªä½¿ç”¨ã®å¤§ããªãƒãƒ£ãƒ³ã‚¯
  mchunkptr last_remainder;         // åˆ†å‰²ã—ã¦ç¢ºä¿ã—ãŸéš›ã«ä½™ã£ãŸé ˜åŸŸã®æœ€æ–°ã®ãƒãƒ£ãƒ³ã‚¯

  mchunkptr bins[NBINS * 2 - 2];    // unsortedbin smallbins largebins ã®å…ˆé ­ãƒ»æœ«å°¾
  unsigned int binmap[BINMAPSIZE];  // ã“ã‚Œã‚‰ã‚’ç´ æ—©ãè¦‹ã¤ã‘ã‚‹ç‚ºã«ä½¿ã‚ã‚Œã‚‹ãƒ“ãƒƒãƒˆãƒ™ã‚¯ã‚¿

  struct malloc_state *next;        // arena ã®å˜æ–¹å‘ãƒªã‚¹ãƒˆ
  struct malloc_state *next_free;   // ä½¿ã‚ã‚Œã¦ã„ãªã„ arena ã®å˜æ–¹å‘ãƒªã‚¹ãƒˆ
  INTERNAL_SIZE_T attached_threads; // arena ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã®æ•°

  INTERNAL_SIZE_T system_mem;       // arena ã«ã‚ˆã£ã¦ç¾åœ¨ç¢ºä¿ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ¢ãƒªã®åˆè¨ˆå€¤
  INTERNAL_SIZE_T max_system_mem;   // system_mem ã®æœ€å¤§å€¤
};
```

### malloc hooks

glibc ã«ã¯ã„ãã¤ã‹ã® hook ãŒã‚ã‚Šã¾ã™ãŒ malloc é–¢é€£ã® hooks ã¯ Heap Exploit ã«ã¦éå¸¸ã«ã‚ˆãä½¿ã‚ã‚Œã¦ã„ã¾ã—ãŸã€‚

| é–¢æ•°å | æ¡ä»¶ |
| --- | --- |
| `__malloc_hook` | `malloc()` å‘¼ã³å‡ºã—æ™‚ |
| `__free_hook` | `free()` å‘¼ã³å‡ºã—æ™‚ |
| `__realloc_hook` | `realloc()` å‘¼ã³å‡ºã—æ™‚ |
| `__after_morecore_hook` | `malloc()` å‘¼ã³å‡ºã—æ™‚ |
| `__malloc_initialize_hook` | åˆæœŸ `malloc()` æ™‚ |
| `__memalign_hook` | `aligned_alloc()` `memalign()` `posix_memalign()` `valloc()` å‘¼ã³å‡ºã—æ™‚ |
| `_dl_open_hook` | å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ãƒ¼ãƒ‰æ™‚ |

ã—ã‹ã—ã“ã‚Œã‚‰ã® hooks ã¯ glibc v2.34 ä»¥é™ã§å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚

## ãƒ’ãƒ¼ãƒ—é ˜åŸŸã§ã®æ›¸ãæ›ãˆ

ãƒ’ãƒ¼ãƒ—é ˜åŸŸã«ãŠã„ã¦ã¯ `fd` `bk` ã®æ›¸ãæ›ãˆãŒç›®æ¨™ã§ã™ã€‚ã“ã‚ŒãŒã§ãã‚Œã° free list ã®ãƒªã‚¹ãƒˆæ§‹é€ ã‚’å£Šã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ malloc / free ã‚’ç¹°ã‚Šè¿”ã™ã¨ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸æ›¸ãæ›ãˆãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### Use After Free
free é–¢æ•°ãŒå‘¼ã°ã‚ŒãŸå¾Œã§ã‚‚èª­ã¿æ›¸ããŒå‡ºæ¥ã¦ã—ã¾ã†è„†å¼±æ€§ã€‚ã“ã‚ŒãŒä¸€ç•ªæ‰‹ã£å–ã‚Šæ—©ã `fd` `bk` ã®èª­ã¿æ›¸ããŒå‡ºæ¥ã¾ã™ã€‚

è§£æ”¾ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’ dangling pointer (ã¶ã‚‰ã•ãŒã£ãŸãƒã‚¤ãƒ³ã‚¿) ã¨è¨€ã„ã¾ã™ã€‚

### Heap based Buffer Overflow
Heap ä¸Šã§ã® BOF ã§ã™ã€‚è¤‡æ•°å› malloc ã™ã‚‹ã¨å‚ç…§å±…æ‰€æ€§ãªã©ã®ç†ç”±ã‹ã‚‰é€£ç¶šã«ä¸¦ã¶ã“ã¨ãŒå¤šã„ã§ã™ã€‚ãã†ã™ã‚‹ã¨ä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒãƒ£ãƒ³ã‚¯ã‹ã‚‰ BOF ã—ã¦åˆ¥ã®ãƒãƒ£ãƒ³ã‚¯ã®æ›¸ãæ›ãˆãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€å¤‰æ•°ã®æ›¸ãæ›ãˆã‚„ `fd` `bk` ã®æ›¸ãæ›ãˆãŒå‡ºæ¥ã¾ã™ã€‚

### double free

Use After Free ã‚„ HBOF ãŒå‡ºæ¥ãªãã¨ã‚‚ double free ã•ã›ã‚Œã°ãƒªã‚¹ãƒˆãŒãƒ«ãƒ¼ãƒ—ã™ã‚‹ã‹ã‚‰é©åˆ‡ã« malloc ã—ãŸé ˜åŸŸã§ã‚‚ fd ã«æ„å›³ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãè¾¼ã‚ã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

glibc 2.28 ä»¥å‰ã® tcache ã§ã¯ double free ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ãŒã€glibc 2.29 ä»¥é™ã§ã¯ `key` ã¨ã„ã† `tcache_perthread_struct` æ§‹é€ ä½“ã‚’æŒ‡ã™ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚Œã€double free æ¤œæŸ»ãŒå…¥ã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

## ãƒ’ãƒ¼ãƒ—é ˜åŸŸã§ã®æ”»æ’ƒæ–¹æ³•
ãƒ’ãƒ¼ãƒ—é ˜åŸŸã§ã¯å¤§é‡ã®æ”»æ’ƒæ‰‹æ³•ãŒè¦‹ã¤ã‹ã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ãã‚Œãã‚Œç‹¬è‡ªæ€§ãŒã‚ã‚‹ã‚‚ã®ã®å…±é€šã™ã‚‹éƒ¨åˆ†ãŒæ•°å¤šãã‚ã‚‹ã®ã§ã€ãã®æ‰‹æ³•ã‚’ç´°ã‹ãåˆ†ã‘ã‚Œã°ãƒ‘ã‚ºãƒ«ã®ã‚ˆã†ã«çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§å¤šãã®æ‰‹æ³•ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãƒ’ãƒ¼ãƒ—ã‚’å£Šã™ã“ã¨ã‚’ã²ãŸã™ã‚‰è€ƒãˆã¦ã¾ã¨ã‚ã¦ã¿ã¾ã—ã‚‡ã†ã€‚


| æ¡ä»¶ | å¯èƒ½ãªå‡¦ç† |
| --- | --- |
| æ•´åˆæ€§ã‚’æº€ãŸã—ãŸ `fd` `bk` ã®æ›¸ãæ›ãˆ | `free()` ã§ free list ã«å½ãƒãƒ£ãƒ³ã‚¯æŒ¿å…¥ã€‚2 å›ç›®ä»¥é™ã¯ `free()` å¤±æ•—ã™ã‚‹ |
| å½ãƒãƒ£ãƒ³ã‚¯ã®ç¢ºä¿ãƒ»æ›¸ãè¾¼ã¿ | ä»»æ„ã‚¢ãƒ‰ãƒ¬ã‚¹æ›¸ãè¾¼ã¿ |
| unsortedbin ã® `bk` ã®æ›¸ãæ›ãˆ | unlink æ™‚ã« `bk->fd = bk + 0x10` ã« `&main_arena.top` ãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹ (< 2.28) |
| unsortedbin ã® `fd` ã®èª­ã¿å–ã‚Š | `&main_arena.bins` ã§ libc leak |
| æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã® `PREV_INUSE` ã‚’ã‚¯ãƒªã‚¢<br> `fd` `bk` `prev_size` ã‚’æ›¸ãæ›ãˆ | `free()` ã® consolidation backward ã§ unsortedbin ã«å½ãƒãƒ£ãƒ³ã‚¯æŒ¿å…¥ |
| `global_max_fast` ã®æ›¸ãæ›ãˆ | `free()` ã§ fastbins ä»¥é™ã«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãè¾¼ã‚ã‚‹ |
| `main_arena` ã§ `NON_MAIN_ARENA` ã‚’ç«‹ã¦ã‚‹ | arena ã®ä½ç½®ã‚’ãšã‚‰ã—ã¦æ›¸ãè¾¼ã‚ã‚‹ |
| top chunk ã®ã‚µã‚¤ã‚ºä»¥ä¸Šã® `malloc()` | top chunk ãŒ `free()` ã•ã‚Œã‚‹ |
| `arena_key` ã‚’æ›¸ãæ›ãˆã‚‹ (< 2.4) | |

æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
| æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ | ãƒã‚¤ãƒ‘ã‚¹ |
| --- | --- |
| fastbins å…ˆé ­ã® double free æ¤œçŸ¥ | å…ˆé ­ã§ã¯ãªã„ |
| smallbins `victim.bk->fd == victim` | `fd` `bk` ã‚’è‡ªåˆ†è‡ªèº«ã«å‘ã‘ã‚‹ (2.27) |


### tcache poisoning

tcache ã«å…¥ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã® next ã‚’æ›¸ãæ›ãˆã¦ malloc ã™ã‚‹ã“ã¨ã§ AAW ã§ãã‚‹è„†å¼±æ€§ã€‚æ³¨æ„ã™ã‚‹ã¹ãã¯ tcache ãŒ LIFO ãªãƒªã‚¹ãƒˆãªç‚ºã« malloc free ã‚’ç¹°ã‚Šè¿”ã•ãªã‘ã‚Œã°ãªã‚‰ãªã„
tcache poisoning ã—ã¦ `__free_hook` ã‚’æ›¸ãæ›ãˆã‚‹ã€‚
åŒã˜é ˜åŸŸã«æ‚ªæ„ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºä¿ã—ã¦åˆ©ç”¨ã•ã›ã‚‹äº‹ã§ã€é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã‚’æ›¸ãæ›ãˆã‚‹ã€‚

[SECCON Beginners CTF 2020 [Beginners Heap] Writeup &åˆå¿ƒè€…å‘ã‘è§£èª¬ - Qiita](https://qiita.com/hanya1995/items/c29a89737bbd521e67f2)
[SECCON Beginners CTF 2019 - Babyheap - HackMD](https://hackmd.io/@Xornet/H1hYUUR2I)

### unsortedbin attack
fd ã« arena.bin ãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹ã€‚libc leak
< 2.29

- [Security Fest 2019 - Baby5 (Unsorted Bin) - HackMD](https://hackmd.io/@Xornet/rycqVwQpL)
- [næ—¥1CTFãƒãƒ£ãƒ¬ãƒ³ã‚¸ - HackMD](https://hackmd.io/@Xornet/BkemeSAhU)

### House of XXX ã‚·ãƒªãƒ¼ã‚º
House of XXX ã‚·ãƒªãƒ¼ã‚ºã¯ glibc malloc ã§ç™ºè¦‹ã•ã‚ŒãŸæ”»æ’ƒæ‰‹æ³•ã®ç·ç§°ã§ã™ã€‚2001 å¹´ã”ã‚ã‹ã‚‰ã‚ã‚‹ã‚‰ã—ã„ã§ã™ã€‚
House Of XXX ã‚·ãƒªãƒ¼ã‚ºã¯å¤§é‡ã«ã‚ã‚‹ã®ã§ã“ã“ã§ã¯ãƒªã‚¹ãƒˆå½¢å¼ã§ç´¹ä»‹ã—ã¾ã™ã€‚ã‚ã¨ã§ãã‚Œãã‚Œæ›¸ãèµ·ã“ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚
- https://dl.packetstormsecurity.net/papers/attack/MallocMaleficarum.txt
- https://www.slideshare.net/codeblue_jp/cb16-matsukuma-ja-68459648

| æ”»æ’ƒå | glibc | ã‚¢ã‚¤ãƒ‡ã‚¢ |
| --- | --- | --- |
| House of Prime | < 2.4 | 8 ãƒã‚¤ãƒˆãƒãƒ£ãƒ³ã‚¯ã‚’ `free()` ã—ã¦ `fastbinsY[-1] == max_fast` ã‚’æ›¸ãæ›ãˆã¦ã€ `fastbinsY[289] == arena_key` ã‚’æ›¸ãæ›ãˆã‚‹ |
| House of Corrosion | 2.26 < glibc < 2.30 | `global_max_fast` ã‚’æ›¸ãæ›ãˆ<br> `stderr` ã‚’æ”¹ã–ã‚“ã™ã‚‹ |
| House of Mind | < 2.11 | ãƒãƒ£ãƒ³ã‚¯ã® `NON_MAIN_ARENA` |
| House of Orange | < 2.26 | top chunk ã®ã‚µã‚¤ã‚ºã‚’ç¸®ã‚ã‚‹ `malloc()` ã‚’å‘¼ã¶ã¨ `sysmalloc()` ã§ `_int_free()` ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹  unsortedbin attack  `_IO_list_all` abort() ã™ã‚‹ã¨ _IO_flush_all_lockp() ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ |
| House of Einherjar | | PREV_INUSE ã®æ›¸ãæ›ãˆ unlink attack |

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹ã®ãƒã‚¤ãƒ‘ã‚¹
### tcache dup
tcache ã«ãŠã„ã¦ double-free æ¤œçŸ¥ãŒèµ·ãã‚‹ã€‚ fastbin ã§ double-free ã‚’èµ·ã“ã™ã“ã¨ã§ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã€‚

## glibc ã®ãƒ“ãƒ«ãƒ‰
ç‰¹å®šã® glibc ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã®æ”»æ’ƒã‚’è©¦ã—ãŸã„ã¨ãã«ãã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® glibc ã¨ãƒã‚¤ãƒŠãƒªã®ç´ä»˜ã‘ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

æ¬¡ã® URL ã§å¿…è¦ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® glibc ã®ã‚½ãƒ¼ã‚¹ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¨å‹•çš„ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (.so) ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚(ã“ã†ã™ã‚‹ã¨ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚‚ä»˜ã„ã¦ãã‚‹ã®ã§å¬‰ã—ã„)

- http://ftp.gnu.org/gnu/glibc/

```shell
mkdir build; cd build
../glibc-version/congifure --prefix=/path/to/build
make
make install
```

`ldd` ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã«ç´ä»˜ã„ã¦ã„ã‚‹å‹•çš„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ•™ãˆã¦ãã‚Œã¾ã™ã€‚
`pwninit` ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã¨å‹•çš„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åŒã˜éšå±¤ã«å…¥ã‚Œã¦ãŠã‘ã°ç´ä»˜ã‘ã¦ãã‚Œã¾ã™ã€‚

https://github.com/io12/pwninit

## ã¾ã¨ã‚
Heap Exploit ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚ä»Šå›ã¯ Linux ã®ã¿ã®ç´¹ä»‹ã«ãªã‚Šã¾ã—ãŸãŒ Microsoft ã® mimalloc ã¨ã‹ã‚‚ã‚ã‚Šã¾ã™ã€‚
https://qiita.com/methane/items/e88901b7392c10cee2c9

ã“ã‚ŒãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚Œã° pwn ä¸­ç´šè€…ã¨è¨€ãˆãã†ã§ã™ã€‚

## å‚è€ƒè³‡æ–™
- https://github.com/shellphish/how2heap
- [Overview of GLIBC heap exploitation techniques](https://0x434b.dev/overview-of-glibc-heap-exploitation-techniques/)
- [ã€LCR 1.1ã€‘LibcCodeReading: mallocç·¨[2]=fastbinsãƒ»smallbins - newbie dive into binary (hatenablog.com)](https://smallkirby.hatenablog.com/entry/2019/09/23/001554)
