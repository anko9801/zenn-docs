---
title: "【CTF 探訪記】Windows Exploits"
emoji: "😸"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["CTF", "pwn", "windows"]
published: false
---

pwn というのはメモリの書き換えや読み取りなどの低レイヤーの脆弱性を用いて意図しない動作を引き起こさせる競技で最もハッキングっぽい分野です。

- [Stack Exploits](https://zenn.dev/anko/articles/ctf-stack-exploits)
- [Heap Exploits](https://zenn.dev/anko/articles/ctf-heap-exploits)

ここまでで Linux において分かったので今回は Windows に対して攻撃してみようと思います。Windows には大量のセキュリティ機構があります。ここでは 64 ビットシステムの Windows Server を対象にします。バージョンに依存することは極力触れずふんわりとした理解を目指します。

## Windows の基本
pdata

- Heap
- Shareable
- Thread Stack
- Mapped File
- Image
- Private Data

Windows API (Win32 API)
https://learn.microsoft.com/en-us/

DLL内のAPIを呼び出すことで詳細を知ることなくリソースを知ることができる.

1. CreateFileA を呼び出す.
2. kernel32.dll / ntdll.dll から sysenter / syscall してカーネルへ渡す.
3. ntoskrnl.exe が実際にファイル作成する.


DLL =? イメージ
構造は Linux と同じです

インサイド Windows が参考書として良いらしいですが私は読んだことはありません。

## Windows Exploit の基本
OS は違えど基本的な構造は同じなので Linux と同じように攻撃できます。

- ROP
- シェルコード
- 攻撃者はリモートの DLL イメージを読み込むことにより任意の攻撃を実行します
  - ROP より悪意ある関数にリターンする方が楽

## プロセスの緩和策 (Mitigations)
Windows には Linux に比べて豊富なセキュリティ機構があります。

一般的な緩和策の設定は次の 4 つの方法があります。

- [Set-ProcessMitigationPolicy 関数](https://learn.microsoft.com/ja-jp/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessmitigationpolicy)
- [Set-ProcessMitigation コマンド](https://learn.microsoft.com/en-us/powershell/module/processmitigations/set-processmitigation)
- [リンカのオプション](https://learn.microsoft.com/ja-jp/cpp/build/reference/linker-options)
- 「Windows セキュリティ」→「セキュリティの概要」→「アプリとブラウザー コントロール」→「Exploit Protection の設定」

またプロセスごとに緩和策が施行されているかどうか確認する為には次のアプリケーションが使えます。

- [ProcessExplorer](https://learn.microsoft.com/ja-jp/sysinternals/downloads/process-explorer) (おすすめ)
- [pestudio](https://www.winitor.com/)
- Task Manager の Details

さてどのような緩和策があるのか覗いてみましょう。

### Address Space Layout Randomization
プロセスの仮想メモリはページ単位で物理メモリとのマッピングが行われます。

Address Space Layout Randomization (ASLR) とはスタックやヒープ、実行領域などのアドレスをランダム化する機構です。ASLR 有効 `/DYNAMICBASE` をバイパスするにはベースアドレスのリークが必要になります。

そして Bottom-up ASLR で VirtualAlloc などで作られたページもランダム化し、High Entropy ASLR `/HIGHENTROYVA` で 64-bit アドレスを最大限にランダム化、ASLR Disallow Stripped Image で ASLR 無効 `/FIXED` な DLL イメージを読み込み禁止とするという機構です。

https://msrc.microsoft.com/blog/2013/12/software-defense-mitigating-common-exploitation-techniques/

### Data Execution Prevention
Data Execution Prevention (DEP) とはスタック領域やヒープ領域のページに実行権限を渡さない機構、 Arbitary Code Guard (ACG) とは [VirtualAlloc](https://learn.microsoft.com/ja-jp/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) や [VirtualProtect](https://learn.microsoft.com/ja-jp/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) などで実行属性がついたページを作成することを禁止する機構です。

- [SetProcessDEPPolicy 関数](https://learn.microsoft.com/ja-jp/windows/win32/api/winbase/nf-winbase-setprocessdeppolicy)
- 「コントロールパネル」→「システム」→「システムの詳細設定」よりパフォーマンスの設定を開いて図 3.1 の画面で設定する方法。この画面では、BCD の nx オプションの値のうち、OptIn と OptOut に対応するような設定を行うことが可能。

### Structured Exception Handling Overwrite Protection
現在 64 ビットプロセスでは関係ない緩和策ですが一応紹介しておきます。

Structured Exception Handling (SEH) とは例外ハンドラの機構です。

Windows では `throw std::exception()` などで例外が送出されるとスレッド環境ブロック (TEB) の先頭にある `NT_TIB` 構造体の `ExceptionList` という例外ハンドラのリンクリストから 1 つずつ例外ハンドラを呼び出します。そこで例外処理が成功したら終了し、失敗したら次の例外ハンドラに進み、末尾にある ntdll.dll の FinalExceptionHandler まで繰り返します。

```c
struct NT_TIB {
  EXCEPTION_REGISTRATION_RECORD *ExceptionList;
  VOID *StackBase;
  VOID *StackLimit;
  VOID *SubSystemTib;
  union {
    VOID *FiberData;
    ULONG Version;
  };
  VOID *ArbitraryUserPointer;
  NT_TIB *Self;
}

struct EXCEPTION_REGISTRATION_RECORD {
  EXCEPTION_REGISTRATION_RECORD *Next;
  EXCEPTION_DISPOSITION *Handler;
}
```

そのリストの一部分がスタック上にあるので BOF を用いて Handler を書き換えることで ACE する SEH overwrite という攻撃手段がありました。

SafeSEH とはビルド時にあらかじめ例外ハンドラのアドレス一覧をバイナリファイルに埋め込んでおき、例外ハンドラ実行時に埋め込まれたアドレスと照合して一致しなければ実行されないという仕組みです。

これは [dumpbin コマンド](https://learn.microsoft.com/ja-jp/cpp/build/reference/dumpbin-reference) で確認できます。

```shell
> dumpbin /LOADCONFIG <exe file>
```

SafeSEH が検査するアドレスは SafeSEH が紐づいたイメージのアドレスとスタック領域上のアドレスだけで SafeSEH 無効な DLL のアドレスとヒープ領域上のアドレスは検査しません。なのでそれを例外ハンドラとすることで回避することができます。

Structured Exception Handling Overwrite Protection (SEHOP) とは SEH overwrite の緩和策で以下のことを保証します。

- すべてのレコードがスタック上にあり、align されていることを検査する。
- ハンドラがスタックを指していないことを検査する。
- リスト末尾が FinalExceptionHandler であるか検査する。

これよりこのバイパスには FinalExceptionHandler のアドレスのリークが必要になります。

### Control Flow Guard
Control Flow Guard は Control Flow Integrity (CFI) 技術の一つでバイナリに call 命令でホワイトリスト

vtable overwrite

CFG Export Suppression (from Windows 10)
GetProcAddress 関数などの通常の手段で取得していない dll の export 関数のアドレスを call すると強制終了する


Stack Pivot 対策 重要な関数が呼び出された際、スタックを指しているかをチェックする
重要な関数には call 命令によって呼び出されたか確認する Caller Check という機構 ROP 対策
SimExec 重要な関数が呼び出された後の命令群をシミュレート実行して ROP されていないかチェックする

Return Flow Guard という Shadow Stack のソフトウェア実装があったのですが race condition によってバイパスできるなどの要因で不採用となりました。CPU の CFI に依存するようです。

### Image Isolation
No Remote Images とは UNC パス (ex. `\\222.222.222.222\share\`) や WebDAV パスのライブラリのロードを禁止する機構

No Low IL Images (from Windows vista) 低い Integrity Level (IL) を持つイメージをロード禁止する

Disable Extension Points
プロセスが拡張ポイントの読み込みを無効にするというものです。
1 例を挙げます。それは Windows フック DLL という拡張ポイントです。SetWindowsHookEx という Windows API があります。この API は DLL に存在するフック関数をグローバルフックに追加することができます。グローバルフックに追加された関数は、全てのスレッドにセットされます。そして、SetWindowsHookEx を呼び出した際に指定したイベントタイプのメッセージがどこかのスレッドに送られてきた場合、そのプロセス内でフックされて実行されます。

Microsoft-Signed Binaries Only とは Microsoft の CA によって電子証明された DLL のみをロードする。

### Address Filter
Export Address Table (EAT) / Import Address Table (IAT) とは export / import する関数のアドレスを保持するテーブルです。

DLL のバージョンが異なるとベースアドレスからのオフセットも異なる為、シェルコードから EAT / IAT を読み取ることでより安定した攻撃ができます。

Export Address Filter (EAF) / Import Address Filter (IAF) とは .text 領域以外から特定の DLL (kernel32.dll, ntdll.dll, kernelbase.dll) の EAT / IAF の読み取りを制限する機構です。

| 緩和策 | 説明 |
| --- | --- |
| Disable Child Process Creation | 子プロセスを作成するのを禁止する |
| Disable Non System Fonts | `${SYSTEMROOT}\Fonts` ディレクトリにインストールされた後にユーザのログオン時に Winlogon によって未登録の任意のファイルが読み込まれるのを防ぐという、信頼されていないフォントをブロックする機能*1。 |
- Prefer-System32-Images
  - DLL の探索順序を利用して悪意のある DLL をプロセスに読み込ませることを防止するため、ローダーの検索パスを変更し特定の DLL の読み込みを常に${SYSTEM_ROOT}\System32 フォルダ内で検索する機能*2。
- Heap-Terminate-On-Corruption
  - ヒープが破損した場合にプロセスを強制終了することによって、ヒープ破損の例外ハンドラを悪用する攻撃や時々ヒープの破損を起こす程度の Exploit を防御するという、ヒープの整合性を検証する機能*3。HeapSetInformation 関数
- Filter-Win32k-System-Calls
  - Win32k.sys
- Raise-Exception-on-Invalid-Handle

## ツール
プロセスのメモリ

- [x64dbg](https://x64dbg.com/)
- [WinDbg](https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debugger-download-tools)
  - User Kernel どちらもデバッグできる

https://github.com/pinksawtooth/how_to_become_a_malware_analyst

## ヒープ

## まとめ

## 参考文献
- [Customize Exploit Protection](https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/customize-exploit-protection)
- [SEH オーバーライトの防御機能とその Exploit 可能性](https://www.ffri.jp/assets/files/research/research_papers/SEH_Overwrite.pdf)
- [Windowsのセキュリティ新機能 Control Flow Guardについて](https://www.ffri.jp/assets/files/monthly_research/MR201412_Control_Flow_Guard_JPN.pdf)
- [Exploit Protection のリファレンス](https://learn.microsoft.com/ja-jp/microsoft-365/security/defender-endpoint/exploit-protection-reference)