---
title: "ã€CTF æ¢è¨ªè¨˜ã€‘Windows Exploits"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CTF", "pwn", "windows"]
published: false
---

pwn ã¨ã„ã†ã®ã¯ãƒ¡ãƒ¢ãƒªã®æ›¸ãæ›ãˆã‚„èª­ã¿å–ã‚Šãªã©ã®ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è„†å¼±æ€§ã‚’ç”¨ã„ã¦æ„å›³ã—ãªã„å‹•ä½œã‚’å¼•ãèµ·ã“ã•ã›ã‚‹ç«¶æŠ€ã§æœ€ã‚‚ãƒãƒƒã‚­ãƒ³ã‚°ã£ã½ã„åˆ†é‡ã§ã™ã€‚

- [Stack Exploits](https://zenn.dev/anko/articles/ctf-stack-exploits)
- [Heap Exploits](https://zenn.dev/anko/articles/ctf-heap-exploits)

ä»Šå›ã¯ Windows ã® DEP, ASLR, CFG, ACG, CET ãªã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®ç·©å’Œç­–ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã€ä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã‚’ç›®æŒ‡ã—ã¾ã™ã€‚
Windows Kernel Driver ã®è„†å¼±æ€§ã‚’ç”¨ã„ã¦ kASLR, NX, SMEP, SMAP, kCFG, HVCI ãªã©ã®ã‚«ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã®ç·©å’Œç­–ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ã¯

## Windows ã®åŸºæœ¬
Windows OS ã®æ­´å²

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç™ºå£²æ—¥ | èª¬æ˜ |
| --- | --- | --- |
| Windows 1.x | 1985/11/20 |
| Windows 2.x | 1987/12/9 |
| Windows 3.x | 1990/5/22 |
| Windows NT | 1993/7/27 | Graphics Device (GDI) |
| Windows 95 | 1995/8/24 |
| Windows 98 | 1998/6/25 |
| Windows 2000 | 1999/12/15 | 9xç³» NTç³»ã®è„†å¼±æ€§ã¯æ·±åˆ»ãªç¤¾ä¼šå•é¡Œ |
| Windows XP | 2001/8/24 | Service Pack2 (SP2) ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”¹è‰¯ |
| Windows Vista | 2006/11/30 | |
| Windows 7 | 2009/9/1 |
| Windows 8 | 2012/8/16 |
| Windows 10 | 2015/7/29 | EMET ã‚µãƒãƒ¼ãƒˆçµ‚äº† Exploit Protection é–‹å§‹ |
| Windows 11 | 2021/10/5 |

Service Pack

Windows ã¯æ¬¡ã®ã‚ˆã†ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ãªã£ã¦ã„ã¾ã™ã€‚

![](/images/pwn/windows.png)

ä¾‹ãˆã°ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰ Windows API ã‚’ç”¨ã„ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã¿ã‚‹ã¨æ¬¡ã®ã‚ˆã†ãªå‡¦ç†ãŒèµ°ã‚Šã¾ã™ã€‚

1. ãƒ—ãƒ­ã‚»ã‚¹ãŒ fileapi.h ã® [CreateFileA é–¢æ•°](https://learn.microsoft.com/ja-jp/windows/win32/api/fileapi/nf-fileapi-createfilea) ã‚’å‘¼ã³å‡ºã™ã€‚
2. Kernel32.dll ã® [NtCreateFile é–¢æ•°](https://learn.microsoft.com/ja-jp/windows/win32/api/winternl/nf-winternl-ntcreatefile) ã‚’å‘¼ã³å‡ºã™ã€‚
3. Ntdll.dll ã§ sysenter / syscall ã—ã¦ã‚«ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã¸ç§»è¡Œã™ã‚‹ã€‚
4. Ntoskrnl.exe ã® System Service Dispatch Table (SSDT) ã§ I/O Manager ã® NtCreateFile é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã€‚
5. Driver.sys ã§ I/O ã‚’å®Ÿè¡Œã—ã¦ Handle ã‚’è¿”ã™ã€‚

Windows ã§ã¯ Handle ã¨ã„ã†è­˜åˆ¥å­ã§ãƒ—ãƒ­ã‚»ã‚¹ã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰±ã„ã¾ã™ã€‚
ã¾ãŸã‚«ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã§æœªå‡¦ç†ã®ä¾‹å¤–ãŒç™ºç”Ÿã—ãŸã‚‰ã‚·ã‚¹ãƒ†ãƒ ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã€ãƒ–ãƒ«ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ (BSOD) ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒ¡ãƒ¢ãƒªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯æ¬¡ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã™ã€‚è©³ã—ãã¯ [PE å½¢å¼](https://learn.microsoft.com/ja-jp/windows/win32/debug/pe-format)ã€[Peering Inside the PE: A Tour of the Win32 Portable Executable File Format](https://learn.microsoft.com/en-us/previous-versions/ms809762(v=msdn.10)) ãªã©ã‚’å‚ç…§ã€‚

![](/images/pwn/windows_process.png)

ãƒšãƒ¼ã‚¸ã®ä¿è­·å±æ€§ã¯ Read, Write, Execute, Guard ã® 4 ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚ã‚¹ã‚¿ãƒƒã‚¯ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã«ã‚ã‚Šã€ç¾åœ¨å®Ÿè¡Œä¸­ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚¹ã‚¿ãƒƒã‚¯ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦ã€ãã®ä»–ã®ã‚¹ã‚¿ãƒƒã‚¯ã¯ Guard å±æ€§ãŒä»˜ã‘ã‚‰ã‚Œã¾ã™ã€‚Guard ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ STATUS_GUARD_PAGE_VIOLATION ã¨ã„ã†ä¾‹å¤–ãŒé€å‡ºã•ã‚Œã¾ã™ã€‚

## ãƒ„ãƒ¼ãƒ«
Windows å†…éƒ¨ã‚’è§£æã™ã‚‹ä¸Šã§ä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚


| ã‚¢ãƒ—ãƒª | èª¬æ˜ |
| --- | --- |
| [Visual Studio](https://visualstudio.microsoft.com/ja/vs/) | ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã¨ãƒ“ãƒ«ãƒ‰ç’°å¢ƒã‚’å‚™ãˆãŸ IDE |
| [Sysinternals](https://learn.microsoft.com/ja-jp/sysinternals/) | Windows ã‹ã‚‰æä¾›ã•ã‚Œã¦ã„ã‚‹ãƒ„ãƒ¼ãƒ«ç¾¤ |
| Process Explorer | é«˜æ©Ÿèƒ½ãªã‚¿ã‚¹ã‚¯ãƒãƒãƒ¼ã‚¸ãƒ£ |
| VMMap | ãƒ—ãƒ­ã‚»ã‚¹å†…ã®ä»®æƒ³ãƒ¡ãƒ¢ãƒªã¨ç‰©ç†ãƒ¡ãƒ¢ãƒªã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ |
| [pestudio](https://www.winitor.com/) | |
| [WinDbg](https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debugger-download-tools) | Windows ã®ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãªãƒ‡ãƒãƒƒã‚¬ |
| [Microsoft Learn](https://learn.microsoft.com/en-us/) | Windows é–¢é€£ã®æƒ…å ±ã®æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ |
| [Terminus Project](http://terminus.rewolf.pl/terminus/) | Windows Internals ã®æ§‹é€ ä½“ã®å›³è§£ |
| [Windows Driver Kit](https://learn.microsoft.com/ja-jp/windows-hardware/drivers/download-the-wdk) | |
| [Metasploit](https://www.metasploit.com/) | |

ã¾ãŸæ¬¡ã®ã‚ˆã†ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã€Windows ã¨ã¯é•ã„ OSS ãªã®ã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯å‚è€ƒã«ãªã‚Šã¾ã™ã€‚

| ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ | èª¬æ˜ |
| --- | --- |
| ReactOS | Windows äº’æ›ã® OS ã‚’ç›®æŒ‡ã—ã¦ã„ã‚‹ OSS ([ReactOS ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://doxygen.reactos.org/)) |
| Wine | Linux ä¸Šã® Windows API ã®ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ (Windows ã®ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§ã¯ãªã„) |

## Windows Exploit ã®åŸºæœ¬
OS ã¯é•ãˆã©åŸºæœ¬çš„ãªæ§‹é€ ã¯åŒã˜ãªã®ã§ Linux ã¨åŒã˜ã‚ˆã†ã«æ”»æ’ƒã§ãã¾ã™ã€‚

- ROP
- shellcode
- vtable overwrite

ã“ã‚Œä»¥å¤–ã«ã‚‚

- DLL Injection

Windows ã® PoC ã§ã¯æœ€çµ‚çš„ã«é›»å“ (calc.exe) ã‚’èµ·å‹•ã™ã‚‹ã“ã¨ãŒã‚ˆãã‚ã‚‹ã‚‰ã—ã„ã§ã™ã€‚

https://www.ired.team/
https://inaz2.hatenablog.com/entry/2015/07/26/175115

### DLL leak
Linux ã§ã® libc leak ã«æ¯”ã¹ DLL ã®é–¢æ•°ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒªãƒ¼ã‚¯ã¯è‹¥å¹²æ‰‹é–“ãŒæ›ã‹ã‚Šã¾ã™ã€‚ã“ã“ã§ã¯æ¬¡ã® 2 ã¤ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

- LoadLibrary é–¢æ•° / GetProcAddress é–¢æ•°ã‚’å‘¼ã¶
- TEB ã‚’æ­©ã

1 ã¤ç›®ã¯ç°¡å˜ãªæ–¹æ³•ã§ 2 ã¤ã®é–¢æ•°ã‚’å‘¼ã¶ã ã‘ã§ã™ã€‚

1. `kernel32!LoadLibrary / ntdll!LdrLoadDll` ã§ DLL ã® Handle ã‚’å¾—ã‚‹
2. `kernel32!GetProcAddress / ntdll!LdrGetProcedureAddress` ã§é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¾—ã‚‹

ãã‚‚ãã‚‚ã“ã‚Œã‚‰ã®é–¢æ•°ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒãƒªãƒ¼ã‚¯å‡ºæ¥ã¦ãªã„ã¨ãƒªãƒ¼ã‚¯ã§ãã¾ã›ã‚“ã€‚

2 ã¤ç›®ã¯ã‚ˆã‚Šæ±ç”¨çš„ãªæ–¹æ³•ã§ Thread Environment Block (TEB) ã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã§ã™ã€‚

1. TEB ã‹ã‚‰ DLL ã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¾—ã‚‹ (ASLR ã®ãƒã‚¤ãƒ‘ã‚¹)
2. DLL ä¸­ã® EAT / IAT ã‹ã‚‰é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¾—ã‚‹ (ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¾å­˜æ€§ã‹ã‚‰ã®è„±å´)

TEB ã¯ GS ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

Export Address Table (EAT) / Import Address Table (IAT) ã¨ã¯ Export / Import ã™ã‚‹é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿æŒã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ã€‚

DLL ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚‹ã¨ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚‚ç•°ãªã‚Šã¾ã™ãŒã€EAT / IAT ã‹ã‚‰èª­ã¿å–ã‚Œã°ã©ã‚“ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚‚æ”»æ’ƒã§ãã€å®‰å®šã—ã¾ã™ã€‚

https://learn.microsoft.com/en-us/previous-versions/ms809762(v=msdn.10)

Import Address Tableã¯DataDirectoryé…åˆ—ã®1ç•ªç›®ã®ã‚¨ãƒ³ãƒˆãƒª

IMAGE_DOS + IMAGE_DOS_HEADER.e_lfanew = EAT
IMAGE_NT_HEADERS64 pNTHeader

| å‹ | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‹ | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å |
| --- | --- | --- |
| [TEB](https://learn.microsoft.com/ja-jp/windows/win32/api/winternl/ns-winternl-teb) | PPEB | ProcessEnvironmentBlock |
| [PEB](https://learn.microsoft.com/ja-jp/windows/win32/api/winternl/ns-winternl-peb) | PPEB_LDR_DATA | Ldr |
| [PEB_LDR_DATA](https://learn.microsoft.com/ja-jp/windows/win32/api/winternl/ns-winternl-peb_ldr_data) | LIST_ENTRY | InMemoryOrderModuleList |
| [LDR_DATA_TABLE_ENTRY](https://learn.microsoft.com/ja-jp/windows/win32/api/winternl/ns-winternl-peb_ldr_data) | PVOID | DllBase |
| [IMAGE_NT_HEADERS64](https://learn.microsoft.com/ja-jp/windows/win32/api/winnt/ns-winnt-image_nt_headers64) | IMAGE_OPTIONAL_HEADER32 | OptionalHeader |
| [IMAGE_OPTIONAL_HEADER64](https://learn.microsoft.com/ja-jp/windows/win32/api/winnt/ns-winnt-image_optional_header64) | IMAGE_DATA_DIRECTORY | DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES] EAT IAT |
| [IMAGE_DATA_DIRECTORY](https://learn.microsoft.com/ja-jp/windows/win32/api/winnt/ns-winnt-image_data_directory) | DWORD | VirtualAddress |
| IMAGE_EXPORT_DIRECTORY | ULONG | AddressOfFunctions, AddressOfNames, AddressOfNameOrdinals |
| IMAGE_IMPORT_DESCRIPTOR | | |

æ¬¡ã®é–¢æ•°ã‚’ç”¨ã„ã¦ DLL ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

### DLL Injection
DLL ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦æœ¬æ¥ã¨ã¯é•ã†å‹•ä½œã‚’ã•ã›ã‚‹æ”»æ’ƒã§ã™ã€‚

ãƒ—ãƒ­ã‚»ã‚¹ã‚’éš è”½ã™ã‚‹ç‚ºã«ä½¿ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

## ãƒ—ãƒ­ã‚»ã‚¹ã®ç·©å’Œç­– (Mitigations)
Windows ã«ã¯ Linux ã«æ¯”ã¹ã¦è±Šå¯Œãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹ãŒã‚ã‚Šã¾ã™ã€‚

ä¸€èˆ¬çš„ãªç·©å’Œç­–ã®è¨­å®šã¯æ¬¡ã® 4 ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

- [Set-ProcessMitigationPolicy é–¢æ•°](https://learn.microsoft.com/ja-jp/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessmitigationpolicy)
- [Set-ProcessMitigation ã‚³ãƒãƒ³ãƒ‰](https://learn.microsoft.com/en-us/powershell/module/processmitigations/set-processmitigation)
- [ãƒªãƒ³ã‚«ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³](https://learn.microsoft.com/ja-jp/cpp/build/reference/linker-options)
- ã€ŒWindows ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€â†’ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®æ¦‚è¦ã€â†’ã€Œã‚¢ãƒ—ãƒªã¨ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã€â†’ã€ŒExploit Protection ã®è¨­å®šã€

ã•ã¦ã©ã®ã‚ˆã†ãªç·©å’Œç­–ãŒã‚ã‚‹ã®ã‹è¦—ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### Address Space Layout Randomization
ãƒ—ãƒ­ã‚»ã‚¹ã®ä»®æƒ³ãƒ¡ãƒ¢ãƒªã¯ãƒšãƒ¼ã‚¸å˜ä½ã§ç‰©ç†ãƒ¡ãƒ¢ãƒªã¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãŒè¡Œã‚ã‚Œã¾ã™ã€‚Address Space Layout Randomization (ASLR) ã¯ä»®æƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã™ã‚‹æ©Ÿæ§‹ã§ã™ã€‚

Linux ã¨ã¯é•ã„ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚„ãƒ’ãƒ¼ãƒ—ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ãªã©ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã—ã¾ã™ã€‚ã“ã‚Œã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã«ã¯ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒªãƒ¼ã‚¯ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ãã—ã¦ Bottom-up ASLR ã§ VirtualAlloc é–¢æ•°ãªã©ã§ä½œã‚‰ã‚ŒãŸãƒšãƒ¼ã‚¸ã‚‚ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã—ã€ High Entropy ASLR ã§ 64-bit ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æœ€å¤§é™ã«ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã€ASLR Disallow Stripped Image ã§ ASLR ç„¡åŠ¹ãª DLL ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ç¦æ­¢ã¨ã—ã¾ã™ã€‚

ãƒªãƒ³ã‚¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³

- ASLR æœ‰åŠ¹ `/DYNAMICBASE`
- ASLR ç„¡åŠ¹ `/FIXED`
- High Entropy ASLR `/HIGHENTROYVA`

### Data Execution Prevention
Data Execution Prevention (DEP) ã¨ã¯ã‚¹ã‚¿ãƒƒã‚¯ã‚„ãƒ’ãƒ¼ãƒ—ã®ãƒšãƒ¼ã‚¸ã«å®Ÿè¡Œå±æ€§ã‚’ä»˜ã‘ãªã„æ©Ÿæ§‹ã€Arbitary Code Guard (ACG) ã¨ã¯ [VirtualAlloc é–¢æ•°](https://learn.microsoft.com/ja-jp/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) ã‚„ [VirtualProtect é–¢æ•°](https://learn.microsoft.com/ja-jp/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) ãªã©ã§å®Ÿè¡Œå±æ€§ãŒã¤ã„ãŸãƒšãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’ç¦æ­¢ã™ã‚‹æ©Ÿæ§‹ã§ã™ã€‚

DEP, ACG ã«ã‚ˆã‚Šã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡ŒãŒé›£ã—ããªã‚‹ã®ã§ ROP ã§ãƒã‚¤ãƒ‘ã‚¹ã—ã¾ã™ã€‚

### Structured Exception Handling Overwrite Protection
ç¾åœ¨ 64 ãƒ“ãƒƒãƒˆãƒ—ãƒ­ã‚»ã‚¹ã§ã¯é–¢ä¿‚ãªã„ç·©å’Œç­–ã§ã™ãŒä¸€å¿œç´¹ä»‹ã—ã¦ãŠãã¾ã™ã€‚

ä¾‹å¤–ã¯å‘½ä»¤ã‚’å®Ÿè¡Œã—ãŸã¨ãã«ãƒ—ãƒ­ã‚»ãƒƒã‚µã«ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ç™ºç”Ÿã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã§ã™ã€‚ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹ã¨ã‚«ãƒ¼ãƒãƒ«ãŒã‚­ãƒ£ãƒƒãƒã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã® Structured Exception Handling (SEH) ã¨ã„ã†ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã®æ©Ÿæ§‹ã«æ¸¡ã—ã¾ã™ã€‚

Thread Environment Block (TEB) ã®å…ˆé ­ã«ã‚ã‚‹ `NT_TIB` æ§‹é€ ä½“ã® `ExceptionList` ã¨ã„ã†ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã®ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã‹ã‚‰ 1 ã¤ãšã¤ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ãã“ã§ä¾‹å¤–å‡¦ç†ãŒæˆåŠŸã—ãŸã‚‰çµ‚äº†ã—ã€å¤±æ•—ã—ãŸã‚‰æ¬¡ã®ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã«é€²ã¿ã€æœ«å°¾ã«ã‚ã‚‹ ntdll.dll ã® FinalExceptionHandler ã¾ã§ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚ã“ã®æ©Ÿæ§‹ã‚’ SEH ã¨è¨€ã„ã¾ã™ã€‚

```c
struct NT_TIB {
  EXCEPTION_REGISTRATION_RECORD *ExceptionList;
  VOID *StackBase;
  VOID *StackLimit;
  VOID *SubSystemTib;
  union {
    VOID *FiberData;
    ULONG Version;
  };
  VOID *ArbitraryUserPointer;
  NT_TIB *Self;
}

struct EXCEPTION_REGISTRATION_RECORD {
  EXCEPTION_REGISTRATION_RECORD *Next;
  EXCEPTION_DISPOSITION *Handler;
}
```

ãã®ãƒªã‚¹ãƒˆã®ä¸€éƒ¨åˆ†ãŒã‚¹ã‚¿ãƒƒã‚¯ä¸Šã«ã‚ã‚‹ã®ã§ BOF ã‚’ç”¨ã„ã¦ Handler ã‚’æ›¸ãæ›ãˆã¦ä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡ŒãŒã§ãã‚‹ SEH overwrite ã¨ã„ã†æ”»æ’ƒæ‰‹æ®µãŒã‚ã‚Šã¾ã—ãŸã€‚

SafeSEH ã¨ã¯ãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚ã‚‰ã‹ã˜ã‚ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ä¸€è¦§ã‚’ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã«åŸ‹ã‚è¾¼ã‚“ã§ãŠãã€ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©å®Ÿè¡Œæ™‚ã«åŸ‹ã‚è¾¼ã¾ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ç…§åˆã—ã¦ä¸€è‡´ã—ãªã‘ã‚Œã°å®Ÿè¡Œã•ã‚Œãªã„ã¨ã„ã†ä»•çµ„ã¿ã§ã™ã€‚ãŸã ã—æ¤œæŸ»ã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ SafeSEH ãŒç´ã¥ã„ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã‚¹ã‚¿ãƒƒã‚¯é ˜åŸŸä¸Šã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ã§ã™ã€‚ãªã®ã§ SafeSEH ç„¡åŠ¹ãª DLL ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ’ãƒ¼ãƒ—é ˜åŸŸä¸Šã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã¨ã™ã‚Œã°ãƒã‚¤ãƒ‘ã‚¹ã§ãã¾ã™ã€‚

Structured Exception Handling Overwrite Protection (SEHOP) ã¨ã¯ SEH overwrite ã®ç·©å’Œç­–ã§ä»¥ä¸‹ã®ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

- ã™ã¹ã¦ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚¹ã‚¿ãƒƒã‚¯ä¸Šã«ã‚ã‚Šã€align ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ¤œæŸ»ã™ã‚‹ã€‚
- ãƒãƒ³ãƒ‰ãƒ©ãŒã‚¹ã‚¿ãƒƒã‚¯ã‚’æŒ‡ã—ã¦ã„ãªã„ã“ã¨ã‚’æ¤œæŸ»ã™ã‚‹ã€‚
- ãƒªã‚¹ãƒˆæœ«å°¾ãŒ FinalExceptionHandler ã§ã‚ã‚‹ã‹æ¤œæŸ»ã™ã‚‹ã€‚

ã“ã‚Œã‚ˆã‚Š SEHOP ã®ãƒã‚¤ãƒ‘ã‚¹ã«ã¯ FinalExceptionHandler ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒªãƒ¼ã‚¯ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã¯ [dumpbin ã‚³ãƒãƒ³ãƒ‰](https://learn.microsoft.com/ja-jp/cpp/build/reference/dumpbin-reference) ã§ç¢ºèªã§ãã¾ã™ã€‚

```shell
> dumpbin /LOADCONFIG <exe file>
```

### Control Flow Guard
æœ€è¿‘ã¯ ROP ã•ãˆã‚‚é˜²ã Control Flow Integrity (CFI) æŠ€è¡“ã¨ã„ã†ã‚‚ã®ãŒç™ºé”ã—ã¦ã„ã¦ã€Windows ã§ã¯æ¬¡ã® 3 ã¤ã® CFI ãŒæ–½è¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚

- Control Flow Guard (CFG)
- CFG Export Suppression
- CallerCheck / SimExec

Control Flow Guard ã¯ call å‘½ä»¤ã®ç›´å‰ã« Guard Control Flow Function Table ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹æ¤œæŸ»ã™ã‚‹å‡¦ç†ã‚’åŠ ãˆã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Š vtable overwrite ãªã©ã®å®Ÿè¡Œã‚¢ãƒ‰ãƒ¬ã‚¹æ›¸ãæ›ãˆã‚’é˜²ãã¾ã™ã€‚

ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã§å¤§ããª ROP ã‚’çµ„ã‚ãªã„ã¨ãã«åˆ¥ã®å ´æ‰€ã«é£›ã°ã—ã¦ãã“ã§çµ„ã‚€ã¨ã„ã† Stack Pivot ã¨ã„ã†æ”»æ’ƒæ‰‹æ³•ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«å¯¾ã—ã¦é‡è¦ãªé–¢æ•°ã®å‘¼ã³å‡ºã—æ™‚ã«ã‚¹ã‚¿ãƒƒã‚¯ã‚’æŒ‡ã—ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã„ã†ç·©å’Œç­–ãŒã‚ã‚Šã¾ã™ã€‚

é€šå¸¸ ret å‘½ä»¤ã§æˆ»ã£ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç›´å‰ã«ã¯ call å‘½ä»¤ãŒã‚ã‚Šã¾ã™ãŒ ROP ã® Gadget ã¯ãã†ã§ã¯ãªã„ã¨ã„ã†ç™ºæƒ³ã®å…ƒã€CallerCheck / SimExec ã¯é‡è¦ãªé–¢æ•°ã® ret å‘½ä»¤ / é‡è¦ãªé–¢æ•°ã®ç›´å¾Œ 20 å‘½ä»¤å…ˆã¾ã§ã® ret å‘½ä»¤ã‚’æ¤œæŸ»ã—ã¾ã™ã€‚ã“ã®ãƒã‚¤ãƒ‘ã‚¹ã«ã¯ call å‘½ä»¤ã® Gadget (ä¾‹ãˆã° `call eax; ret`) ã® ret å‘½ä»¤ã‚’ 19 å›å‘¼ã‚“ã å¾Œã« call å‘½ä»¤ã‚’å‘¼ã¹ã°ã‚ˆã„ã§ã™ã€‚

ã•ã‚‰ã« Windows 10 ã‹ã‚‰ CFG Export Suppression ã¨ã„ã† DLL ã® export é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã® call, jmp å‘½ä»¤ã®ç›´å‰ã«æ­£è¦ã®æ‰‹æ®µã§å¾—ãŸã‹æ¤œæŸ»ã™ã‚‹å‡¦ç†ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹æ©Ÿæ§‹ãŒåŠ ã‚ã‚Šã¾ã—ãŸã€‚

- GetProcAddress é–¢æ•°
- é™çš„ãƒªãƒ³ã‚¯ (IAT ãªã©)
- dll å†…ã§å¾—ã‚‹

GetProcAddress é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒªãƒ¼ã‚¯ã•ãˆã‚‚é˜²ãŒã‚Œã‚‹ç‚ºã€exploit ã¯ã‹ãªã‚Šé›£ã—ããªã‚Šã¾ã™ã€‚

Return Flow Guard ã¨ã„ã† Shadow Stack ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢å®Ÿè£…ãŒã‚ã£ãŸã®ã§ã™ãŒ race condition ã«ã‚ˆã£ã¦ãƒã‚¤ãƒ‘ã‚¹ã§ãã‚‹ãªã©ã®è¦å› ã§ä¸æ¡ç”¨ã¨ãªã‚Šã¾ã—ãŸã€‚

### Image Isolation
æ”»æ’ƒè€…ã¯ãƒªãƒ¢ãƒ¼ãƒˆã® DLL ã‚„äº‹å‰ã«ä»•è¾¼ã‚“ã æ‚ªæ„ã®ã‚ã‚‹ DLL ã‚’èª­ã¿è¾¼ã¾ã›ã‚‹ã“ã¨ã§æ¥½ã«æ‚ªæ„ã®ã‚ã‚‹é–¢æ•°ã‚’å‘¼ã³å‡ºã›ã¾ã™ã€‚ã“ã‚Œã«å¯¾ã—ã¦ DLL ã®èª­ã¿è¾¼ã¿ã‚’åˆ¶é™ã™ã‚‹ç·©å’Œç­–ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚

| ç·©å’Œç­– | èª¬æ˜ |
| --- | --- |
| Block Remote Images | UNC ãƒ‘ã‚¹ã‚„ WebDAV ãƒ‘ã‚¹ã® DLL ã‚’ç¦æ­¢ |
| Block Low Integrity Images | ä½ã„ Integrity Level (IL) ã‚’æŒã¤ DLL ã‚’ç¦æ­¢ |
| Microsoft-Signed Binaries Only | Windows Hardware Quality Labs ã® CA ã«ã‚ˆã£ã¦é›»å­è¨¼æ˜ã•ã‚Œã¦ã„ãªã„ DLL ã‚’ç¦æ­¢ |
| Store-Signed Binaries Only | Microsoft Store ã® CA ã«ã‚ˆã£ã¦é›»å­è¨¼æ˜ã•ã‚Œã¦ã„ãªã„ DLL ã‚’ç¦æ­¢ |
| Prefer System32 Images | `${SYSTEM_ROOT}\System32` ã® DLL ã‚’å…ˆã«æ¢ç´¢ã™ã‚‹ |

ã“ã‚Œã‚‰ã®ãƒã‚¤ãƒ‘ã‚¹ã¯ã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ...

SetWindowsHookEx é–¢æ•°ã§ DLL ã®é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ãƒƒã‚¯ã«è¿½åŠ ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã™ã‚‹ã“ã¨ã§å®Ÿè¡Œã•ã‚Œ DLL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒæˆåŠŸã—ã¾ã™ã€‚Disable Extension Points ã¨ã¯ ãƒ—ãƒ­ã‚»ã‚¹ãŒæ‹¡å¼µãƒã‚¤ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã‚’ç„¡åŠ¹ã«ã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚

### Address Filter
Export Address Filter (EAF) / Import Address Filter (IAF) ã¨ã¯ .text é ˜åŸŸä»¥å¤–ã‹ã‚‰ç‰¹å®šã® DLL (kernel32.dll, ntdll.dll, kernelbase.dll) ã® EAT / IAT ã®èª­ã¿å–ã‚Šã‚’åˆ¶é™ã™ã‚‹æ©Ÿæ§‹ã§ã™ã€‚

ã“ã®ãƒã‚¤ãƒ‘ã‚¹ã«ã¯ ROP ã‚’ç”¨ã„ã¦å¦¥å½“ãªã‚³ãƒ¼ãƒ‰é ˜åŸŸã‹ã‚‰ EAT ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚Œã°ã‚ˆã„ã§ã™ã€‚

NtContinue ã‚’å‘¼ã¶ã“ã¨ã§ã€EAF ãŒåˆ©ç”¨ã—ã¦ã„ã‚‹ãƒ‡ãƒãƒƒã‚°ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹

### ãã®ä»–

| ç·©å’Œç­– | èª¬æ˜ |
| --- | --- |
| Disable Child Process Creation | å­ãƒ—ãƒ­ã‚»ã‚¹ã‚’ä½œæˆã™ã‚‹ã®ã‚’ç¦æ­¢ã™ã‚‹ |
| Disable Fsctl SystemCalls | |
| Validate handle usage | |
| Validate image dependency integrity | |
| Block Untrusted Fonts | Graphics Device Interface (GDI) ã®ãƒ•ã‚©ãƒ³ãƒˆè§£æã«ã‚ˆã‚‹ç‰¹æ¨©æ˜‡æ ¼ `%windir%\Fonts` ä»¥å¤–ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ã—ãªã„ |

## Kernel Exploit
æ¨©é™æ˜‡æ ¼ã‚’

Kenrel ã®æƒ…å ±ã‚’ NtQuerySystemInformation ã§ãƒªãƒ¼ã‚¯ã§ãã¾ã™ã€‚
NonPagedPool ã‚’å®Ÿè¡Œå¯èƒ½ã§ Kenrel mode ã‹ã‚‰å®Ÿè¡Œã™ã‚‹
Execute User-mode memory from Kernel-mode
- Window Function running in kernel mode
- Overwrite HalDispatchTable function table with user-mode address

Disable Win32k system calls (Windows 8)
Win32k.sys ã®å‘¼ã³å‡ºã—ã‚’ç¦æ­¢ã™ã‚‹

## ãƒ’ãƒ¼ãƒ—é ˜åŸŸ

| Shareable | ãƒ—ãƒ­ã‚»ã‚¹é–“é€šä¿¡ãªã©ã«ã‚ˆã‚Šãƒ—ãƒ­ã‚»ã‚¹é–“ã§å…±æœ‰å¯èƒ½ãªãƒ¡ãƒ¢ãƒªã€‚ |
| Private Data | ãƒ—ãƒ­ã‚»ã‚¹ã®ä»®æƒ³ãƒ¡ãƒ¢ãƒªã‹ã‚‰å‰²ã‚Šå½“ã¦ã‚‹ VirtualAlloc å…±æœ‰ä¸å¯èƒ½ãªãƒ¡ãƒ¢ãƒªé ˜åŸŸã€‚ |

C / C++ ã® malloc / new ã§

ãƒ’ãƒ¼ãƒ—ã‹ã‚‰ã®ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦

HeapCreate
HeapAlloc
HeapFree

ä»®æƒ³ãƒ¡ãƒ¢ãƒªã®ç›´æ¥ã®å‰²ã‚Šå½“ã¦

VirtualAlloc
VirtualAllocEx

| Allocation Size | Granularity | Bucket |
| --- | --- | --- |
| 1 ~ 1,024 bytes (0x1 ~ 0x400) | 16 bytes | 1 ~ 64 |
| 1,025 ~ 2,048 bytes (0x401 ~ 0x800) | 64 bytes | 65 ~ 80 |
| 2,049 ~ 4,096 bytes (0x801 ~ 0x1000) | 128 bytes | 81 ~ 96 |
| 4,097 ~ 8,192 bytes (0x1001 ~ 0x2000) | 256 bytes | 97 ~ 112 |
| 8,193 ~ 16,368 bytes (0x2001 ~ 0x3FF0) | 512 bytes | 113 ~ 128 |

ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦ã® API
CoTaskMemAlloc
GlobalAlloc
HeapAlloc
LocalAlloc
malloc
new
VirtualAlloc

Heap Terminate On Corruption
ãƒ’ãƒ¼ãƒ—ãŒç ´æã—ãŸå ´åˆã«ãƒ—ãƒ­ã‚»ã‚¹ã‚’å¼·åˆ¶çµ‚äº†ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ãƒ’ãƒ¼ãƒ—ç ´æã®ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã‚’æ‚ªç”¨ã™ã‚‹æ”»æ’ƒã‚„æ™‚ã€…ãƒ’ãƒ¼ãƒ—ã®ç ´æã‚’èµ·ã“ã™ç¨‹åº¦ã® Exploit ã‚’é˜²å¾¡ã™ã‚‹ã¨ã„ã†ã€ãƒ’ãƒ¼ãƒ—ã®æ•´åˆæ€§ã‚’æ¤œè¨¼ã™ã‚‹æ©Ÿèƒ½*3ã€‚HeapSetInformation é–¢æ•°

## ã¾ã¨ã‚

https://github.com/pinksawtooth/how_to_become_a_malware_analyst

## å‚è€ƒæ–‡çŒ®
- ã‚¤ãƒ³ã‚µã‚¤ãƒ‰ Windows
- Windows ã‚«ãƒ¼ãƒãƒ«ãƒ‰ãƒ©ã‚¤ãƒãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°
- [Customize Exploit Protection](https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/customize-exploit-protection)
- [SEH ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒˆã®é˜²å¾¡æ©Ÿèƒ½ã¨ãã® Exploit å¯èƒ½æ€§](https://www.ffri.jp/assets/files/research/research_papers/SEH_Overwrite.pdf)
- [Windowsã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ–°æ©Ÿèƒ½ Control Flow Guardã«ã¤ã„ã¦](https://www.ffri.jp/assets/files/monthly_research/MR201412_Control_Flow_Guard_JPN.pdf)
- [Exploit Protection ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://learn.microsoft.com/ja-jp/microsoft-365/security/defender-endpoint/exploit-protection-reference)
- [è„†å¼±æ€§ç·©å’ŒæŠ€è¡“ã®æœ€å‰ç·š](https://www.ffri.jp/assets/files/research/research_papers/recent_advances_vuln_mitig_jp.pdf)
- [Heap Exploitã®ã“ã‚Œã¾ã§ã¨ç¾çŠ¶](https://www.ffri.jp/assets/files/monthly_research/MR201312_History%20and%20Current%20State%20of%20Heap%20Exploit_JPN.pdf)
- https://msrc.microsoft.com/blog/2013/12/software-defense-mitigating-common-exploitation-techniques/