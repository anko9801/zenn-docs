---
title: "ã€CTF æ¢è¨ªè¨˜ã€‘Windows Exploits"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CTF", "pwn", "windows"]
published: false
---

pwn ã¨ã„ã†ã®ã¯ãƒ¡ãƒ¢ãƒªã®æ›¸ãæ›ãˆã‚„èª­ã¿å–ã‚Šãªã©ã®ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è„†å¼±æ€§ã‚’ç”¨ã„ã¦æ„å›³ã—ãªã„å‹•ä½œã‚’å¼•ãèµ·ã“ã•ã›ã‚‹ç«¶æŠ€ã§æœ€ã‚‚ãƒãƒƒã‚­ãƒ³ã‚°ã£ã½ã„åˆ†é‡ã§ã™ã€‚

- [Stack Exploits](https://zenn.dev/anko/articles/ctf-stack-exploits)
- [Heap Exploits](https://zenn.dev/anko/articles/ctf-heap-exploits)

ä»Šå›ã¯ Windows ã® DEP, ASLR, CFG, ACG, CET ãªã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®ç·©å’Œç­–ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã€ä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

ãŸã  Microsoft ãŒ DLL ã®ãƒ‡ãƒãƒƒã‚°ã‚·ãƒ³ãƒœãƒ«ã‚’å¤§é‡ã«æ¶ˆã—ã¦ã—ã¾ã£ãŸç‚ºã€æœ€è¿‘ã®ãƒªãƒãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã¯å›°é›£ã‚’æ¥µã‚ã¦ã„ã¦è‰¯ã„æƒ…å ±ã‚’æä¾›ã™ã‚‹ã®ãŒé›£ã—ããªã£ã¦ã„ã¾ã™ã€‚è¨˜äº‹ã«èª¤ã‚ŠãŒã‚ã‚Œã°ä¸€å ±ãŠé¡˜ã„ã—ã¾ã™ã€‚

## Windows ã®åŸºæœ¬
Windows ã¯æ¬¡ã®ã‚ˆã†ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ãªã£ã¦ã„ã¾ã™ã€‚

![](/images/pwn/windows.png)

ä¾‹ãˆã°ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰ Windows API ã‚’ç”¨ã„ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã¿ã‚‹ã¨æ¬¡ã®ã‚ˆã†ãªå‡¦ç†ãŒèµ°ã‚Šã¾ã™ã€‚

1. ãƒ—ãƒ­ã‚»ã‚¹ãŒ fileapi.h ã® [CreateFileA é–¢æ•°](https://learn.microsoft.com/ja-jp/windows/win32/api/fileapi/nf-fileapi-createfilea) ã‚’å‘¼ã³å‡ºã™ã€‚
2. Kernel32.dll ã® [NtCreateFile é–¢æ•°](https://learn.microsoft.com/ja-jp/windows/win32/api/winternl/nf-winternl-ntcreatefile) ã‚’å‘¼ã³å‡ºã™ã€‚
3. Ntdll.dll ã§ sysenter / syscall ã—ã¦ã‚«ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã¸ç§»è¡Œã™ã‚‹ã€‚
4. Ntoskrnl.exe ã® System Service Dispatch Table (SSDT) ã§ I/O Manager ã® NtCreateFile é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã€‚
5. Driver.sys ã§ I/O ã‚’å®Ÿè¡Œã—ã¦ Handle ã‚’è¿”ã™ã€‚

Windows ã§ã¯ Handle ã¨ã„ã†è­˜åˆ¥å­ã§ãƒ—ãƒ­ã‚»ã‚¹ã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰±ã„ã¾ã™ã€‚
ã¾ãŸã‚«ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã§æœªå‡¦ç†ã®ä¾‹å¤–ãŒç™ºç”Ÿã—ãŸã‚‰ã‚·ã‚¹ãƒ†ãƒ ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã€ãƒ–ãƒ«ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ (BSOD) ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒ¡ãƒ¢ãƒªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯æ¬¡ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã™ã€‚è©³ã—ãã¯ [PE å½¢å¼](https://learn.microsoft.com/ja-jp/windows/win32/debug/pe-format)ã€[Peering Inside the PE: A Tour of the Win32 Portable Executable File Format](https://learn.microsoft.com/en-us/previous-versions/ms809762(v=msdn.10)) ãªã©ã‚’å‚ç…§ã€‚

![](/images/pwn/windows_process.png)

ãƒšãƒ¼ã‚¸ã®ä¿è­·å±æ€§ã¯ Read, Write, Execute, Guard ã® 4 ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚ã‚¹ã‚¿ãƒƒã‚¯ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã«ã‚ã‚Šã€ç¾åœ¨å®Ÿè¡Œä¸­ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚¹ã‚¿ãƒƒã‚¯ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦ã€ãã®ä»–ã®ã‚¹ã‚¿ãƒƒã‚¯ã¯ Guard å±æ€§ãŒä»˜ã‘ã‚‰ã‚Œã¾ã™ã€‚Guard å±æ€§ã®ã¤ã„ãŸãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ STATUS_GUARD_PAGE_VIOLATION ã¨ã„ã†ä¾‹å¤–ãŒé€å‡ºã•ã‚Œã¾ã™ã€‚

## ãƒ„ãƒ¼ãƒ«
Windows Exploit ã™ã‚‹ä¸Šã§éå¸¸ã«ä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«ãŸã¡ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

| ã‚¢ãƒ—ãƒª | èª¬æ˜ |
| --- | --- |
| [Visual Studio](https://visualstudio.microsoft.com/ja/vs/) | ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã¨ãƒ“ãƒ«ãƒ‰ç’°å¢ƒã‚’å‚™ãˆãŸ IDE |
| [Sysinternals](https://learn.microsoft.com/ja-jp/sysinternals/) | Windows ã‹ã‚‰æä¾›ã•ã‚Œã¦ã„ã‚‹ãƒ„ãƒ¼ãƒ«ç¾¤ |
| Process Explorer | Sysinternals ã®ãƒ—ãƒ­ã‚»ã‚¹ã®ç‰¹æ¨©ã‚„ç·©å’Œç­–ãªã©ã®æƒ…å ±ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ |
| VMMap | Sysinternals ã®ãƒ—ãƒ­ã‚»ã‚¹å†…ã®ä»®æƒ³ãƒ¡ãƒ¢ãƒªã¨ç‰©ç†ãƒ¡ãƒ¢ãƒªã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ |
| [pestudio](https://www.winitor.com/) | |
| [WinDbg](https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debugger-download-tools) | Windows ã®ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãªãƒ‡ãƒãƒƒã‚¬ |
| [Microsoft Learn](https://learn.microsoft.com/en-us/) | Windows é–¢é€£ã®æƒ…å ±ã®æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ |
| [Undocumented Functions](http://undocumented.ntinternals.net/) | Windows å…¬å¼ãŒæä¾›ã—ã¦ã„ãªã„é–¢æ•°ãƒ»æ§‹é€ ä½“ã‚’ã¾ã¨ã‚ãŸã‚µã‚¤ãƒˆ |
| [Terminus Project](http://terminus.rewolf.pl/terminus/) | Windows Internals ã®æ§‹é€ ä½“ã®å›³è§£ |
| [Windows Driver Kit](https://learn.microsoft.com/ja-jp/windows-hardware/drivers/download-the-wdk) | |
| [Metasploit](https://www.metasploit.com/) | |
| [dumpbin ã‚³ãƒãƒ³ãƒ‰](https://learn.microsoft.com/ja-jp/cpp/build/reference/dumpbin-reference) | PE å½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹é€ ã‚’ãƒ€ãƒ³ãƒ—ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ |

ã¾ãŸæ¬¡ã®ã‚ˆã†ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã€Windows ã¨ã¯é•ã„ OSS ãªã®ã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯å‚è€ƒã«ãªã‚Šã¾ã™ã€‚

| ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ | èª¬æ˜ |
| --- | --- |
| ReactOS | Windows äº’æ›ã® OS ã‚’ç›®æŒ‡ã—ã¦ã„ã‚‹ OSS ([ReactOS ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://doxygen.reactos.org/)) |
| Wine | Linux ä¸Šã® Windows API ã®ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ (Windows ã®ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§ã¯ãªã„) |

## Windows Exploit ã®åŸºæœ¬
OS ã¯é•ãˆã©åŸºæœ¬çš„ãªæ§‹é€ ã¯åŒã˜ãªã®ã§ Linux ã¨åŒã˜ã‚ˆã†ã«æ”»æ’ƒã§ãã¾ã™ã€‚

- Buffer Overflow
- Format String Bug
- Return Oriented Programming
- shellcode
- vtable overwrite
- SEH overwrite

ãŸã  Windows ã® exploit code ã¯å¤§ãããªã‚ŠãŒã¡ãªã®ã§æ¥µåŠ›ã€ŒROP < shellcode < DLL ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦æ‚ªæ„ã®ã‚ã‚‹é–¢æ•°ã‚’å‘¼ã¶ã€ã®é †ã«æ”»æ’ƒã—ãŸã„ã¨ã„ã†æ°—æŒã¡ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œã«åŠ ãˆ DLL ã«é–¢ã—ã¦ Windows ç‹¬è‡ªã®æ”»æ’ƒæ‰‹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

- DLL leak
- DLL Injection

### ã¨ã‚Šã‚ãˆãšæ”»æ’ƒ
Windows ã® PoC ã§ã¯æœ€çµ‚çš„ã«é›»å“ (calc.exe) ã‚’èµ·å‹•ã™ã‚‹ã“ã¨ãŒã‚ˆãã‚ã‚‹ã®ã§ãã‚Œã«å‰‡ã£ã¦ shellcode ã§é›»å“ã‚’èµ·å‹•ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### DLL leak
ROP ã‚„ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã§ DLL ã®é–¢æ•°ã‚’å‘¼ã¶ã«ã¯ãã®é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ãã‚Œã‚’å¾—ã‚‹æ–¹æ³•ã«ã¤ã„ã¦æ­£å¼ãªåç§°ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã®ã§ DLL leak ã¨å‘¼ã¶ã“ã¨ã«ã—ã¾ã™ã€‚ã“ã“ã§ã¯æ¬¡ã® 2 ã¤ã® DLL leak ã®æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

- LoadLibrary é–¢æ•° / GetProcAddress é–¢æ•°ã‚’å‘¼ã¶
- TEB ã‚’æ­©ã„ã¦è¦‹ã¤ã‘ã‚‹

1 ã¤ç›®ã¯ç°¡å˜ãªæ–¹æ³•ã§ 2 ã¤ã®é–¢æ•°ã‚’å‘¼ã¶ã ã‘ã§ã™ã€‚

1. `kernel32!LoadLibrary / ntdll!LdrLoadDll` ã§ DLL ã‚’ãƒ­ãƒ¼ãƒ‰ã— Handle ã‚’å¾—ã‚‹
2. `kernel32!GetProcAddress / ntdll!LdrGetProcedureAddress` ã§é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¾—ã‚‹

ãã‚‚ãã‚‚ã“ã‚Œã‚‰ã®é–¢æ•°ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒãƒªãƒ¼ã‚¯å‡ºæ¥ã¦ãªã„ã¨ãƒªãƒ¼ã‚¯ã§ãã¾ã›ã‚“ã€‚

2 ã¤ç›®ã¯ã‚ˆã‚Šæ±ç”¨çš„ãªæ–¹æ³•ã§ Thread Environment Block (TEB) ã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã§ã™ã€‚

1. TEB ã‹ã‚‰ DLL ã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¾—ã‚‹ (ASLR ã®ãƒã‚¤ãƒ‘ã‚¹)
2. DLL ä¸­ã® EAT / IAT ã‹ã‚‰é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¾—ã‚‹ (ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¾å­˜æ€§ã‹ã‚‰ã®è„±å´)

Export Address Table (EAT) / Import Address Table (IAT) ã¨ã¯ Export / Import ã™ã‚‹é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿æŒã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ã€‚DLL ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚‹ã¨ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚‚ç•°ãªã‚Šã¾ã™ãŒã€EAT / IAT ã‹ã‚‰èª­ã¿å–ã‚Œã°ã©ã‚“ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚‚æ”»æ’ƒã§ãã€å®‰å®šã—ã¾ã™ã€‚ã“ã“ã‚‰ã¸ã‚“ã®å…¨ä½“åƒã¯æ¬¡ã®è¨˜äº‹ã‚’èª­ã‚€ã®ãŒè‰¯ã„ã§ã™ã€‚

https://learn.microsoft.com/en-us/previous-versions/ms809762(v=msdn.10)

GS ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹ TEB æ§‹é€ ä½“ã‹ã‚‰æ¬¡ã®ã‚ˆã†ã«ã—ã¦ DLL ã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

| å‹ | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‹ | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å |
| --- | --- | --- |
| [TEB](https://learn.microsoft.com/ja-jp/windows/win32/api/winternl/ns-winternl-teb) | PPEB | ProcessEnvironmentBlock |
| [PEB](https://learn.microsoft.com/ja-jp/windows/win32/api/winternl/ns-winternl-peb) | PPEB_LDR_DATA | Ldr |
| [PEB_LDR_DATA](https://learn.microsoft.com/ja-jp/windows/win32/api/winternl/ns-winternl-peb_ldr_data) | LIST_ENTRY | InMemoryOrderModuleList |
| [LDR_DATA_TABLE_ENTRY](https://learn.microsoft.com/ja-jp/windows/win32/api/winternl/ns-winternl-peb_ldr_data) | PVOID | DllBase |

ãã—ã¦ DLL ã®å…ˆé ­ã«ã‚ã‚‹ãƒ˜ãƒƒãƒ€ã‹ã‚‰ DataDirectory[0] ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå…ˆã« EAT (IMAGE_EXPORT_DIRECTORY) ãŒã‚ã‚Šã¾ã™ã€‚

| å‹ | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‹ | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å |
| --- | --- | --- |
| IMAGE_DOS_HEADER | LONG | e_lfanew |
| [IMAGE_NT_HEADERS64](https://learn.microsoft.com/ja-jp/windows/win32/api/winnt/ns-winnt-image_nt_headers64) | IMAGE_OPTIONAL_HEADER32 | OptionalHeader |
| [IMAGE_OPTIONAL_HEADER64](https://learn.microsoft.com/ja-jp/windows/win32/api/winnt/ns-winnt-image_optional_header64) | IMAGE_DATA_DIRECTORY | DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES] |
| [IMAGE_DATA_DIRECTORY](https://learn.microsoft.com/ja-jp/windows/win32/api/winnt/ns-winnt-image_data_directory) | DWORD | VirtualAddress |
| IMAGE_EXPORT_DIRECTORY | PDWORD * | AddressOfFunctions, AddressOfNames, AddressOfNameOrdinals |

1. AddressOfNames ã‹ã‚‰é–¢æ•°ã®åå‰ã¨ä¸€è‡´ã™ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹ã€‚
2. AddressOfNameOrdinals ã¯ AddressOfNames ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰ AddressOfFunctions ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ‰‹ã«å…¥ã‚‹ã€‚
3. AddressOfFunctions ã® 2 ã§å¾—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚ã‚‹ã€‚

:::message
**æ¼”ç¿’å•é¡Œ**
é©å½“ãªå®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’èµ·å‹•ã—ã¦ WinDbg ã§ Kernel32.dll ã® GetProcAddress ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚
:::

### DLL Injection
DLL ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦æœ¬æ¥ã¨ã¯é•ã†å‹•ä½œã‚’ã•ã›ã‚‹æ”»æ’ƒã§ã™ã€‚

- [CreateRemoteThread é–¢æ•°](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread)
- APC
- SetWindowsHookEx é–¢æ•°
- IAT

DLL ã®é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ãƒƒã‚¯ã«è¿½åŠ ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã™ã‚‹ã“ã¨ã§å®Ÿè¡Œã•ã‚Œ DLL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒæˆåŠŸã—ã¾ã™ã€‚Disable Extension Points ã¨ã¯ ãƒ—ãƒ­ã‚»ã‚¹ãŒæ‹¡å¼µãƒã‚¤ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã‚’ç„¡åŠ¹ã«ã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚

ãƒ—ãƒ­ã‚»ã‚¹ã‚’éš è”½ã™ã‚‹ç‚ºã«ä½¿ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

## ãƒ—ãƒ­ã‚»ã‚¹ã®ç·©å’Œç­– (Mitigations)
Windows ã«ã¯ Linux ã«æ¯”ã¹ã¦è±Šå¯Œãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œã‚‰ã®ç·©å’Œç­–ã¨ãã®ãƒã‚¤ãƒ‘ã‚¹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚

### ç·©å’Œç­–ã®è¨­å®šæ–¹æ³•
ä¸€èˆ¬çš„ãªç·©å’Œç­–ã®è¨­å®šã¯æ¬¡ã® 4 ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

- [Set-ProcessMitigationPolicy é–¢æ•°](https://learn.microsoft.com/ja-jp/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessmitigationpolicy)
- [Set-ProcessMitigation ã‚³ãƒãƒ³ãƒ‰](https://learn.microsoft.com/en-us/powershell/module/processmitigations/set-processmitigation)
- [ãƒªãƒ³ã‚«ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³](https://learn.microsoft.com/ja-jp/cpp/build/reference/linker-options)
- ã€ŒWindows ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€â†’ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®æ¦‚è¦ã€â†’ã€Œã‚¢ãƒ—ãƒªã¨ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã€â†’ã€ŒExploit Protection ã®è¨­å®šã€

### Address Space Layout Randomization
ãƒ—ãƒ­ã‚»ã‚¹ã®ä»®æƒ³ãƒ¡ãƒ¢ãƒªã¯ãƒšãƒ¼ã‚¸å˜ä½ã§ç‰©ç†ãƒ¡ãƒ¢ãƒªã¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãŒè¡Œã‚ã‚Œã¾ã™ã€‚Address Space Layout Randomization (ASLR) ã¨ã¯ãƒãƒƒãƒ”ãƒ³ã‚°ä»®æƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã™ã‚‹æ©Ÿæ§‹ã§ã™ã€‚

Linux ã¨ã¯é•ã„ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚„ãƒ’ãƒ¼ãƒ—ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ãªã©ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã—ã¾ã™ã€‚ã“ã‚Œã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã«ã¯ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒªãƒ¼ã‚¯ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ãã—ã¦ Bottom-up ASLR ã§ VirtualAlloc é–¢æ•°ãªã©ã§ä½œã‚‰ã‚ŒãŸãƒšãƒ¼ã‚¸ã‚‚ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã—ã€ High Entropy ASLR ã§ 64-bit ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æœ€å¤§é™ã«ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã€ASLR Disallow Stripped Image ã§ ASLR ç„¡åŠ¹ãª DLL ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ç¦æ­¢ã¨ã—ã¾ã™ã€‚

ãƒªãƒ³ã‚¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³

- ASLR æœ‰åŠ¹ `/DYNAMICBASE`
- ASLR ç„¡åŠ¹ `/FIXED`
- High Entropy ASLR `/HIGHENTROYVA`

### Data Execution Prevention
Data Execution Prevention (DEP) ã¨ã¯ã‚¹ã‚¿ãƒƒã‚¯ã‚„ãƒ’ãƒ¼ãƒ—ã®ãƒšãƒ¼ã‚¸ã«å®Ÿè¡Œå±æ€§ã‚’ä»˜ã‘ãªã„æ©Ÿæ§‹ã€Arbitary Code Guard (ACG) ã¨ã¯ [VirtualAlloc é–¢æ•°](https://learn.microsoft.com/ja-jp/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) ã‚„ [VirtualProtect é–¢æ•°](https://learn.microsoft.com/ja-jp/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) ãªã©ã§å®Ÿè¡Œå±æ€§ãŒã¤ã„ãŸãƒšãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’ç¦æ­¢ã™ã‚‹æ©Ÿæ§‹ã§ã™ã€‚

DEP, ACG ã«ã‚ˆã‚Šã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡ŒãŒé›£ã—ããªã‚‹ã®ã§ ROP ã§ãƒã‚¤ãƒ‘ã‚¹ã—ã¾ã™ã€‚

### Structured Exception Handling Overwrite Protection
ãƒ—ãƒ­ã‚»ãƒƒã‚µã§ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã‚‹ã¨ä¾‹å¤– (Exception) ã¨ã„ã†ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¾ã™ã€‚ãã‚Œã‚’ã‚«ãƒ¼ãƒãƒ«ãŒã‚­ãƒ£ãƒƒãƒã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã® Structured Exception Handling (SEH) ã¨ã„ã†ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã®æ©Ÿæ§‹ã«æ¸¡ã—ã¾ã™ã€‚

Thread Environment Block (TEB) ã®å…ˆé ­ã«ã‚ã‚‹ `NT_TIB` æ§‹é€ ä½“ã® `ExceptionList` ã¨ã„ã†ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã®ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã‹ã‚‰ 1 ã¤ãšã¤ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ãã“ã§ä¾‹å¤–å‡¦ç†ãŒæˆåŠŸã—ãŸã‚‰çµ‚äº†ã—ã€å¤±æ•—ã—ãŸã‚‰æ¬¡ã®ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã«é€²ã¿ã€æœ«å°¾ã«ã‚ã‚‹ ntdll.dll ã® FinalExceptionHandler ã¾ã§ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚ã“ã®æ©Ÿæ§‹ã‚’ SEH ã¨è¨€ã„ã¾ã™ã€‚

```c
struct NT_TIB {
  EXCEPTION_REGISTRATION_RECORD *ExceptionList;
  VOID *StackBase;
  VOID *StackLimit;
  VOID *SubSystemTib;
  union {
    VOID *FiberData;
    ULONG Version;
  };
  VOID *ArbitraryUserPointer;
  NT_TIB *Self;
}

struct EXCEPTION_REGISTRATION_RECORD {
  EXCEPTION_REGISTRATION_RECORD *Next;
  EXCEPTION_DISPOSITION *Handler;
}
```

ãã®ãƒªã‚¹ãƒˆã®ä¸€éƒ¨åˆ†ãŒã‚¹ã‚¿ãƒƒã‚¯ä¸Šã«ã‚ã‚‹ã®ã§ BOF ã‚’ç”¨ã„ã¦ Handler ã‚’æ›¸ãæ›ãˆã¦ä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡ŒãŒã§ãã‚‹ SEH overwrite ã¨ã„ã†æ”»æ’ƒæ‰‹æ®µãŒã‚ã‚Šã¾ã—ãŸã€‚

SafeSEH ã¨ã¯ãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚ã‚‰ã‹ã˜ã‚ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ä¸€è¦§ã‚’ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã«åŸ‹ã‚è¾¼ã‚“ã§ãŠãã€ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©å®Ÿè¡Œæ™‚ã«åŸ‹ã‚è¾¼ã¾ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ç…§åˆã—ã¦ä¸€è‡´ã—ãªã‘ã‚Œã°å®Ÿè¡Œã•ã‚Œãªã„ã¨ã„ã†ä»•çµ„ã¿ã§ã™ã€‚ãŸã ã—æ¤œæŸ»ã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ SafeSEH ãŒç´ã¥ã„ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã‚¹ã‚¿ãƒƒã‚¯é ˜åŸŸä¸Šã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ã§ã™ã€‚ãªã®ã§ SafeSEH ç„¡åŠ¹ãª DLL ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ’ãƒ¼ãƒ—é ˜åŸŸä¸Šã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã¨ã™ã‚Œã°ãƒã‚¤ãƒ‘ã‚¹ã§ãã¾ã™ã€‚

Structured Exception Handling Overwrite Protection (SEHOP) ã¨ã¯ SEH overwrite ã®ç·©å’Œç­–ã§ä»¥ä¸‹ã®ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

- ã™ã¹ã¦ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚¹ã‚¿ãƒƒã‚¯ä¸Šã«ã‚ã‚Šã€align ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ¤œæŸ»ã™ã‚‹ã€‚
- ãƒãƒ³ãƒ‰ãƒ©ãŒã‚¹ã‚¿ãƒƒã‚¯ã‚’æŒ‡ã—ã¦ã„ãªã„ã“ã¨ã‚’æ¤œæŸ»ã™ã‚‹ã€‚
- ãƒªã‚¹ãƒˆæœ«å°¾ãŒ FinalExceptionHandler ã§ã‚ã‚‹ã‹æ¤œæŸ»ã™ã‚‹ã€‚

ã“ã‚Œã‚ˆã‚Š SEHOP ã®ãƒã‚¤ãƒ‘ã‚¹ã«ã¯ FinalExceptionHandler ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒªãƒ¼ã‚¯ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã‚‰ã¯ 64 bit ã§ã¯ç„¡åŠ¹ã«ãªã£ãŸã®ã§æ”»æ’ƒã‚‚ç·©å’Œç­–ã‚‚æ„å‘³ã¯ãªã„ã§ã™ã€‚

### Control Flow Guard
æœ€è¿‘ã¯ ROP ã•ãˆã‚‚é˜²ã Control Flow Integrity (CFI) æŠ€è¡“ã¨ã„ã†ã‚‚ã®ãŒç™ºé”ã—ã¦ã„ã¦ã€Windows ã§ã¯æ¬¡ã® 3 ã¤ã® CFI ãŒæ–½è¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚

- Control Flow Guard (CFG)
- CFG Export Suppression
- CallerCheck / SimExec

Control Flow Guard ã¯ call å‘½ä»¤ã®ç›´å‰ã« Guard Control Flow Function Table ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹æ¤œæŸ»ã™ã‚‹å‡¦ç†ã‚’åŠ ãˆã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Š vtable overwrite ãªã©ã®å®Ÿè¡Œã‚¢ãƒ‰ãƒ¬ã‚¹æ›¸ãæ›ãˆã‚’é˜²ãã¾ã™ã€‚

ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã§å¤§ããª ROP ã‚’çµ„ã‚ãªã„ã¨ãã«åˆ¥ã®å ´æ‰€ã«é£›ã°ã—ã¦ãã“ã§çµ„ã‚€ã¨ã„ã† Stack Pivot ã¨ã„ã†æ”»æ’ƒæ‰‹æ³•ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«å¯¾ã—ã¦é‡è¦ãªé–¢æ•°ã®å‘¼ã³å‡ºã—æ™‚ã«ã‚¹ã‚¿ãƒƒã‚¯ã‚’æŒ‡ã—ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã„ã†ç·©å’Œç­–ãŒã‚ã‚Šã¾ã™ã€‚

é€šå¸¸ ret å‘½ä»¤ã§æˆ»ã£ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç›´å‰ã«ã¯ call å‘½ä»¤ãŒã‚ã‚Šã¾ã™ãŒ ROP ã® Gadget ã¯ãã†ã§ã¯ãªã„ã¨ã„ã†ç™ºæƒ³ã®å…ƒã€CallerCheck / SimExec ã¯é‡è¦ãªé–¢æ•°ã® ret å‘½ä»¤ / é‡è¦ãªé–¢æ•°ã®ç›´å¾Œ 20 å‘½ä»¤å…ˆã¾ã§ã® ret å‘½ä»¤ã‚’æ¤œæŸ»ã—ã¾ã™ã€‚ã“ã®ãƒã‚¤ãƒ‘ã‚¹ã«ã¯ call å‘½ä»¤ã® Gadget (ä¾‹ãˆã° `call rax; ret`) ã® ret å‘½ä»¤ã‚’ 19 å›å‘¼ã‚“ã å¾Œã« call å‘½ä»¤ã‚’å‘¼ã¹ã°ã‚ˆã„ã§ã™ã€‚

ã•ã‚‰ã« Windows 10 ã‹ã‚‰ CFG Export Suppression ã¨ã„ã† EAT ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ­£è¦ã®æ‰‹æ®µã§å¾—ãŸã‹æ¤œæŸ»ã™ã‚‹æ©Ÿæ§‹ãŒåŠ ã‚ã‚Šã¾ã—ãŸã€‚call, jmp å‘½ä»¤ã®ç›´å‰ã«æ¤œæŸ»ã—ã¦ä¸æ­£ãªæ–¹æ³• `mov rax, [rax]` ã§å¾—ã¦ã„ã‚‹ã¨ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚

- GetProcAddress é–¢æ•°
- é™çš„ãƒªãƒ³ã‚¯ (IAT ãªã©)
- DLL å†…ã§å¾—ã‚‹

ã“ã‚Œã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã«ã¯æ­£è¦ã®æ–¹æ³•ã§ç²å¾—ã™ã‚‹ Gadget ã‚’åˆ©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

Return Flow Guard ã¨ã„ã† Shadow Stack ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢å®Ÿè£…ãŒã‚ã£ãŸã®ã§ã™ãŒ race condition ã«ã‚ˆã£ã¦ãƒã‚¤ãƒ‘ã‚¹ã§ãã‚‹ãªã©ã®è¦å› ã§ä¸æ¡ç”¨ã¨ãªã‚Šã¾ã—ãŸã€‚

### Image Isolation
æ”»æ’ƒè€…ã¯ãƒªãƒ¢ãƒ¼ãƒˆã® DLL ã‚„äº‹å‰ã«ä»•è¾¼ã‚“ã æ‚ªæ„ã®ã‚ã‚‹ DLL ã‚’èª­ã¿è¾¼ã¾ã›ã‚‹ã“ã¨ã§æ¥½ã«æ‚ªæ„ã®ã‚ã‚‹é–¢æ•°ã‚’å‘¼ã³å‡ºã›ã¾ã™ã€‚ã“ã‚Œã«å¯¾ã—ã¦ DLL ã®èª­ã¿è¾¼ã¿ã‚’åˆ¶é™ã™ã‚‹ç·©å’Œç­–ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚

| ç·©å’Œç­– | èª¬æ˜ |
| --- | --- |
| Block Remote Images | UNC ãƒ‘ã‚¹ã‚„ WebDAV ãƒ‘ã‚¹ã® DLL ã‚’ç¦æ­¢ |
| Block Low Integrity Images | ä½ã„ Integrity Level ã‚’æŒã¤ DLL ã‚’ç¦æ­¢ |
| Microsoft-Signed Binaries Only | Windows Hardware Quality Labs ã® CA ã«ã‚ˆã£ã¦é›»å­è¨¼æ˜ã•ã‚Œã¦ã„ãªã„ DLL ã‚’ç¦æ­¢ |
| Store-Signed Binaries Only | Microsoft Store ã® CA ã«ã‚ˆã£ã¦é›»å­è¨¼æ˜ã•ã‚Œã¦ã„ãªã„ DLL ã‚’ç¦æ­¢ |
| Prefer System32 Images | `${SYSTEM_ROOT}\System32` ã® DLL ã‚’å…ˆã«æ¢ç´¢ã™ã‚‹ |

ã“ã‚Œã‚‰ã®ãƒã‚¤ãƒ‘ã‚¹ã¯ã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ...

SetWindowsHookEx é–¢æ•°ã§ DLL ã®é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ãƒƒã‚¯ã«è¿½åŠ ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã™ã‚‹ã“ã¨ã§å®Ÿè¡Œã•ã‚Œ DLL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒæˆåŠŸã—ã¾ã™ã€‚Disable Extension Points ã¨ã¯ ãƒ—ãƒ­ã‚»ã‚¹ãŒæ‹¡å¼µãƒã‚¤ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã‚’ç„¡åŠ¹ã«ã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚

### Address Filter
Export Address Filter (EAF) / Import Address Filter (IAF) ã¨ã¯ .text é ˜åŸŸä»¥å¤–ã‹ã‚‰ç‰¹å®šã® DLL (kernel32.dll, ntdll.dll, kernelbase.dll) ã® EAT / IAT ã®èª­ã¿å–ã‚Šã‚’åˆ¶é™ã™ã‚‹æ©Ÿæ§‹ã§ã™ã€‚

ã“ã®ãƒã‚¤ãƒ‘ã‚¹ã«ã¯ ROP ã‚’ç”¨ã„ã¦å¦¥å½“ãªã‚³ãƒ¼ãƒ‰é ˜åŸŸã‹ã‚‰ EAT ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚Œã°ã‚ˆã„ã§ã™ã€‚

NtContinue ã‚’å‘¼ã¶ã“ã¨ã§ã€EAF ãŒåˆ©ç”¨ã—ã¦ã„ã‚‹ãƒ‡ãƒãƒƒã‚°ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹

### ãã®ä»–

| ç·©å’Œç­– | èª¬æ˜ |
| --- | --- |
| Disable Child Process Creation | å­ãƒ—ãƒ­ã‚»ã‚¹ã‚’ä½œæˆã™ã‚‹ã®ã‚’ç¦æ­¢ã™ã‚‹ |
| Disable Fsctl SystemCalls | |
| Disable Win32k system calls (from Windows 8) | Win32k.sys ã®å‘¼ã³å‡ºã—ã‚’ç¦æ­¢ã™ã‚‹ |
| Validate handle usage | |
| Validate image dependency integrity | |
| Block Untrusted Fonts | Graphics Device Interface (GDI) ã®ãƒ•ã‚©ãƒ³ãƒˆè§£æã«ã‚ˆã‚‹ç‰¹æ¨©æ˜‡æ ¼ `%windir%\Fonts` ä»¥å¤–ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ã—ãªã„ |

Exploit Protection ã¯ä¸»è¦ãªç·©å’Œç­–ã§ä»–ã«ã‚‚æ²¢å±±ã®ç·©å’Œç­–ãŒã‚ã‚Šã¾ã™ã€‚

## Kernel Exploit
æ¨©é™æ˜‡æ ¼ (Priviladge Escalation) ã¨ã¯ãã®åã®é€šã‚Šä½ã„æ¨©é™ã‹ã‚‰é«˜ã„æ¨©é™ã¸æ˜‡æ ¼ã—ã¦ã€ã‚ˆã‚Šå¹…åºƒã„ã“ã¨ãŒå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚æ¨©é™æ˜‡æ ¼ã®æ–¹æ³•ã«ã¯ 2 ã¤ã‚ã‚Šã¾ã™ã€‚

- ã‚«ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ä¸­ã«ä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã™ã‚‹
- ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€

æ˜”ã¯ [NtQuerySystemInformation é–¢æ•°](https://learn.microsoft.com/ja-jp/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation) ã‚’ç”¨ã„ã¦ ntoskrnl.exe ã«ã‚ã‚‹ HalDispatchTable ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã€æ›¸ãæ›ãˆã¦ NtQueryIntervalProfile é–¢æ•°ã‚’å‘¼ã¶ã“ã¨ã§ã‚«ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ HalDispatchTable ã‚’å‘¼ã³å‡ºã—ã€æ¨©é™æ˜‡æ ¼ã—ã¦ã„ãŸã®ã§ã™ãŒä½ã„ integrity ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ã¯ç¦æ­¢ã•ã‚ŒãŸã®ã§ä»Šã¯å³ã—ã„ã§ã™ã€‚

https://inaz2.hatenablog.com/entry/2015/09/15/121926

kASLR, NX, SMEP, SMAP, kCFG, HVCI ãªã©ã®ã‚«ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã®ç·©å’Œç­–ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹
NonPagedPool ã‚’å®Ÿè¡Œå¯èƒ½ã§ Kenrel mode ã‹ã‚‰å®Ÿè¡Œã™ã‚‹
Windows Kernel Driver ã®è„†å¼±æ€§
- tagWND
- GdiSharedHandleTable -> kernel address æ¶ˆã™,
- Page Table Entry overwrite

### Token Stealing

### tagWND
- Window Function running in kernel mode

tagWND ã®å¾Œã® Window Extra Data ã®é•·ã• cbwndExtra ã‚’å¤§ããã™ã‚‹ã“ã¨ã§ AAR, AAW ã‚’å¯èƒ½ã«ã™ã‚‹è„†å¼±æ€§ã§ã™ã€‚
gSharedInfo
aheList
tagMenu, tagWND

## ãƒ’ãƒ¼ãƒ—é ˜åŸŸ

ãƒ’ãƒ¼ãƒ—ã‹ã‚‰ã®ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦ (HeapCreate, HeapAlloc, HeapFree)
ä»®æƒ³ãƒ¡ãƒ¢ãƒªã®ç›´æ¥ã®å‰²ã‚Šå½“ã¦ (VirtualAlloc, VirtualAllocEx)

| Allocation Size | Granularity | Bucket |
| --- | --- | --- |
| 1 ~ 1,024 bytes (0x1 ~ 0x400) | 16 bytes | 1 ~ 64 |
| 1,025 ~ 2,048 bytes (0x401 ~ 0x800) | 64 bytes | 65 ~ 80 |
| 2,049 ~ 4,096 bytes (0x801 ~ 0x1000) | 128 bytes | 81 ~ 96 |
| 4,097 ~ 8,192 bytes (0x1001 ~ 0x2000) | 256 bytes | 97 ~ 112 |
| 8,193 ~ 16,368 bytes (0x2001 ~ 0x3FF0) | 512 bytes | 113 ~ 128 |

ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦ã® API
CoTaskMemAlloc
GlobalAlloc
HeapAlloc
LocalAlloc
malloc
new
VirtualAlloc

Heap Terminate On Corruption
ãƒ’ãƒ¼ãƒ—ãŒç ´æã—ãŸå ´åˆã«ãƒ—ãƒ­ã‚»ã‚¹ã‚’å¼·åˆ¶çµ‚äº†ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ãƒ’ãƒ¼ãƒ—ç ´æã®ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã‚’æ‚ªç”¨ã™ã‚‹æ”»æ’ƒã‚„æ™‚ã€…ãƒ’ãƒ¼ãƒ—ã®ç ´æã‚’èµ·ã“ã™ç¨‹åº¦ã® Exploit ã‚’é˜²å¾¡ã™ã‚‹ã¨ã„ã†ã€ãƒ’ãƒ¼ãƒ—ã®æ•´åˆæ€§ã‚’æ¤œè¨¼ã™ã‚‹æ©Ÿèƒ½*3ã€‚HeapSetInformation é–¢æ•°

## ã¾ã¨ã‚
ã•ã‚‰ã«ã‚ˆã‚Šè©³ç´°ã§ç¶²ç¾…çš„ãª Exploit ã‚„ Malware ã®æƒ…å ±ãŒã¾ã¨ã¾ã£ã¦ã‚‹è¨˜äº‹ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®è¨˜äº‹ã®æ¬¡ã¯ã“ã‚Œã‚’èª­ã‚€ã®ãŒã„ã„ã§ã—ã‚‡ã†ã€‚

https://www.ired.team/
https://github.com/pinksawtooth/how_to_become_a_malware_analyst

## å‚è€ƒæ–‡çŒ®
- ã‚¤ãƒ³ã‚µã‚¤ãƒ‰ Windows
- Windows ã‚«ãƒ¼ãƒãƒ«ãƒ‰ãƒ©ã‚¤ãƒãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°
- ã‚¤ãƒ³ã‚µã‚¤ãƒ‰ ExploitProtection
- [Customize Exploit Protection](https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/customize-exploit-protection)
- [SEH ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒˆã®é˜²å¾¡æ©Ÿèƒ½ã¨ãã® Exploit å¯èƒ½æ€§](https://www.ffri.jp/assets/files/research/research_papers/SEH_Overwrite.pdf)
- [Windowsã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ–°æ©Ÿèƒ½ Control Flow Guardã«ã¤ã„ã¦](https://www.ffri.jp/assets/files/monthly_research/MR201412_Control_Flow_Guard_JPN.pdf)
- [Exploit Protection ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://learn.microsoft.com/ja-jp/microsoft-365/security/defender-endpoint/exploit-protection-reference)
- [è„†å¼±æ€§ç·©å’ŒæŠ€è¡“ã®æœ€å‰ç·š](https://www.ffri.jp/assets/files/research/research_papers/recent_advances_vuln_mitig_jp.pdf)
- [Heap Exploitã®ã“ã‚Œã¾ã§ã¨ç¾çŠ¶](https://www.ffri.jp/assets/files/monthly_research/MR201312_History%20and%20Current%20State%20of%20Heap%20Exploit_JPN.pdf)
- https://msrc.microsoft.com/blog/2013/12/software-defense-mitigating-common-exploitation-techniques/
- https://attack.mitre.org/tactics/TA0004/
- https://www.blackhat.com/docs/us-17/wednesday/us-17-Schenk-Taking-Windows-10-Kernel-Exploitation-To-The-Next-Level%E2%80%93Leveraging-Write-What-Where-Vulnerabilities-In-Creators-Update.pdf
- https://www.blackhat.com/docs/us-16/materials/us-16-Yason-Windows-10-Segment-Heap-Internals.pdf
- https://www.blackhat.com/docs/us-16/materials/us-16-Yason-Windows-10-Segment-Heap-Internals-wp.pdf
- https://www.blackhat.com/docs/eu-16/materials/eu-16-Liang-Attacking-Windows-By-Windows.pdf
- https://i.blackhat.com/us-18/Thu-August-9/us-18-Bulazel-Windows-Offender-Reverse-Engineering-Windows-Defenders-Antivirus-Emulator.pdf
- https://unit42.paloaltonetworks.jp/win32k-analysis-part-1/
- https://www.blackhat.com/docs/us-16/materials/us-16-Sabanal-Into-The-Core-In-Depth-Exploration-Of-Windows-10-IoT-Core-wp.pdf
