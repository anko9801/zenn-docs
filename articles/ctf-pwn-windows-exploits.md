---
title: "【CTF 探訪記】Windows Exploits"
emoji: "😸"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["CTF", "pwn", "windows"]
published: false
---

pwn というのはメモリの書き換えや読み取りなどの低レイヤーの脆弱性を用いて意図しない動作を引き起こさせる競技で最もハッキングっぽい分野です。

- [Stack Exploits](https://zenn.dev/anko/articles/ctf-stack-exploits)
- [Heap Exploits](https://zenn.dev/anko/articles/ctf-heap-exploits)

ここまでで Linux において分かったので今回は Windows に対して攻撃してみようと思います。Windows には大量のセキュリティ機構があります。ここでは 64 ビットシステムの Windows Server を対象にします。バージョンに依存することは極力触れずふんわりとした理解を目指します。

## Windows の基本
pdata

- Heap
- Shareable
- Thread Stack
- Mapped File
- Image
- Private Data

構造は Linux と同じです

## Windows Exploit の基本
OS は違えど基本的な構造は同じなので Linux と同じように攻撃できます。

## プロセスの緩和策 (Mitigations)

Windows には Linux に比べて豊富なセキュリティ機構があります。

一般的な緩和策の設定は次の 4 つの方法があります。

- [Set-ProcessMitigationPolicy 関数](https://learn.microsoft.com/ja-jp/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessmitigationpolicy)
- [Set-ProcessMitigation コマンド](https://learn.microsoft.com/en-us/powershell/module/processmitigations/set-processmitigation)
- [リンカのオプション](https://learn.microsoft.com/ja-jp/cpp/build/reference/linker-options)
  - `cl <cpp file> /link <link options>`
- 「Windows セキュリティ」→「セキュリティの概要」→「アプリとブラウザー コントロール」→「Exploit Protection の設定」

またプロセスごとに緩和策が施行されているかどうか確認する為には次のアプリケーションが使えます。

- Task Manager の Details
- [ProcessExplorer](https://learn.microsoft.com/ja-jp/sysinternals/downloads/process-explorer)
- [pestudio](https://www.winitor.com/)

さてどのような緩和策があるのか覗いてみましょう。

### Address Space Layout Randomization
Address Space Layout Randomization (ASLR) とはスタックやヒープ、実行領域などのアドレスをランダム化する機構です。プロセスの仮想メモリはページ単位で物理メモリとのマッピングが行われます。

`/DYNAMICBASE:NO`
| 派生 | 説明 | 設定 |
| --- | --- | --- |
| bottomup ASLR | 本緩和策は仮想メモリの割り当てをランダム化するものです。すなわち、VirtualAlloc によって割り当てられるアドレスをランダム化するという緩和策です。 |  |
| High Entropy ASLR | | |
| ASLR Disallow Stripped Image | 本緩和策は ASLR 無効なDLL を実行バイナリプロセスが読み込まないようにするというものです。すなわち、本設定が施された実行バイナリプロセスは、/FIXED リンクオプション*10でビルドされた DLL を読み込むことができません。 | |


### Data Execution Prevention
Data Execution Prevention (DEP) とはスタック領域やヒープ領域のページに実行権限を渡さない機構、 Arbitary Code Guard (ACG) とは [VirtualAlloc](https://learn.microsoft.com/ja-jp/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) や [VirtualProtect](https://learn.microsoft.com/ja-jp/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) などで実行属性がついたページを作成することを禁止する機構もあります。

- [SetProcessDEPPolicy 関数](https://learn.microsoft.com/ja-jp/windows/win32/api/winbase/nf-winbase-setprocessdeppolicy)
- 「コントロールパネル」=>「システム」=>「システムの詳細設定」よりパフォーマンスの設定を開いて図 3.1 の画面で設定する方法。この画面では、BCD の nx オプションの値のうち、OptIn と OptOut に対応するような設定を行うことが可能。

### Structured Exception Handling Overwrite Protection
Structured Exception Handling (SEH) とは例外ハンドラの機構なのですがそのアドレスを書き換えることで ACE する SEH overwrite という攻撃手段がありました。

```c
struct EXCEPTION_REGISTRATION_RECORD{
  EXCEPTION_REGISTRATION_RECORD *_next;
  PEXCEPTION_ROUTINE _handler;
}
```

safe SEH とはビルド時にあらかじめ例外ハンドラのアドレス一覧をバイナリファイルに埋め込んでおき、例外ハンドラ実行時に埋め込まれたアドレスと照合して一致しなければ実行されないという仕組みです

1 つ目は自分でビルドした実行ファイル本体の exe ではなく、その exe が使用する DLLが safeSEH オプション有効でビルドしていない場合、その DLL 内の任意のアドレスは例外ハンドラとして有効であるとみなされる点です。そのため、safeSEH オプション有効でビルドしていない DLL の命令群を用いて攻撃することができます。
2 つ目は、safeSEH が作用する例外ハンドラのアドレスが safeSEH が紐づいたイメージのアドレス + スタックであるという点です。すなわち、ヒープ領域に対しては例外ハンドラのチェックが走りません。ヒープ領域が実行可能であり、かつヒープ領域上に命令列を展開することができれば、その命令列を SEH overwrite で実行することが可能となります。ちなみに、2 つ目の攻撃に対しては、DEP を使えばヒープ領域が実行可能とならないため、防ぐことが可能です。

Structured Exception Handling Overwrite Protection (SEHOP) とは SEH のリンクリストの正当性を検証することによって、SEH overwrite 攻撃を防止する技術です。SEHOP が有効である場合、例外ハンドラのリストの最後に ntdll.dll の FinalExceptionHandler が繋がります。そして、例外発生時には例外ハンドラのリストの最後にFinalExceptionHandler が繋がっているかを確認します。攻撃者が SEH overwrite を行った場合、例外ハンドラのリストの最後は ntdll.dll の FinalExceptionHandler を指さなくなるので、攻撃に失敗します。この緩和策を突破するためには ntdll.dll の FinalExceptionHandler のアドレスを得る必要がありますが、ntdll.dll は ASLR 有効であるため、容易に得ることはできません。実際に SEHOP の効果を見てみましょう。seh_overwrite.cpp を safeSEH 無効で再度ビルドします。そして作成された seh_overwrite.exe を実行してみると、WIN!と表示されて、SEH overwrite に成功していることが分かります。（念のためオフセットの確認を怠らないでください。）

[dumpbin コマンド](https://learn.microsoft.com/ja-jp/cpp/build/reference/dumpbin-reference) で readelf

### Control Flow Guard
Return Flow Guard
Stack Pivot
Caller Check
SimExec

### Image Isolation
No Remote Images
No Low IL Images

Disable Extension Points

### Address Filter
Export Address Filter
Import Address Filter
Disable Child Process Creation

緩和策名 説明 設定方法
- Disable-Non-System-Fonts
  - ${SYSTEMROOT}\Fonts ディレクトリにインストールされた後にユーザのログオン時に Winlogon によって未登録の任意のファイルが読み込まれるのを防ぐという、信頼されていないフォントをブロックする機能*1。
- Prefer-System32-Images
  - DLL の探索順序を利用して悪意のある DLL をプロセスに読み込ませることを防止するため、ローダーの検索パスを変更し特定の DLL の読み込みを常に${SYSTEM_ROOT}\System32 フォルダ内で検索する機能*2。
- Heap-Terminate-On-Corruption
  - ヒープが破損した場合にプロセスを強制終了することによって、ヒープ破損の例外ハンドラを悪用する攻撃や時々ヒープの破損を起こす程度の Exploit を防御するという、ヒープの整合性を検証する機能*3。HeapSetInformation 関数
- Filter-Win32k-System-Calls
- Raise-Exception-on-Invalid-Handle

## 回避
### SEH overwrite

## ツール
プロセスのメモリ

- [x64dbg](https://x64dbg.com/)
- [WinDbg](https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debugger-download-tools)
  - User Kernel どちらもデバッグできる

## まとめ

## 参考文献
- [Customize Exploit Protection](https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/customize-exploit-protection)
- [SEH オーバーライトの防御機能とその Exploit 可能性](https://www.ffri.jp/assets/files/research/research_papers/SEH_Overwrite.pdf)