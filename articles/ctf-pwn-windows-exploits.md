---
title: "ã€CTF æ¢è¨ªè¨˜ã€‘Windows Exploits"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CTF", "pwn", "windows"]
published: false
---

pwn ã¨ã„ã†ã®ã¯ãƒ¡ãƒ¢ãƒªã®æ›¸ãæ›ãˆã‚„èª­ã¿å–ã‚Šãªã©ã®ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è„†å¼±æ€§ã‚’ç”¨ã„ã¦æ„å›³ã—ãªã„å‹•ä½œã‚’å¼•ãèµ·ã“ã•ã›ã‚‹ç«¶æŠ€ã§æœ€ã‚‚ãƒãƒƒã‚­ãƒ³ã‚°ã£ã½ã„åˆ†é‡ã§ã™ã€‚

- [Stack Exploits](https://zenn.dev/anko/articles/ctf-stack-exploits)
- [Heap Exploits](https://zenn.dev/anko/articles/ctf-heap-exploits)

ã“ã“ã¾ã§ã§ Linux ã«ãŠã„ã¦åˆ†ã‹ã£ãŸã®ã§ä»Šå›ã¯ Windows ã«å¯¾ã—ã¦æ”»æ’ƒã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚Windows ã«ã¯å¤§é‡ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹ãŒã‚ã‚Šã¾ã™ã€‚ã“ã“ã§ã¯ 64 ãƒ“ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã® Windows Server ã‚’å¯¾è±¡ã«ã—ã¾ã™ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ä¾å­˜ã™ã‚‹ã“ã¨ã¯æ¥µåŠ›è§¦ã‚Œãšãµã‚“ã‚ã‚Šã¨ã—ãŸç†è§£ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

## Windows ã®åŸºæœ¬
pdata

- Heap
- Shareable
- Thread Stack
- Mapped File
- Image
- Private Data

æ§‹é€ ã¯ Linux ã¨åŒã˜ã§ã™

## Windows Exploit ã®åŸºæœ¬
OS ã¯é•ãˆã©åŸºæœ¬çš„ãªæ§‹é€ ã¯åŒã˜ãªã®ã§ Linux ã¨åŒã˜ã‚ˆã†ã«æ”»æ’ƒã§ãã¾ã™ã€‚

## ãƒ—ãƒ­ã‚»ã‚¹ã®ç·©å’Œç­– (Mitigations)

Windows ã«ã¯ Linux ã«æ¯”ã¹ã¦è±Šå¯Œãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹ãŒã‚ã‚Šã¾ã™ã€‚

ä¸€èˆ¬çš„ãªç·©å’Œç­–ã®è¨­å®šã¯æ¬¡ã® 3 ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

- [Set-ProcessMitigationPolicy é–¢æ•°](https://learn.microsoft.com/ja-jp/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessmitigationpolicy)
- [Set-ProcessMitigation ã‚³ãƒãƒ³ãƒ‰](https://learn.microsoft.com/en-us/powershell/module/processmitigations/set-processmitigation)
- ã€ŒWindows ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ã‚’èµ·å‹•â†’ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®æ¦‚è¦ã€â†’ã€Œã‚¢ãƒ—ãƒªã¨ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã€â†’ã€ŒExploit Protection ã®è¨­å®šã€

### Address Space Layout Randomization
Address Space Layout Randomization (ASLR)
ãƒ—ãƒ­ã‚»ã‚¹ãŒä½¿ç”¨ã™ã‚‹ä»®æƒ³ãƒ¡ãƒ¢ãƒªã®ä¸­ã®æ§˜ã€…ãªé ˜åŸŸã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã™ã‚‹
ãƒ—ãƒ­ã‚»ã‚¹ã®ä»®æƒ³ãƒ¡ãƒ¢ãƒªã¯ãƒšãƒ¼ã‚¸å˜ä½ã§ç‰©ç†ãƒ¡ãƒ¢ãƒªã¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãŒè¡Œã‚ã‚Œã¾ã™ã€‚
ãƒªãƒ³ã‚¯æ™‚ã«

`cl aslr_test.cpp /link /DYNAMICBASE:NO`

- bottomup ASLR
  - VirtualAlloc
- High Entropy ASLR
- ASLR Disallow Stripped Image

https://learn.microsoft.com/en-us/cpp/build/reference/dynamicbase-use-address-space-layout-randomization?view=msvc-170
https://learn.microsoft.com/en-us/cpp/build/reference/highentropyva-support-64-bit-aslr?view=msvc-170


### Data Execution Prevention
Data Execution Prevention (DEP)
ã‚¹ã‚¿ãƒƒã‚¯ã‚„ãƒ’ãƒ¼ãƒ—é ˜åŸŸã®æ©Ÿæ¢°èªå‘½ä»¤ã®å®Ÿè¡Œã‚’ä¸å¯èƒ½ã«ã™ã‚‹æŠ€è¡“

- Arbitary Code Guard
  - å®Ÿè¡Œå±æ€§ãŒã¤ã„ãŸãƒšãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’ä¸å¯èƒ½ã«ã™ã‚‹ç·©å’Œç­–

ä¸Šè¨˜ã®å¯¾ç­–ã‚’è¡Œã†ã“ã¨ã«ã‚ˆã‚Šã€Return Oriented Programming ã«ã‚ˆã‚Šãƒ—ãƒ­ã‚»ã‚¹å†…ã§ [VirtualAlloc](https://learn.microsoft.com/ja-jp/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) ã‚‚ã—ãã¯ [VirtualProtect](https://learn.microsoft.com/ja-jp/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) ã«ã‚ˆã‚‹å®Ÿè¡Œå¯èƒ½å±æ€§ã®ãƒšãƒ¼ã‚¸ã‚’ä½œæˆãƒ»ãã®ãƒšãƒ¼ã‚¸ã¸ã®ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰å±•é–‹ãƒ»ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰å®Ÿè¡ŒãŒä¸å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚




- `cl <cpp file> /link /NXCOMPAT:NO`
- [SetDEPPolicy é–¢æ•°](https://learn.microsoft.com/ja-jp/windows/win32/api/winbase/nf-winbase-setprocessdeppolicy)

### Structured Exception Handling
Structured Exception Handling (SEH)

safe SEH
SEHOP

[SEH ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒˆã®é˜²å¾¡æ©Ÿèƒ½ã¨ãã® Exploit å¯èƒ½æ€§](https://www.ffri.jp/assets/files/research/research_papers/SEH_Overwrite.pdf)

### Control Flow Guard
Return Flow Guard
Stack Pivot
Caller Check
SimExec

### image load
No Remote Images
No Low IL Images

Disable Extension Points

### Address Filter
Export Address Filter
Import Address Filter
Disable Child Process Creation

ç·©å’Œç­–å èª¬æ˜ è¨­å®šæ–¹æ³•
- Disable-Non-System-Fonts
  - ${SYSTEMROOT}\Fonts ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸå¾Œã«ãƒ¦ãƒ¼ã‚¶ã®ãƒ­ã‚°ã‚ªãƒ³æ™‚ã« Winlogon ã«ã‚ˆã£ã¦æœªç™»éŒ²ã®ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã®ã‚’é˜²ãã¨ã„ã†ã€ä¿¡é ¼ã•ã‚Œã¦ã„ãªã„ãƒ•ã‚©ãƒ³ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹æ©Ÿèƒ½*1ã€‚
- Prefer-System32-Images
  - DLL ã®æ¢ç´¢é †åºã‚’åˆ©ç”¨ã—ã¦æ‚ªæ„ã®ã‚ã‚‹ DLL ã‚’ãƒ—ãƒ­ã‚»ã‚¹ã«èª­ã¿è¾¼ã¾ã›ã‚‹ã“ã¨ã‚’é˜²æ­¢ã™ã‚‹ãŸã‚ã€ãƒ­ãƒ¼ãƒ€ãƒ¼ã®æ¤œç´¢ãƒ‘ã‚¹ã‚’å¤‰æ›´ã—ç‰¹å®šã® DLL ã®èª­ã¿è¾¼ã¿ã‚’å¸¸ã«${SYSTEM_ROOT}\System32 ãƒ•ã‚©ãƒ«ãƒ€å†…ã§æ¤œç´¢ã™ã‚‹æ©Ÿèƒ½*2ã€‚
- Heap-Terminate-On-Corruption
  - ãƒ’ãƒ¼ãƒ—ãŒç ´æã—ãŸå ´åˆã«ãƒ—ãƒ­ã‚»ã‚¹ã‚’å¼·åˆ¶çµ‚äº†ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ãƒ’ãƒ¼ãƒ—ç ´æã®ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã‚’æ‚ªç”¨ã™ã‚‹æ”»æ’ƒã‚„æ™‚ã€…ãƒ’ãƒ¼ãƒ—ã®ç ´æã‚’èµ·ã“ã™ç¨‹åº¦ã® Exploit ã‚’é˜²å¾¡ã™ã‚‹ã¨ã„ã†ã€ãƒ’ãƒ¼ãƒ—ã®æ•´åˆæ€§ã‚’æ¤œè¨¼ã™ã‚‹æ©Ÿèƒ½*3ã€‚HeapSetInformation é–¢æ•°
- Filter-Win32k-System-Calls
- Raise-Exception-on-Invalid-Handle

## å›é¿
### SEH overwrite

## ãƒ„ãƒ¼ãƒ«
ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒ¡ãƒ¢ãƒª

- [x64dbg](https://x64dbg.com/)
- [WinDbg](https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debugger-download-tools)
  - User Kernel ã©ã¡ã‚‰ã‚‚ãƒ‡ãƒãƒƒã‚°ã§ãã‚‹

## ã¾ã¨ã‚
