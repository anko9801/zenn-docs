---
title: "ã€CTF æ¢è¨ªè¨˜ã€‘Windows Exploits"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CTF", "pwn", "windows"]
published: false
---

pwn ã¨ã„ã†ã®ã¯ãƒ¡ãƒ¢ãƒªã®æ›¸ãæ›ãˆã‚„èª­ã¿å–ã‚Šãªã©ã®ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è„†å¼±æ€§ã‚’ç”¨ã„ã¦æ„å›³ã—ãªã„å‹•ä½œã‚’å¼•ãèµ·ã“ã•ã›ã‚‹ç«¶æŠ€ã§æœ€ã‚‚ãƒãƒƒã‚­ãƒ³ã‚°ã£ã½ã„åˆ†é‡ã§ã™ã€‚

- [Stack Exploits](https://zenn.dev/anko/articles/ctf-stack-exploits)
- [Heap Exploits](https://zenn.dev/anko/articles/ctf-heap-exploits)

ä»Šå›ã¯ Windows ã®åŸºæœ¬ã¨ç·©å’Œç­–ã®ç´¹ä»‹ã‚’ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚æ°—ãŒå‘ã„ãŸã‚‰ PoC ã‚‚æ›¸ãã¾ã™ã€‚

ã“ã“ã§ã¯ 64 ãƒ“ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã® Windows / Windows Server ã‚’å¯¾è±¡ã«ã—ã¾ã™ã€‚

## Windows ã®åŸºæœ¬
Windows OS ã®æ­´å²

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç™ºå£²æ—¥ | èª¬æ˜ |
| --- | --- | --- |
| Windows 1.x | 1985/11/20 |
| Windows 2.x | 1987/12/9 |
| Windows 3.x | 1990/5/22 |
| Windows NT | 1993/7/27 |
| Windows 95 | 1995/8/24 |
| Windows 98 | 1998/6/25 |
| Windows 2000 | 1999/12/15 | 9xç³» NTç³»ã®è„†å¼±æ€§ã¯æ·±åˆ»ãªç¤¾ä¼šå•é¡Œ |
| Windows XP | 2001/8/24 | Service Pack2 (SP2) ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”¹è‰¯ |
| Windows Vista | 2006/11/30 | |
| Windows 7 | 2009/9/1 |
| Windows 8 | 2012/8/16 |
| Windows 10 | 2015/7/29 | Block Untrusted Fonts |
| Windows 11 | 2021/10/5 |

Service Pack

pdata

- Heap
- Shareable
- Thread Stack
- Mapped File
- Image
- Private Data

Windows API (Win32 API)
https://learn.microsoft.com/en-us/

DLLå†…ã®APIã‚’å‘¼ã³å‡ºã™ã“ã¨ã§è©³ç´°ã‚’çŸ¥ã‚‹ã“ã¨ãªããƒªã‚½ãƒ¼ã‚¹ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã‚‹.

1. CreateFileA ã‚’å‘¼ã³å‡ºã™.
2. kernel32.dll / ntdll.dll ã‹ã‚‰ sysenter / syscall ã—ã¦ã‚«ãƒ¼ãƒãƒ«ã¸æ¸¡ã™.
3. ntoskrnl.exe ãŒå®Ÿéš›ã«ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã™ã‚‹.

DLL =? ã‚¤ãƒ¡ãƒ¼ã‚¸

## Windows Exploit ã®åŸºæœ¬
OS ã¯é•ãˆã©åŸºæœ¬çš„ãªæ§‹é€ ã¯åŒã˜ãªã®ã§ Linux ã¨åŒã˜ã‚ˆã†ã«æ”»æ’ƒã§ãã¾ã™ã€‚

- ROP
- vtable overwrite
- SEH overwrite
- ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰
- æ”»æ’ƒè€…ã¯ãƒªãƒ¢ãƒ¼ãƒˆã® DLL ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ã«ã‚ˆã‚Šä»»æ„ã®æ”»æ’ƒã‚’å®Ÿè¡Œã—ã¾ã™
  - ROP ã‚ˆã‚Šæ‚ªæ„ã‚ã‚‹é–¢æ•°ã«ãƒªã‚¿ãƒ¼ãƒ³ã™ã‚‹æ–¹ãŒæ¥½

é›»å“ (calc.exe) ã®èµ·å‹•ãŒç›®æ¨™ãªã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚

## ãƒ’ãƒ¼ãƒ—é ˜åŸŸ

C / C++ ã® malloc / new ã§

HeapCreate
HeapAlloc
HeapFree

VirtualAlloc ç³»	ä»®æƒ³ãƒ¡ãƒ¢ãƒªã®ç›´æ¥ã®å‰²ã‚Šå½“ã¦ã€‚ VirtualAllocEx ç­‰ã€‚
HeapAlloc ç³»	ãƒ’ãƒ¼ãƒ—ã‹ã‚‰ã®ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦ã€‚GlobalAlloc, LocalAlloc ãªã©ã‚‚ã“ã¡ã‚‰ã«å«ã‚€ã€‚
ã¾ãŸã€CRT (C Runtime) ã®å‰²ã‚Šå½“ã¦ã¯ã“ã¡ã‚‰ã®ä¸Šã«æ§‹ç¯‰ã•ã‚Œã‚‹ã€‚

Heap Terminate On Corruption
ãƒ’ãƒ¼ãƒ—ãŒç ´æã—ãŸå ´åˆã«ãƒ—ãƒ­ã‚»ã‚¹ã‚’å¼·åˆ¶çµ‚äº†ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ãƒ’ãƒ¼ãƒ—ç ´æã®ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã‚’æ‚ªç”¨ã™ã‚‹æ”»æ’ƒã‚„æ™‚ã€…ãƒ’ãƒ¼ãƒ—ã®ç ´æã‚’èµ·ã“ã™ç¨‹åº¦ã® Exploit ã‚’é˜²å¾¡ã™ã‚‹ã¨ã„ã†ã€ãƒ’ãƒ¼ãƒ—ã®æ•´åˆæ€§ã‚’æ¤œè¨¼ã™ã‚‹æ©Ÿèƒ½*3ã€‚HeapSetInformation é–¢æ•°

## ãƒ—ãƒ­ã‚»ã‚¹ã®ç·©å’Œç­– (Mitigations)
Windows ã«ã¯ Linux ã«æ¯”ã¹ã¦è±Šå¯Œãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹ãŒã‚ã‚Šã¾ã™ã€‚

ä¸€èˆ¬çš„ãªç·©å’Œç­–ã®è¨­å®šã¯æ¬¡ã® 4 ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

- [Set-ProcessMitigationPolicy é–¢æ•°](https://learn.microsoft.com/ja-jp/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessmitigationpolicy)
- [Set-ProcessMitigation ã‚³ãƒãƒ³ãƒ‰](https://learn.microsoft.com/en-us/powershell/module/processmitigations/set-processmitigation)
- [ãƒªãƒ³ã‚«ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³](https://learn.microsoft.com/ja-jp/cpp/build/reference/linker-options)
- ã€ŒWindows ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€â†’ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®æ¦‚è¦ã€â†’ã€Œã‚¢ãƒ—ãƒªã¨ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã€â†’ã€ŒExploit Protection ã®è¨­å®šã€

ã¾ãŸãƒ—ãƒ­ã‚»ã‚¹ã”ã¨ã«ç·©å’Œç­–ãŒæ–½è¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ç¢ºèªã™ã‚‹ç‚ºã«ã¯æ¬¡ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒä½¿ãˆã¾ã™ã€‚

- [ProcessExplorer](https://learn.microsoft.com/ja-jp/sysinternals/downloads/process-explorer) (ãŠã™ã™ã‚)
- [pestudio](https://www.winitor.com/)
- Task Manager ã® Details

ã•ã¦ã©ã®ã‚ˆã†ãªç·©å’Œç­–ãŒã‚ã‚‹ã®ã‹è¦—ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### Address Space Layout Randomization
ãƒ—ãƒ­ã‚»ã‚¹ã®ä»®æƒ³ãƒ¡ãƒ¢ãƒªã¯ãƒšãƒ¼ã‚¸å˜ä½ã§ç‰©ç†ãƒ¡ãƒ¢ãƒªã¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

Address Space Layout Randomization (ASLR) ã¨ã¯ã‚¹ã‚¿ãƒƒã‚¯ã‚„ãƒ’ãƒ¼ãƒ—ã€å®Ÿè¡Œé ˜åŸŸãªã©ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã™ã‚‹æ©Ÿæ§‹ã§ã™ã€‚ASLR æœ‰åŠ¹ `/DYNAMICBASE` ã§ã¯ ROP ãŒä¸€æ®µéšé›£ã—ããªã‚Šã€ã“ã‚Œã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã«ã¯ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒªãƒ¼ã‚¯ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

Force randomization for images (Mandatory ASLR)
Randomize memory allocations (Bottom-up ASLR)

ãã—ã¦ Bottom-up ASLR ã§ VirtualAlloc ãªã©ã§ä½œã‚‰ã‚ŒãŸãƒšãƒ¼ã‚¸ã‚‚ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã—ã€High Entropy ASLR `/HIGHENTROYVA` ã§ 64-bit ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æœ€å¤§é™ã«ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã€ASLR Disallow Stripped Image ã§ ASLR ç„¡åŠ¹ `/FIXED` ãª DLL ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ç¦æ­¢ã¨ã™ã‚‹ã¨ã„ã†æ©Ÿæ§‹ã§ã™ã€‚

https://msrc.microsoft.com/blog/2013/12/software-defense-mitigating-common-exploitation-techniques/

### Data Execution Prevention
Data Execution Prevention (DEP) ã¨ã¯ã‚¹ã‚¿ãƒƒã‚¯é ˜åŸŸã‚„ãƒ’ãƒ¼ãƒ—é ˜åŸŸã®ãƒšãƒ¼ã‚¸ã«å®Ÿè¡Œæ¨©é™ã‚’æ¸¡ã•ãªã„æ©Ÿæ§‹ã€ Arbitary Code Guard (ACG) ã¨ã¯ [VirtualAlloc](https://learn.microsoft.com/ja-jp/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) ã‚„ [VirtualProtect](https://learn.microsoft.com/ja-jp/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) ãªã©ã§å®Ÿè¡Œå±æ€§ãŒã¤ã„ãŸãƒšãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’ç¦æ­¢ã™ã‚‹æ©Ÿæ§‹ã§ã™ã€‚

- [SetProcessDEPPolicy é–¢æ•°](https://learn.microsoft.com/ja-jp/windows/win32/api/winbase/nf-winbase-setprocessdeppolicy)
- ã€Œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã€â†’ã€Œã‚·ã‚¹ãƒ†ãƒ ã€â†’ã€Œã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°è¨­å®šã€ã‚ˆã‚Šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®è¨­å®šã‚’é–‹ã„ã¦å›³ 3.1 ã®ç”»é¢ã§è¨­å®šã™ã‚‹æ–¹æ³•ã€‚ã“ã®ç”»é¢ã§ã¯ã€BCD ã® nx ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å€¤ã®ã†ã¡ã€OptIn ã¨ OptOut ã«å¯¾å¿œã™ã‚‹ã‚ˆã†ãªè¨­å®šã‚’è¡Œã†ã“ã¨ãŒå¯èƒ½ã€‚

### Structured Exception Handling Overwrite Protection
ç¾åœ¨ 64 ãƒ“ãƒƒãƒˆãƒ—ãƒ­ã‚»ã‚¹ã§ã¯é–¢ä¿‚ãªã„ç·©å’Œç­–ã§ã™ãŒä¸€å¿œç´¹ä»‹ã—ã¦ãŠãã¾ã™ã€‚

Structured Exception Handling (SEH) ã¨ã¯ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã®æ©Ÿæ§‹ã§ã™ã€‚

Windows ã§ã¯ `throw std::exception()` ãªã©ã§ä¾‹å¤–ãŒé€å‡ºã•ã‚Œã‚‹ã¨ã‚¹ãƒ¬ãƒƒãƒ‰ç’°å¢ƒãƒ–ãƒ­ãƒƒã‚¯ (TEB) ã®å…ˆé ­ã«ã‚ã‚‹ `NT_TIB` æ§‹é€ ä½“ã® `ExceptionList` ã¨ã„ã†ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã®ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã‹ã‚‰ 1 ã¤ãšã¤ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ãã“ã§ä¾‹å¤–å‡¦ç†ãŒæˆåŠŸã—ãŸã‚‰çµ‚äº†ã—ã€å¤±æ•—ã—ãŸã‚‰æ¬¡ã®ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã«é€²ã¿ã€æœ«å°¾ã«ã‚ã‚‹ ntdll.dll ã® FinalExceptionHandler ã¾ã§ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚ã“ã®æ©Ÿæ§‹ã‚’ SEH ã¨è¨€ã„ã¾ã™ã€‚

```c
struct NT_TIB {
  EXCEPTION_REGISTRATION_RECORD *ExceptionList;
  VOID *StackBase;
  VOID *StackLimit;
  VOID *SubSystemTib;
  union {
    VOID *FiberData;
    ULONG Version;
  };
  VOID *ArbitraryUserPointer;
  NT_TIB *Self;
}

struct EXCEPTION_REGISTRATION_RECORD {
  EXCEPTION_REGISTRATION_RECORD *Next;
  EXCEPTION_DISPOSITION *Handler;
}
```

ãã®ãƒªã‚¹ãƒˆã®ä¸€éƒ¨åˆ†ãŒã‚¹ã‚¿ãƒƒã‚¯ä¸Šã«ã‚ã‚‹ã®ã§ BOF ã‚’ç”¨ã„ã¦ Handler ã‚’æ›¸ãæ›ãˆã¦ä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡ŒãŒã§ãã‚‹ SEH overwrite ã¨ã„ã†æ”»æ’ƒæ‰‹æ®µãŒã‚ã‚Šã¾ã—ãŸã€‚

SafeSEH ã¨ã¯ãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚ã‚‰ã‹ã˜ã‚ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ä¸€è¦§ã‚’ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã«åŸ‹ã‚è¾¼ã‚“ã§ãŠãã€ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©å®Ÿè¡Œæ™‚ã«åŸ‹ã‚è¾¼ã¾ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ç…§åˆã—ã¦ä¸€è‡´ã—ãªã‘ã‚Œã°å®Ÿè¡Œã•ã‚Œãªã„ã¨ã„ã†ä»•çµ„ã¿ã§ã™ã€‚ãŸã ã—æ¤œæŸ»ã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ SafeSEH ãŒç´ã¥ã„ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã‚¹ã‚¿ãƒƒã‚¯é ˜åŸŸä¸Šã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ã§ã™ã€‚ãªã®ã§ SafeSEH ç„¡åŠ¹ãª DLL ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ’ãƒ¼ãƒ—é ˜åŸŸä¸Šã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã¨ã™ã‚Œã°ãƒã‚¤ãƒ‘ã‚¹ã§ãã¾ã™ã€‚

Structured Exception Handling Overwrite Protection (SEHOP) ã¨ã¯ SEH overwrite ã®ç·©å’Œç­–ã§ä»¥ä¸‹ã®ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

- ã™ã¹ã¦ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚¹ã‚¿ãƒƒã‚¯ä¸Šã«ã‚ã‚Šã€align ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ¤œæŸ»ã™ã‚‹ã€‚
- ãƒãƒ³ãƒ‰ãƒ©ãŒã‚¹ã‚¿ãƒƒã‚¯ã‚’æŒ‡ã—ã¦ã„ãªã„ã“ã¨ã‚’æ¤œæŸ»ã™ã‚‹ã€‚
- ãƒªã‚¹ãƒˆæœ«å°¾ãŒ FinalExceptionHandler ã§ã‚ã‚‹ã‹æ¤œæŸ»ã™ã‚‹ã€‚

SEHOP ã®ãƒã‚¤ãƒ‘ã‚¹ã«ã¯ FinalExceptionHandler ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒªãƒ¼ã‚¯ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã¯ [dumpbin ã‚³ãƒãƒ³ãƒ‰](https://learn.microsoft.com/ja-jp/cpp/build/reference/dumpbin-reference) ã§ç¢ºèªã§ãã¾ã™ã€‚

```shell
> dumpbin /LOADCONFIG <exe file>
```

### Control Flow Guard
Control Flow Integrity (CFI) æŠ€è¡“

Control Flow Guard ã¯ call å‘½ä»¤ã®ç›´å‰ã« Guard Control Flow Function Table ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹æ¤œæŸ»ã™ã‚‹å‡¦ç†ã‚’åŠ ãˆã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Š vtable overwrite ãªã©ã®å®Ÿè¡Œã‚¢ãƒ‰ãƒ¬ã‚¹æ›¸ãæ›ãˆã‚’é˜²ãã¾ã™ã€‚

ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã§å¤§ããª ROP ã‚’çµ„ã‚ãªã„ã¨ãã«åˆ¥ã®å ´æ‰€ã«é£›ã°ã—ã¦ãã“ã§çµ„ã‚€ã¨ã„ã† Stack Pivot ã¨ã„ã†æ”»æ’ƒæ‰‹æ³•ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«å¯¾ã—ã¦é‡è¦ãªé–¢æ•°ã®å‘¼ã³å‡ºã—æ™‚ã«ã‚¹ã‚¿ãƒƒã‚¯ã‚’æŒ‡ã—ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã„ã†ç·©å’Œç­–ãŒã‚ã‚Šã¾ã™ã€‚

ret å‘½ä»¤ã§æˆ»ã£ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç›´å‰ã«ã¯ call å‘½ä»¤ãŒã‚ã‚‹ãŒ ROP ã«ãŠã„ã¦ã¯å­˜åœ¨ã—ãªã„ã¨ã„ã†ç™ºæƒ³ã®å…ƒã€CallerCheck / SimExec ã¯é‡è¦ãªé–¢æ•°ã® ret å‘½ä»¤ / é‡è¦ãªé–¢æ•°ã®ç›´å¾Œ 20 å‘½ä»¤å…ˆã¾ã§ã® ret å‘½ä»¤ã§æ¤œæŸ»ã—ã¾ã™ã€‚ã“ã®ãƒã‚¤ãƒ‘ã‚¹ã«ã¯ call å‘½ä»¤ã® Gadget (ä¾‹ãˆã° `call eax; ret`) ã® ret å‘½ä»¤ã‚’ 19 å›å‘¼ã‚“ã å¾Œã« call å‘½ä»¤ã‚’å‘¼ã¹ã°ã‚ˆã„ã§ã™ã€‚

ã•ã‚‰ã« Windows 10 ã‹ã‚‰ CFG Export Suppression ã¨ã„ã† dll ã® export é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã® call, jmp å‘½ä»¤ã®ç›´å‰ã«æ­£è¦ã®æ‰‹æ®µã§å¾—ãŸã‹æ¤œæŸ»ã™ã‚‹å‡¦ç†ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹æ©Ÿæ§‹ãŒåŠ ã‚ã‚Šã¾ã—ãŸã€‚

- GetProcAddress é–¢æ•°
- é™çš„ãƒªãƒ³ã‚¯ (IAT ãªã©)
- dll å†…ã§å¾—ã‚‹

GetProcAddress é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒªãƒ¼ã‚¯ã•ãˆã‚‚é˜²ãŒã‚Œã‚‹ç‚ºã€exploit ã¯ã‹ãªã‚Šé›£ã—ããªã‚Šã¾ã™ã€‚

Return Flow Guard ã¨ã„ã† Shadow Stack ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢å®Ÿè£…ãŒã‚ã£ãŸã®ã§ã™ãŒ race condition ã«ã‚ˆã£ã¦ãƒã‚¤ãƒ‘ã‚¹ã§ãã‚‹ãªã©ã®è¦å› ã§ä¸æ¡ç”¨ã¨ãªã‚Šã¾ã—ãŸã€‚

### Image Isolation
DLL ã‚’ãƒ­ãƒ¼ãƒ‰ã•ã›ã‚‹ã“ã¨ã‚’ DLL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¨ã„ã„ã¾ã™ã€‚

DLL ã®èª­ã¿è¾¼ã¿ã‚’åˆ¶é™ã™ã‚‹ç·©å’Œç­–ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚

| ç·©å’Œç­– | èª¬æ˜ |
| --- | --- |
| Block Remote Images | UNC ãƒ‘ã‚¹ã‚„ WebDAV ãƒ‘ã‚¹ã® DLL ã‚’ç¦æ­¢ |
| Block Low Integrity Images | ä½ã„ Integrity Level (IL) ã‚’æŒã¤ DLL ã‚’ç¦æ­¢ |
| Microsoft-Signed Binaries Only | Microsoft ã® CA ã«ã‚ˆã£ã¦é›»å­è¨¼æ˜ã•ã‚Œã¦ã„ãªã„ DLL ã‚’ç¦æ­¢ |
| Store-Signed Binaries Only | Microsoft Store ã® CA ã«ã‚ˆã£ã¦é›»å­è¨¼æ˜ã•ã‚Œã¦ã„ãªã„ DLL ã‚’ç¦æ­¢ |
| Prefer System32 Images | `${SYSTEM_ROOT}\System32` ã® DLL ã‚’å…ˆã«æ¢ç´¢ã™ã‚‹ |

SetWindowsHookEx é–¢æ•°ã§ DLL ã®é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ãƒƒã‚¯ã«è¿½åŠ ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã™ã‚‹ã“ã¨ã§å®Ÿè¡Œã•ã‚Œ DLL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒæˆåŠŸã—ã¾ã™ã€‚Disable Extension Points ã¨ã¯ ãƒ—ãƒ­ã‚»ã‚¹ãŒæ‹¡å¼µãƒã‚¤ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã‚’ç„¡åŠ¹ã«ã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚

### Address Filter
Export Address Table (EAT) / Import Address Table (IAT) ã¨ã¯ export / import ã™ã‚‹é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿æŒã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ã€‚

DLL ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚‹ã¨ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚‚ç•°ãªã‚‹ç‚ºã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ EAT / IAT ã‚’èª­ã¿å–ã‚‹ã“ã¨ã§ã‚ˆã‚Šå®‰å®šã—ãŸæ”»æ’ƒãŒã§ãã¾ã™ã€‚

Export Address Filter (EAF) / Import Address Filter (IAF) ã¨ã¯ .text é ˜åŸŸä»¥å¤–ã‹ã‚‰ç‰¹å®šã® DLL (kernel32.dll, ntdll.dll, kernelbase.dll) ã® EAT / IAF ã®èª­ã¿å–ã‚Šã‚’åˆ¶é™ã™ã‚‹æ©Ÿæ§‹ã§ã™ã€‚

### ãã®ä»–

| ç·©å’Œç­– | èª¬æ˜ |
| --- | --- |
| Disable Child Process Creation | å­ãƒ—ãƒ­ã‚»ã‚¹ã‚’ä½œæˆã™ã‚‹ã®ã‚’ç¦æ­¢ã™ã‚‹ |
| Disable Win32k system calls (Windows 8) | Win32k.sys ã®å‘¼ã³å‡ºã—ã‚’ç¦æ­¢ã™ã‚‹ |
| Disable Fsctl SystemCalls | |
| Validate handle usage | |
| Validate image dependency integrity | |
| Code integrity guard | |
| Block Untrusted Fonts | Graphics Device Interface (GDI) ã®ãƒ•ã‚©ãƒ³ãƒˆè§£æã«ã‚ˆã‚‹ç‰¹æ¨©æ˜‡æ ¼ `%windir%\Fonts` ä»¥å¤–ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ã—ãªã„ |

## ãƒ„ãƒ¼ãƒ«
ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒ¡ãƒ¢ãƒª

- [x64dbg](https://x64dbg.com/)
- [WinDbg](https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debugger-download-tools)
  - User Kernel ã©ã¡ã‚‰ã‚‚ãƒ‡ãƒãƒƒã‚°ã§ãã‚‹

https://github.com/pinksawtooth/how_to_become_a_malware_analyst

## ã¾ã¨ã‚

## å‚è€ƒæ–‡çŒ®
- ã‚¤ãƒ³ã‚µã‚¤ãƒ‰ Windows
- Windows ã‚«ãƒ¼ãƒãƒ«ãƒ‰ãƒ©ã‚¤ãƒãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°
- [Customize Exploit Protection](https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/customize-exploit-protection)
- [SEH ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒˆã®é˜²å¾¡æ©Ÿèƒ½ã¨ãã® Exploit å¯èƒ½æ€§](https://www.ffri.jp/assets/files/research/research_papers/SEH_Overwrite.pdf)
- [Windowsã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ–°æ©Ÿèƒ½ Control Flow Guardã«ã¤ã„ã¦](https://www.ffri.jp/assets/files/monthly_research/MR201412_Control_Flow_Guard_JPN.pdf)
- [Exploit Protection ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://learn.microsoft.com/ja-jp/microsoft-365/security/defender-endpoint/exploit-protection-reference)
- [è„†å¼±æ€§ç·©å’ŒæŠ€è¡“ã®æœ€å‰ç·š](https://www.ffri.jp/assets/files/research/research_papers/recent_advances_vuln_mitig_jp.pdf)
- [Heap Exploitã®ã“ã‚Œã¾ã§ã¨ç¾çŠ¶](https://www.ffri.jp/assets/files/monthly_research/MR201312_History%20and%20Current%20State%20of%20Heap%20Exploit_JPN.pdf)
