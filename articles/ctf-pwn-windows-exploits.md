---
title: "【CTF 探訪記】Windows Exploits"
emoji: "😸"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["CTF", "pwn", "windows"]
published: false
---

pwn というのはメモリの書き換えや読み取りなどの低レイヤーの脆弱性を用いて意図しない動作を引き起こさせる競技で最もハッキングっぽい分野です。

- [Stack Exploits](https://zenn.dev/anko/articles/ctf-stack-exploits)
- [Heap Exploits](https://zenn.dev/anko/articles/ctf-heap-exploits)

ここまでで Linux において分かったので今回は Windows に対して攻撃してみようと思います。Windows には大量のセキュリティ機構があります。ここでは 64 ビットシステムの Windows Server を対象にします。バージョンに依存することは極力触れずふんわりとした理解を目指します。

## Windows の基本
pdata

- Heap
- Shareable
- Thread Stack
- Mapped File
- Image
- Private Data

構造は Linux と同じです

## Windows Exploit の基本
OS は違えど基本的な構造は同じなので Linux と同じように攻撃できます。

## プロセスの緩和策 (Mitigations)

Windows には Linux に比べて豊富なセキュリティ機構があります。

一般的な緩和策の設定は次の 3 つの方法があります。

- [Set-ProcessMitigationPolicy 関数](https://learn.microsoft.com/ja-jp/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessmitigationpolicy)
- [Set-ProcessMitigation コマンド](https://learn.microsoft.com/en-us/powershell/module/processmitigations/set-processmitigation)
- 「Windows セキュリティ」を起動→「セキュリティの概要」→「アプリとブラウザー コントロール」→「Exploit Protection の設定」

### Address Space Layout Randomization
Address Space Layout Randomization (ASLR)
プロセスが使用する仮想メモリの中の様々な領域のアドレスをランダム化する
プロセスの仮想メモリはページ単位で物理メモリとのマッピングが行われます。
リンク時に

`cl aslr_test.cpp /link /DYNAMICBASE:NO`

- bottomup ASLR
  - VirtualAlloc
- High Entropy ASLR
- ASLR Disallow Stripped Image

https://learn.microsoft.com/en-us/cpp/build/reference/dynamicbase-use-address-space-layout-randomization?view=msvc-170
https://learn.microsoft.com/en-us/cpp/build/reference/highentropyva-support-64-bit-aslr?view=msvc-170


### Data Execution Prevention
Data Execution Prevention (DEP)
スタックやヒープ領域の機械語命令の実行を不可能にする技術

- Arbitary Code Guard
  - 実行属性がついたページを作成することを不可能にする緩和策

上記の対策を行うことにより、Return Oriented Programming によりプロセス内で [VirtualAlloc](https://learn.microsoft.com/ja-jp/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) もしくは [VirtualProtect](https://learn.microsoft.com/ja-jp/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) による実行可能属性のページを作成・そのページへのシェルコード展開・シェルコード実行が不可能になります。




- `cl <cpp file> /link /NXCOMPAT:NO`
- [SetDEPPolicy 関数](https://learn.microsoft.com/ja-jp/windows/win32/api/winbase/nf-winbase-setprocessdeppolicy)

### Structured Exception Handling
Structured Exception Handling (SEH)

safe SEH
SEHOP

[SEH オーバーライトの防御機能とその Exploit 可能性](https://www.ffri.jp/assets/files/research/research_papers/SEH_Overwrite.pdf)

### Control Flow Guard
Return Flow Guard
Stack Pivot
Caller Check
SimExec

### image load
No Remote Images
No Low IL Images

Disable Extension Points

### Address Filter
Export Address Filter
Import Address Filter
Disable Child Process Creation

緩和策名 説明 設定方法
- Disable-Non-System-Fonts
  - ${SYSTEMROOT}\Fonts ディレクトリにインストールされた後にユーザのログオン時に Winlogon によって未登録の任意のファイルが読み込まれるのを防ぐという、信頼されていないフォントをブロックする機能*1。
- Prefer-System32-Images
  - DLL の探索順序を利用して悪意のある DLL をプロセスに読み込ませることを防止するため、ローダーの検索パスを変更し特定の DLL の読み込みを常に${SYSTEM_ROOT}\System32 フォルダ内で検索する機能*2。
- Heap-Terminate-On-Corruption
  - ヒープが破損した場合にプロセスを強制終了することによって、ヒープ破損の例外ハンドラを悪用する攻撃や時々ヒープの破損を起こす程度の Exploit を防御するという、ヒープの整合性を検証する機能*3。HeapSetInformation 関数
- Filter-Win32k-System-Calls
- Raise-Exception-on-Invalid-Handle

## 回避
### SEH overwrite

## ツール
プロセスのメモリ

- [x64dbg](https://x64dbg.com/)
- [WinDbg](https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debugger-download-tools)
  - User Kernel どちらもデバッグできる

## まとめ
