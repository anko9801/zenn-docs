---
title: "ã€CTF æ¢è¨ªè¨˜ã€‘Heap Exploit"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CTF", "pwn"]
published: true
---

ãƒ’ãƒ¼ãƒ—é ˜åŸŸã‚’æ”»æ’ƒã—ã¦ã¿ã‚‹è©±ã€‚ã“ã“ã§ã¯ 64bit ã‚·ã‚¹ãƒ†ãƒ ã‚’å‰æã¨ã—ã¾ã™ã€‚

## malloc / free ã®ä»•çµ„ã¿
ã“ã®ãƒ’ãƒ¼ãƒ—é ˜åŸŸã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã‚ã‚‹ malloc / free é–¢æ•°ã®å‡¦ç†ã‚’ç†è§£ã™ã‚‹ã®ãŒ Heap Exploit ã®å¤§äº‹ãªå¤§ããªä¸€æ­©ã¨ãªã‚Šã¾ã™ã€‚

ã¨ã‚Šã‚ãˆãšã“ã®ä¼èª¬ã®å‹•ç”»ã‚’è¦‹ã¦ [**æœ€æ–°ã® malloc.c ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰**](https://codebrowser.dev/glibc/glibc/malloc/malloc.c.html) ã‚’ç”¨æ„ã—ã¾ã—ã‚‡ã†ã€‚

https://www.youtube.com/watch?v=0-vWT-t0UHg

ã“ã‚Œã‚’å…ƒã«ç†è§£ã‚’æ·±ã‚ã¦ã„ãã¾ã™ã€‚

## ãŠãŠã–ã£ã±ãªç†è§£

### é–‹ç™ºè€…è¦–ç‚¹

`malloc` é–¢æ•°ã§ãƒ’ãƒ¼ãƒ—é ˜åŸŸã«ã‚ã‚‹ãƒ¡ãƒ¢ãƒªã‚’ç¢ºä¿ã—ã¦ãã®ãƒã‚¤ãƒ³ã‚¿ã‚’è¿”ã™ã€‚ `free` é–¢æ•°ã¯ãã®ãƒã‚¤ãƒ³ã‚¿ã®ãƒ¡ãƒ¢ãƒªã‚’é–‹æ”¾ã—ã¦ãã‚Œã‚‹ã€‚

```c
void *malloc(size_t size);
void free(void *ptr);
```

### ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼è¦–ç‚¹

ãƒ’ãƒ¼ãƒ—é ˜åŸŸã§ã¯ãƒãƒ£ãƒ³ã‚¯ã¨å‘¼ã°ã‚Œã‚‹æ§‹é€ ä½“ãŒå¤§é‡ã«ã‚ã‚Šã€ãã‚Œãã‚Œä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒãƒ£ãƒ³ã‚¯ã ã£ãŸã‚Šã€è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã ã£ãŸã‚Šã—ã¾ã™ã€‚`malloc` ã™ã‚‹ã¨è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®ä¸­ã‹ã‚‰ãƒãƒ£ãƒ³ã‚¯ãŒåˆ‡ã‚Šå‡ºã•ã‚Œã€`free` ã™ã‚‹ã¨ãƒãƒ£ãƒ³ã‚¯ã«è§£æ”¾ã•ã‚ŒãŸã“ã¨ã‚’æ›¸ã„ã¦ãŠãã¾ã™ã€‚

å…·ä½“çš„ã«ãƒãƒ£ãƒ³ã‚¯ã¯æ¬¡ã®ã‚ˆã†ãªæ§‹é€ ã¨ãªã£ã¦ã„ã¾ã™ã€‚

- ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã¯ 0x20 ä»¥ä¸Šã® 0x10 ã®å€æ•°ã¨ãªã‚‹ã€‚
- ç¢ºä¿ã—ãŸãƒ‡ãƒ¼ã‚¿ã®ç›´å‰ã«ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãªã©ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒæ›¸ãè¾¼ã¾ã‚Œã¦ãŠã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®æœ«å°¾ 8 ãƒã‚¤ãƒˆã¯æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã¨è¢«ã£ã¦ã„ã‚‹ã€‚
- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ä¸€ã¤ `size` ã®ä¸‹ä½ 3bit ã¯ãƒ•ãƒ©ã‚°ã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹ã€‚
  - `A: non_main_arena`  `main_arena` ã§ã‚ã‚‹ã‹ã©ã†ã‹
  - `M: is_mmaped`  ãƒ¡ãƒ¢ãƒªãŒ mmap ã§ç¢ºä¿ã•ã‚ŒãŸã‹
  - `P: prev_inuse`  å‰ã®ãƒãƒ£ãƒ³ã‚¯ãŒä½¿ç”¨ä¸­ã‹ã€‚ä½¿ç”¨ä¸­ã§ãªã‘ã‚Œã° `prev_size` ã«å‰ã®ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒæ›¸ãè¾¼ã¾ã‚Œã¦ã„ã‚‹ã€‚

![](/images/pwn/chunk.png)

`malloc` ã§è¿”ã£ã¦ãã‚‹ãƒã‚¤ãƒ³ã‚¿ãŒã“ã®ãƒãƒ£ãƒ³ã‚¯å†…ã®ãƒ‡ãƒ¼ã‚¿ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã¨ãªã‚Šã¾ã™ã€‚ã¾ãŸ `free` ã™ã‚‹ã¨ãã«é«˜é€Ÿã«å‡¦ç†ã™ã‚‹ãŸã‚ã«è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®ä¸€è¦§ free list ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã«é–¢ã—ã¦ç”¨èªãŒã‚ˆãå‡ºã¦ãã‚‹ã®ã§ã“ã“ã§ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚

| ç”¨èª | èª¬æ˜ |
| --- | --- |
| Remaindering | è¦æ±‚ã®ã‚ã£ãŸã‚µã‚¤ã‚ºã¨åˆè‡´ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æ—¢å­˜ã®ãƒãƒ£ãƒ³ã‚¯ã‚’è¦æ±‚ã‚µã‚¤ã‚ºã§åˆ†å‰²ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚æ®‹ã‚Šã®é ˜åŸŸã¯æ–°ãŸãªãƒãƒ£ãƒ³ã‚¯ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã€ãã®å†…æœ€æ–°ã®ã‚‚ã®ã¯ã‚¢ãƒªãƒ¼ãƒŠã® `last_remainder` ã«æ ¼ç´ã•ã‚Œã‚‹ã€‚ |
| Exhausting | è¦æ±‚ã®ã‚ã£ãŸã‚µã‚¤ã‚º `N` ã¨åˆè‡´ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãšã€ã‚µã‚¤ã‚º `N + 0x10` ã®ãƒãƒ£ãƒ³ã‚¯ãŒã‚ã‚‹å ´åˆã€åˆ†å‰²ã›ãšã«ãã®ã¾ã¾ä½¿ã†ã“ã¨ã€‚ |
| Consolidation | è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ãŒéš£ã‚Šåˆã£ã¦ã„ãŸã¨ãã« 2 ã¤ã®ãƒãƒ£ãƒ³ã‚¯ã‚’çµ±åˆã™ã‚‹ã“ã¨ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é˜²ãã€‚ |
| ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ | `malloc` `free` ã‚’ç¹°ã‚Šè¿”ã™ã“ã¨ã§æœªä½¿ç”¨ã®ãƒãƒ£ãƒ³ã‚¯ãŒãƒãƒ©ãƒãƒ©ã«ãªã£ã¦ã—ã¾ã†ã“ã¨ã€‚ |

ã“ã® free list ãŒ Heap Exploit ã®ä¸­ã§é‡è¦ãªã®ã§æ¬¡ã§ã¯ã“ã®æ§‹é€ ã¨å…·ä½“çš„ãªå‹•ä½œã‚’è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

## ãƒãƒ£ãƒ³ã‚¯ã®ç®¡ç†

free list ã®æ­£ä½“ã¯ bins ã¨å‘¼ã°ã‚Œã‚‹ãƒªã‚¹ãƒˆç¾¤ã§ã™ã€‚bins ã¯ã„ãã¤ã‹ã®ç¨®é¡ãŒã‚ã£ã¦ã‚µã‚¤ã‚ºã«ã‚ˆã£ã¦ç®¡ç†ã®ä»•æ–¹ã‚’å¤‰ãˆã‚‹ã“ã¨ã§æœ€é©åŒ–ã—ã¦ã„ã¾ã™ã€‚

| bins ã®ç¨®é¡ | ã‚µã‚¤ã‚º | èª¬æ˜ | ãƒ‡ãƒ¼ã‚¿æ§‹é€  |
| --- | --- | --- | --- |
| tcache bins | 0x20 ~ 0x410 | æœ€åˆã«å…¥ã‚Œã‚‰ã‚Œã‚‹ just-fit ãª bin | å˜æ–¹å‘ãƒªã‚¹ãƒˆ |
| fastbins | 0x20 ~ 0x80 | tcache ãŒæº€æ¯ã«ãªã£ãŸã‚‰å…¥ã‚Œã‚‰ã‚Œã‚‹ just-fit ãª bin | å˜æ–¹å‘ãƒªã‚¹ãƒˆ |
| unsortedbin | 0x20 ~ | tcache, fastbins ã§å–ã‚Šæ‰±ãˆãªã„ã¨ãã‚„ fastbins consolidation ã§å…¥ã‚Œã‚‰ã‚Œã‚‹ bin | åŒæ–¹å‘ãƒªã‚¹ãƒˆ |
| smallbins | 0x20 ~ 0x3f0 | unsortedbin ã‹ã‚‰æ¥ã‚‹å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ just-fit ãª bin | åŒæ–¹å‘ãƒªã‚¹ãƒˆ |
| largebins | 0x400 ~ | unsortedbin ã‹ã‚‰æ¥ã‚‹å¤§ããªãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ bin | åŒæ–¹å‘ãƒªã‚¹ãƒˆ + ã‚¹ã‚­ãƒƒãƒ—ãƒªã‚¹ãƒˆ |

ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ 2 ã¤ã‚ã‚Šã€ãã‚Œãã‚Œã®æŒ¿å…¥ (link) ã‚„å‰Šé™¤ (unlink) ã®å‡¦ç†ã¯ç†è§£ã—ã¦ã„ã‚‹å‰æã§è©±ã‚’é€²ã‚ã¾ã™ã€‚

- å˜æ–¹å‘ãƒªã‚¹ãƒˆã¯å˜æ–¹å‘ã«ã—ã‹ç§»å‹•ã§ããªã„ç¹‹ãå¤‰ãˆãŒç°¡å˜ãªé«˜é€Ÿãªãƒªã‚¹ãƒˆã§ã™ã€‚LIFO ã§å…ˆé ­ã¯ arena ã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒãƒ£ãƒ³ã‚¯ã®ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã®å…ˆé ­ 8 ãƒã‚¤ãƒˆã¯ forward pointer (fd) ã¨ã—ã¦ä½¿ã‚ã‚Œã€æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã®ãƒã‚¤ãƒ³ã‚¿ãƒ¼ãŒæ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚æœ«å°¾ã® fd ã¯ NULL ã«ãªã‚Šã¾ã™ã€‚
- åŒæ–¹å‘ãƒªã‚¹ãƒˆã¯åŒæ–¹å‘ç§»å‹•ã§ãã‚‹å††å½¢ã®ãƒªã‚¹ãƒˆã§ã™ã€‚FIFO ã§å…ˆé ­ã¨æœ«å°¾ã¯ arena ã§ç®¡ç†ã•ã‚Œã¦ã„ã¦ã€ãƒãƒ£ãƒ³ã‚¯ã®ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã®å…ˆé ­ 16 ãƒã‚¤ãƒˆã¯ forward pointer (fd), back pointer (bk) ã¨ã—ã¦ä½¿ã‚ã‚Œã¾ã™ã€‚


### tcache bins

glibc v2.26 ä»¥é™ã«è¿½åŠ ã•ã‚ŒãŸ binã€‚å‚ç…§å±€æ‰€æ€§ã‚’é«˜ã‚ã‚‹ç‚ºã« `malloc / free` ã§ä¸€ç•ªæœ€åˆã«å‡¦ç†ã•ã‚Œã‚‹ã®ãŒ tcache bins ã§ã™ã€‚tcache bins ã¯ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x20 ã‹ã‚‰ 0x410 ã¾ã§ã® 64 ç¨®é¡ã® tcache bin ã‚’æŒã¡ã€ãã‚Œãã‚Œå˜æ–¹å‘ãƒªã‚¹ãƒˆã¨ãªã£ã¦ã„ã‚‹ã€‚ãƒªã‚¹ãƒˆã®é•·ã•ã¯ 7 å€‹ã«åˆ¶é™ã•ã‚Œã¦ã„ã¦ tcache ãŒæº€æ¯ã«ãªã‚‹ã¨ä»–ã® bins ã«ç§»ã•ã‚Œã‚‹ã€‚ã‚µã‚¤ã‚ºã”ã¨ã«åˆ†ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ just-fit ã§è¿”ã›ã¾ã™ã€‚

tcache bins ã®å®Ÿä½“ã¯ `tcache_perthread_struct` æ§‹é€ ä½“ã§ã™ã€‚ `entries` ã§å„ãƒªã‚¹ãƒˆã® HEAD ã®ãƒãƒ£ãƒ³ã‚¯ã«ç¹‹ã’ã¦ã€ `counts` ã§ãƒªã‚¹ãƒˆã®é•·ã•ã‚’ç®¡ç†ã—ã€7 å€‹ã«ãªã£ãŸã‚‰å—ã‘ä»˜ã‘ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚ãƒãƒ£ãƒ³ã‚¯ãŒ tcache bin ã«å…¥ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã« `tcache_entry` æ§‹é€ ä½“ãŒ overlap ã•ã‚Œã¦ãƒªã‚¹ãƒˆã«å…¥ã‚Šã¾ã™ã€‚

```c
typedef struct tcache_entry
{
 struct tcache_entry *next;              // æ¬¡ã® tcache_entry ã¸ã®ãƒã‚¤ãƒ³ã‚¿
 struct tcache_perthread_struct *key;    // è¦ªã® tcache_perthread_struct ã‚’æŒ‡ã— double free ã‚’æ¤œçŸ¥ã™ã‚‹ã€‚
} tcache_entry;

typedef struct tcache_perthread_struct
{
 uint16_t counts[TCACHE_MAX_BINS];       // å„ tcache bin ã®é•·ã•ã®ä¸€è¦§
 tcache_entry *entries[TCACHE_MAX_BINS]; // å„ tcache bin ã®æœ€åˆã® tcache ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã®ä¸€è¦§
} tcache_perthread_struct;
```

![](/images/pwn/tcache.png)

### fastbins

glibc v2.3 ã‹ã‚‰ã‚ã‚‹å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ binã€‚fastbins ã¯ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x20 ã‹ã‚‰ 0x80 ã¾ã§ 7 ç¨®é¡ã® fastbin ã‚’æŒã¡ã€å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã¯é »ç¹ã«ç¢ºä¿ãƒ»é–‹æ”¾ãŒèµ·ãã‚„ã™ã„ã®ã§ãã‚Œãã‚Œå˜æ–¹å‘ãƒªã‚¹ãƒˆã¨ãªã£ã¦ã„ã‚‹ã€‚

fastbins ã®å®Ÿä½“ã¯ `arena` ã«ã‚ã‚‹ `fastbinsY` ã§ã™ã€‚`NFASTBINS == 10` ã‹ã¤ `global_max_fast == 0x80`

```c
struct malloc_state
{
  ...
  int have_fastchunks;
  mfastbinptr fastbinsY[NFASTBINS];
  ...
};
```

![](/images/pwn/fastbin.png)

### unsortedbin

tcache ã‚„ fastbins ã®ãŠã“ã¼ã‚Œã‚„ fastbins ã® consolidation ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã‚’ unsortedbin ãŒç®¡ç†ã—ã¾ã™ã€‚unsortedbin ã¯ 1 ã¤ã®åŒæ–¹å‘ãƒªã‚¹ãƒˆã¨ãªã£ã¦ã„ã¾ã™ã€‚unsortedbin ã§ã‚½ãƒ¼ãƒˆãŒèµ·ã“ã‚‹ã¨ smallbins ã‹ largebins ã«ç¹‹ãŒã‚Œã‚‹ã€‚

unsortedbin ã®å…ˆé ­ãƒ»æœ«å°¾ã¯ `bin_at(1)` ã¤ã¾ã‚Š `arena` ã® `bins[0]` ã¨ `bins[1]` ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚

unsortedbin ã® `fd` ã¯ `main_arena.top` ã‚’æŒ‡ã™ã€‚

```c
/* The otherwise unindexable 1-bin is used to hold unsorted chunks. */
#define unsorted_chunks(M)          (bin_at (M, 1))
```

### smallbins

unsortedbin ã«å…¥ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã§å°ã•ã„ãƒãƒ£ãƒ³ã‚¯ã¯ smallbins ã«ç¹‹ãŒã‚Œã¾ã™ã€‚smallbins ã¯ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x20 ã‹ã‚‰ 0x3f0 ã¾ã§ 62 ç¨®é¡ã® smallbin ã‚’æŒã¡ã€ãã‚Œãã‚ŒåŒæ–¹å‘ãƒªã‚¹ãƒˆã¨ãªã£ã¦ã„ã‚‹ã€‚

smallbins ã®å…ˆé ­ãƒ»æœ«å°¾ã¯ `bin_at(2)` ã‹ã‚‰ `bin_at(63)` ã¾ã§ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚

```c
#define SMALLBIN_WIDTH    MALLOC_ALIGNMENT
#define SMALLBIN_CORRECTION (MALLOC_ALIGNMENT > CHUNK_HDR_SZ)

#define smallbin_index(sz) \
  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) >> 4) : (((unsigned) (sz)) >> 3))\
   + SMALLBIN_CORRECTION)
```

![](/images/pwn/smallbin.png)

### largebins

å¤§ããªã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ã‚‚ 16 ãƒã‚¤ãƒˆã”ã¨ã«ç®¡ç†ã™ã‚‹ã®ã¯ç¾å®Ÿçš„ã§ã¯ãªã„ã€‚ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚‹ã«ã¤ã‚Œã¦å¹…ã‚‚æŒ‡æ•°çš„ã«å¤§ããã™ã‚‹ã“ã¨ã§ãƒªã‚¹ãƒˆã®æ•°ã‚’å¹³å‡åŒ–ã—ã€æœ€æ‚ªè¨ˆç®—é‡ã‚’æ¸›ã‚‰ã™ã€‚largebins ã¯ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x400 ~ 0x430, 0x440 ~ 0x470, â€¦, 0x1000000 ~ 0x1fffff0, 0x2000000 ~ ã® 63 ç¨®é¡ã® largebin ã‚’æŒã¡ã€ãã‚Œãã‚Œã‚µã‚¤ã‚ºã«å¿œã˜ã¦é †åºç«‹ã¦ãŸåŒæ–¹å‘ãƒªã‚¹ãƒˆã¨ãªã£ã¦ã„ã‚‹ã€‚ã“ã‚Œã¯åŒæ–¹å‘ãƒªã‚¹ãƒˆã®ãƒ¡ãƒ³ãƒã«åŠ ãˆã¦ `fd_nextsize` `bk_nextsize` ãŒã‚ã‚Šã€ãã‚Œãã‚Œãƒãƒ£ãƒ³ã‚¯ã®å¹…ã®ä¸­ã§æ¬¡ã«å¤§ããªãƒãƒ£ãƒ³ã‚¯ã¨æ¬¡ã«å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãŒæ ¼ç´ã•ã‚Œã‚‹ã€‚

largebins ã®å…ˆé ­ãƒ»æœ«å°¾ã¯ `bin_at(64)` ã‹ã‚‰ `bin_at(126)` ã¾ã§ã«æ ¼ç´ã•ã‚Œã‚‹ã€‚

largebins ã‹ã‚‰ç¢ºä¿ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªã¯ `last_remainder` ã¯ã‚»ãƒƒãƒˆã•ã‚Œãªã„ã€‚

```c
#define largebin_index_64(sz)                                                \
  (((((unsigned long) (sz)) >> 6) <= 48) ?  48 + (((unsigned long) (sz)) >> 6) :\
   ((((unsigned long) (sz)) >> 9) <= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\
   ((((unsigned long) (sz)) >> 12) <= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\
   ((((unsigned long) (sz)) >> 15) <= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\
   ((((unsigned long) (sz)) >> 18) <= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\
   126)

#define largebin_index(sz) \
  (SIZE_SZ == 8 ? largebin_index_64 (sz)                                     \
   : MALLOC_ALIGNMENT == 16 ? largebin_index_32_big (sz)                     \
   : largebin_index_32 (sz))
```

![](/images/pwn/largebin.png)

## ã‚¢ãƒªãƒ¼ãƒŠ

ã“ã‚Œã‚‰ã® bins ã¯ã‚¢ãƒªãƒ¼ãƒŠã¨ã„ã†æ©Ÿæ§‹ã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã¾ã™ã€‚ã‚¢ãƒªãƒ¼ãƒŠã¯å˜æ–¹å‘ãƒªã‚¹ãƒˆã§ã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã«å…ˆé ­ã‚’ `main_arena` ã¨ã„ã†å¤‰æ•°ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã€‚

ã‚¢ãƒªãƒ¼ãƒŠã¯ `malloc_state` æ§‹é€ ä½“ã€ãã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ `malloc_par` æ§‹é€ ä½“ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

```c
/* addressing -- note that bin_at(0) does not exist */
#define bin_at(m, i) \
  (mbinptr) (((char *) &((m)->bins[((i) - 1) * 2]))			      \
             - offsetof (struct malloc_chunk, fd))

// arena ã®å®Ÿä½“
struct malloc_state
{
  __libc_lock_define (, mutex);     // arena ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ serialize ã™ã‚‹
  int flags;                        // ãƒ’ãƒ¼ãƒ—ãƒ¡ãƒ¢ãƒªãŒé€£ç¶šã§ã‚ã‚‹ã‹

  int have_fastchunks;              // fastbins ãŒç©ºã§ã¯ãªã„ã“ã¨ã‚’è¡¨ã™çœŸå½å€¤
  mfastbinptr fastbinsY[NFASTBINS]; // fastbins

  mchunkptr top;

  mchunkptr last_remainder;

  mchunkptr bins[NBINS * 2 - 2];    // unsortedbin smallbins largebins ã®å…ˆé ­ãƒ»æœ«å°¾
  unsigned int binmap[BINMAPSIZE];  // smallbins largebinsã§ç´ æ—©ãè¦‹ã¤ã‘ã‚‹ç‚ºã«ä½¿ã‚ã‚Œã‚‹ãƒ“ãƒƒãƒˆãƒ™ã‚¯ã‚¿

  struct malloc_state *next;        // arena ã®å˜æ–¹å‘ãƒªã‚¹ãƒˆ
  struct malloc_state *next_free;   // ä½¿ã‚ã‚Œã¦ã„ãªã„ arena ã®å˜æ–¹å‘ãƒªã‚¹ãƒˆ

  INTERNAL_SIZE_T attached_threads; // arena ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã®æ•°

  INTERNAL_SIZE_T system_mem;       // arena ã«ã‚ˆã£ã¦ç¾åœ¨ç¢ºä¿ã•ã‚Œã¦ã„ã‚‹æ›¸ãè¾¼ã¿å¯èƒ½ãªãƒ¡ãƒ¢ãƒªã®åˆè¨ˆå€¤
  INTERNAL_SIZE_T max_system_mem;   // system_mem ã®æœ€å¤§å€¤
};
```

### malloc
`malloc()` -> `_libc__malloc()` -> `_int_malloc()`
`_libc__malloc()` ã§ã¯ tcache ã‚’ç¢ºèªã—ã€ãªã‘ã‚Œã° `_int_malloc()` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
smallbin ã®ç¯„å›²ã®ã¨ã
fastbin â†’ smallbin â†’ unsortedbin â†’ ä¸Šä½ã® bin â†’ top â†’ fastbin consolidate â†’ unsortedbin
largebin ã®ç¯„å›²ã®ã¨ã
fastbin consolidate â†’ unsortedbin â†’ largebin â†’ ä¸Šä½ã® bin â†’ top â†’ sysmalloc()
### free


### malloc hooks

ã“ã‚Œã‚‰ã®ãƒ•ãƒƒã‚¯ã¯ heap exploit ã«ãŠã„ã¦éå¸¸ã«æœ‰ç”¨ã§ã—ãŸãŒ glibc v2.34 ä»¥é™ã§å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚

- `__malloc_hook` / `__free_hook` / `__realloc_hook`
- `__after_morecore_hook`
- `__malloc_initialize_hook`
- `__memalign_hook`
- `_dl_open_hook`

## ãƒ’ãƒ¼ãƒ—é ˜åŸŸã§ã®æ›¸ãæ›ãˆ

ãƒ’ãƒ¼ãƒ—é ˜åŸŸã«ãŠã„ã¦ã¯ `fd` `bk` ã®æ›¸ãæ›ãˆãŒç›®æ¨™ã§ã™ã€‚ã“ã‚ŒãŒã§ãã‚Œã° free list ã®ãƒªã‚¹ãƒˆæ§‹é€ ã‚’å£Šã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ malloc / free ã‚’ç¹°ã‚Šè¿”ã™ã¨ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸æ›¸ãæ›ãˆãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### Use After Free
free é–¢æ•°ãŒå‘¼ã°ã‚ŒãŸå¾Œã§ã‚‚èª­ã¿æ›¸ããŒå‡ºæ¥ã¦ã—ã¾ã†è„†å¼±æ€§ã€‚ã“ã‚ŒãŒä¸€ç•ªæ‰‹ã£å–ã‚Šæ—©ã `fd` `bk` ã®èª­ã¿æ›¸ããŒå‡ºæ¥ã¾ã™ã€‚

è§£æ”¾ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’ dangling pointer (ã¶ã‚‰ã•ãŒã£ãŸãƒã‚¤ãƒ³ã‚¿) ã¨è¨€ã„ã¾ã™ã€‚

```shell
pwndbg> vmmap
pwndbg> heap
pwndbg> arena
pwndbg> bins
pwndbg> fastbins
pwndbg> tcachebins
pwndbg> unsortedbin
pwndbg> smallbins
pwndbg> largebins
pwndbg> tcache
pwndbg> top_chunk
pwndbg> try_free <address>
pwndbg> malloc_chunk <address>
```

### Heap based Buffer Overflow
Heap ä¸Šã§ã® BOF ã§ã™ã€‚è¤‡æ•°å› malloc ã™ã‚‹ã¨å‚ç…§å±…æ‰€æ€§ãªã©ã®ç†ç”±ã‹ã‚‰é€£ç¶šã«ä¸¦ã¶ã“ã¨ãŒå¤šã„ã§ã™ã€‚ãã†ã™ã‚‹ã¨ä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒãƒ£ãƒ³ã‚¯ã‹ã‚‰ BOF ã—ã¦åˆ¥ã®ãƒãƒ£ãƒ³ã‚¯ã®æ›¸ãæ›ãˆãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€å¤‰æ•°ã®æ›¸ãæ›ãˆã‚„ `fd` `bk` ã®æ›¸ãæ›ãˆãŒå‡ºæ¥ã¾ã™ã€‚

### double free

Use After Free ã‚„ HBOF ãŒå‡ºæ¥ãªãã¨ã‚‚ double free ã•ã›ã‚Œã°ãƒªã‚¹ãƒˆãŒãƒ«ãƒ¼ãƒ—ã™ã‚‹ã‹ã‚‰é©åˆ‡ã« malloc ã—ãŸé ˜åŸŸã§ã‚‚ fd ã«æ„å›³ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãè¾¼ã‚ã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

glibc 2.28 ä»¥å‰ã® tcache ã§ã¯ double free ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ãŒã€glibc 2.29 ä»¥é™ã§ã¯ `key` ã¨ã„ã† `tcache_perthread_struct` æ§‹é€ ä½“ã‚’æŒ‡ã™ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚Œã€double free æ¤œæŸ»ãŒå…¥ã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

## ãƒ’ãƒ¼ãƒ—é ˜åŸŸã§ã®æ”»æ’ƒæ–¹æ³•

### tcache poisoning

tcache ã«å…¥ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã® next ã‚’æ›¸ãæ›ãˆã¦ malloc ã™ã‚‹ã“ã¨ã§ AAW ã§ãã‚‹è„†å¼±æ€§ã€‚æ³¨æ„ã™ã‚‹ã¹ãã¯ tcache ãŒ LIFO ãªãƒªã‚¹ãƒˆãªç‚ºã« malloc free ã‚’ç¹°ã‚Šè¿”ã•ãªã‘ã‚Œã°ãªã‚‰ãªã„
tcache poisoning ã—ã¦ `__free_hook` ã‚’æ›¸ãæ›ãˆã‚‹ã€‚
åŒã˜é ˜åŸŸã«æ‚ªæ„ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºä¿ã—ã¦åˆ©ç”¨ã•ã›ã‚‹äº‹ã§ã€é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã‚’æ›¸ãæ›ãˆã‚‹ã€‚

[SECCON Beginners CTF 2020 [Beginners Heap] Writeup &åˆå¿ƒè€…å‘ã‘è§£èª¬ - Qiita](https://qiita.com/hanya1995/items/c29a89737bbd521e67f2)
[SECCON Beginners CTF 2019 - Babyheap - HackMD](https://hackmd.io/@Xornet/H1hYUUR2I)

### fastbins attack

### unsortedbin attack

- [Security Fest 2019 - Baby5 (Unsorted Bin) - HackMD](https://hackmd.io/@Xornet/rycqVwQpL)
- [næ—¥1CTFãƒãƒ£ãƒ¬ãƒ³ã‚¸ - HackMD](https://hackmd.io/@Xornet/BkemeSAhU)

### House of Prime

fastbins ã®æœ€å¤§ã‚µã‚¤ã‚ºå¤‰æ•°ã‚’ç ´æã•ã›ã¦ã€ç‰¹å®šã®çŠ¶æ³ä¸‹ã§æ”»æ’ƒè€…ãŒ arena æ§‹é€ ä½“ã‚’ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯ã—ã€ãã®çµæœä»»æ„ã®ãƒ¡ãƒ¢ãƒªãƒãƒ£ãƒ³ã‚¯ã‚’è¿”ã™ã‹ã€
ã‚¢ã‚¤ãƒ‡ã‚¢
2å›ã® `free()` ã€1å›ã® `malloc()` ã®å‘¼ã³å‡ºã—ãŒã§ãã‚‹ã¨ã

## ã¾ã¨ã‚
Heap Exploit ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚ä»Šå›ã¯ Linux ã®ã¿ã®ç´¹ä»‹ã«ãªã‚Šã¾ã—ãŸãŒ Microsoft ã® mimalloc ã¨ã‹ã‚‚ã‚ã‚Šã¾ã™ã€‚
https://qiita.com/methane/items/e88901b7392c10cee2c9

ã“ã‚ŒãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚Œã° pwn ä¸­ç´šè€…ã¨è¨€ãˆãã†ã§ã™ã€‚

## å‚è€ƒè³‡æ–™
- https://github.com/shellphish/how2heap
- [Overview of GLIBC heap exploitation techniques](https://0x434b.dev/overview-of-glibc-heap-exploitation-techniques/)
- [ã€LCR 1.1ã€‘LibcCodeReading: mallocç·¨[2]=fastbinsãƒ»smallbins - newbie dive into binary (hatenablog.com)](https://smallkirby.hatenablog.com/entry/2019/09/23/001554)
