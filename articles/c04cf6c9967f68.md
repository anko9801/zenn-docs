---
title: "ã€CTF æ¢è¨ªè¨˜ã€‘Heap Exploit"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CTF", "pwn"]
published: false
---

ãƒ¡ãƒ¢ãƒªé ˜åŸŸã®ä¸€ã¤ã€ãƒ’ãƒ¼ãƒ—é ˜åŸŸã§æ”»æ’ƒã—ã¦ã¿ã‚‹è©±

64bit ã‚·ã‚¹ãƒ†ãƒ ã‚’å‰æã¨ã—ã¾ã™ã€‚

# malloc / free ã®ä»•çµ„ã¿

ã¨ã‚Šã‚ãˆãšã“ã®å‹•ç”»ã¿ã¨ã‘ï¼

https://www.youtube.com/watch?v=0-vWT-t0UHg

ãã‚Œã¨æœ€æ–°ã® malloc.c ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚ï¼

https://codebrowser.dev/glibc/glibc/malloc/malloc.c.html

ã“ã‚Œã‚‰ã‚’å…ƒã«ç†è§£ã‚’æ·±ã‚ã¦ã„ãã¾ã™ã€‚

## ãŠãŠã–ã£ã±ãªç†è§£

### é–‹ç™ºè€…è¦–ç‚¹

`malloc` é–¢æ•°ã§ãƒ’ãƒ¼ãƒ—é ˜åŸŸã«ã‚ã‚‹ãƒ¡ãƒ¢ãƒªã‚’ç¢ºä¿ã—ã¦ `free` é–¢æ•°ã§ãƒ¡ãƒ¢ãƒªã‚’é–‹æ”¾ã™ã‚‹ã€‚

```c
void *malloc(size_t size);
void free(void *ptr);
```

### ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼è¦–ç‚¹

ãƒ’ãƒ¼ãƒ—é ˜åŸŸå†…ã§ç©ºã„ã¦ã„ã‚‹ãƒãƒ£ãƒ³ã‚¯ã®ä¸€è¦§ (free list) ã‚’ç®¡ç†ã—ã¦ã„ã‚‹ã€‚

| malloc é–¢æ•° | ãƒ’ãƒ¼ãƒ—é ˜åŸŸã® free list ã‹ã‚‰ãƒãƒ£ãƒ³ã‚¯ã‚’åˆ‡ã‚Šå‡ºã—ã€ãƒãƒ£ãƒ³ã‚¯å†…ã®ãƒ‡ãƒ¼ã‚¿ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’è¿”ã™ã€‚ |
| --- | --- |
| free é–¢æ•° | ãƒãƒ£ãƒ³ã‚¯ã« free ã•ã‚ŒãŸã¨ã„ã†ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã¦ free list ã«æŒ¿å…¥ã™ã‚‹ã€‚ |

ã“ã®ãƒãƒ£ãƒ³ã‚¯ã®ç®¡ç†ã®ä»•æ–¹ã‚’ç†è§£ã™ã‚‹ã®ãŒ Heap Exploit ã®å¤§äº‹ãªå¤§ããªä¸€æ­©ã¨ãªã‚Šã¾ã™ã€‚

`malloc` ã«ã‚ˆã£ã¦ä½œã‚‰ã‚Œã‚‹ãƒãƒ£ãƒ³ã‚¯ã¯æ¬¡ã®ã‚ˆã†ãªæ§‹é€ ã¨ãªã£ã¦ã„ã¾ã™ã€‚

![chunk.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/cc4e6803-0625-41e0-b5ea-421d971679de/1fb9eab1-94ea-4fc8-b056-9f62aa99e936/chunk.png)

ãƒãƒ£ãƒ³ã‚¯ã®æ€§è³ª

- 0x20 ã‹ã‚‰ 0x10 ãšã¤ã®ã‚µã‚¤ã‚ºã—ã‹ä½œã‚Œãªã„ã€‚
- ç¢ºä¿ã—ãŸãƒ‡ãƒ¼ã‚¿ã®ç›´å‰ã« 16 ãƒã‚¤ãƒˆã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®æœ«å°¾ 8 ãƒã‚¤ãƒˆã¯æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã¨è¢«ã£ã¦ã„ã‚‹ã€‚
- `prev_size` ã¯ 1 ã¤å‰ã®ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚º (free ã•ã‚Œã¦ã„ãŸã¨ãã ã‘)
- `size` ã¯ã“ã®ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚º
    - ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºã¯ 16 ã®å€æ•°ãªã®ã§å¿…ãšä¸‹ä½ 3bit ã¯ 0 ã§ã‚ã‚‹ã“ã¨ã‚’åˆ©ç”¨ã—ã¦ `size` ã®ä¸‹ä½ 3bit ã‚’ãƒ•ãƒ©ã‚°ã¨ã—ã¦ä½¿ã†ã€‚
    - `A: non_main_arena`  Main Arenaã§ã‚ã‚‹ã‹ã©ã†ã‹
    - `M: is_mmaped`  ãƒ¡ãƒ¢ãƒªãŒmmapã§ç¢ºä¿ã•ã‚ŒãŸ
    - `P: prev_inuse`  å‰ã®ãƒãƒ£ãƒ³ã‚¯ãŒä½¿ç”¨ä¸­ã‹

## ãƒãƒ£ãƒ³ã‚¯ã®ç®¡ç†

free list ã®æ­£ä½“ã¯ bins ã¨å‘¼ã°ã‚Œã‚‹ãƒªã‚¹ãƒˆã§ã™ã€‚bins ã¯ã„ãã¤ã‹ã®ç¨®é¡ãŒã‚ã£ã¦ã‚µã‚¤ã‚ºã«ã‚ˆã£ã¦ç®¡ç†ã®ä»•æ–¹ã‚’å¤‰ãˆã‚‹ã“ã¨ã§æœ€é©åŒ–ã—ã¦ã„ã¾ã™ã€‚

| bins ã®ç¨®é¡ | ã‚µã‚¤ã‚º | èª¬æ˜ | ãƒ‡ãƒ¼ã‚¿æ§‹é€  |
| --- | --- | --- | --- |
| tcache bins | 0x20 ~ 0x410 | æœ€åˆã«å…¥ã‚Œã‚‰ã‚Œã‚‹ just-fit ãª bin | å˜æ–¹å‘ãƒªã‚¹ãƒˆ |
| fastbins | 0x20 ~ 0x80 | tcache ãŒæº€æ¯ã«ãªã£ãŸã‚‰å…¥ã‚Œã‚‰ã‚Œã‚‹ just-fit ãª bin | å˜æ–¹å‘ãƒªã‚¹ãƒˆ |
| unsortedbins | 0x20 ~ | tcache, fastbins ã§å–ã‚Šæ‰±ãˆãªã„ã¨ãã‚„ fastbins consolidation ã§å…¥ã‚Œã‚‰ã‚Œã‚‹ bin | åŒæ–¹å‘ãƒªã‚¹ãƒˆ |
| smallbins | 0x20 ~ 0x3f0 | unsortedbins ã‹ã‚‰æ¥ã‚‹å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ just-fit ãª bin | åŒæ–¹å‘ãƒªã‚¹ãƒˆ |
| largebins | 0x400 ~ | unsortedbins ã‹ã‚‰æ¥ã‚‹å¤§ããªãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ bin | åŒæ–¹å‘ãƒªã‚¹ãƒˆ + ã‚¹ã‚­ãƒƒãƒ—ãƒªã‚¹ãƒˆ |

ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ 2 ã¤ã‚ã‚Šã€ãã‚Œãã‚Œã®å‹•ä½œã¯ç†è§£ã—ã¦ã„ã‚‹å‰æã§è©±ã‚’é€²ã‚ã¾ã™ã€‚

- å˜æ–¹å‘ãƒªã‚¹ãƒˆã¯å˜æ–¹å‘ã«ã—ã‹ç§»å‹•ã§ããªã„ç¹‹ãå¤‰ãˆãŒç°¡å˜ãªé«˜é€Ÿãªãƒªã‚¹ãƒˆã§ã™ã€‚LIFO ã§å…ˆé ­ã¯ arena ã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒãƒ£ãƒ³ã‚¯ã®ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã®å…ˆé ­ 8 ãƒã‚¤ãƒˆã¯ forward pointer (fd) ã¨ã—ã¦ä½¿ã‚ã‚Œã€æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã®ãƒã‚¤ãƒ³ã‚¿ãƒ¼ãŒæ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚æœ«å°¾ã® fd ã¯ NULL ã«ãªã‚Šã¾ã™ã€‚
- åŒæ–¹å‘ãƒªã‚¹ãƒˆã¯åŒæ–¹å‘ç§»å‹•ã§ãã‚‹å††å½¢ã®ãƒªã‚¹ãƒˆã§ã™ã€‚FIFO ã§å…ˆé ­ã¨æœ«å°¾ã¯ arena ã§ç®¡ç†ã•ã‚Œã¦ã„ã¦ã€ãƒãƒ£ãƒ³ã‚¯ã®ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã®å…ˆé ­ 16 ãƒã‚¤ãƒˆã¯ forward pointer (fd), back pointer (bk) ã¨ã—ã¦ä½¿ã‚ã‚Œã¾ã™ã€‚

`malloc()` ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã¨ã¾ãš tcache ã‚’ç¢ºèªã—ã¦ã€ãªã‘ã‚Œã° `_int_malloc()` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

smallbin ã®ç¯„å›²ã®ã¨ã

fastbin â†’ smallbin â†’ unsortedbin â†’ ä¸Šä½ã® bin â†’ top â†’ fastbin consolidate â†’ unsortedbin

largebin ã®ç¯„å›²ã®ã¨ã

fastbin consolidate â†’ unsortedbin â†’ largebin â†’ ä¸Šä½ã® bin â†’ top â†’ sysmalloc()

unsortedbin ã‹ã‚‰ç¢ºä¿ã™ã‚‹ã¨ãã«ã¯

| ç”¨èª | èª¬æ˜ |
| --- | --- |
| Linking | ãƒãƒ£ãƒ³ã‚¯ã‚’è¿½åŠ ã™ã‚‹ |
| Unlinking | ãƒãƒ£ãƒ³ã‚¯ã‚’å–ã‚Šå‡ºã™ |
| Remaindering | è¦æ±‚ã®ã‚ã£ãŸã‚µã‚¤ã‚ºã¨åˆè‡´ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æ—¢å­˜ã®ãƒãƒ£ãƒ³ã‚¯ã‚’è¦æ±‚ã‚µã‚¤ã‚ºã§åˆ†å‰²ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚æ®‹ã‚Šã®é ˜åŸŸã¯æ–°ãŸãªãƒãƒ£ãƒ³ã‚¯ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¾ã™ã€‚ last_remainder ã¯ã“ã®æ™‚ã®æ®‹ã‚Šã®ãƒãƒ£ãƒ³ã‚¯ã®å†…ã€æœ€æ–°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ ¼ç´ã—ã¾ã™ã€‚(largebins, bimap, unsortedbins) åˆ‡ã‚Šå‡ºã—ãŒè¤‡æ•°ã‚ã‚‹ã¨ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒé€²ã‚€ |
| Exhausting | è¦æ±‚ã®ã‚ã£ãŸã‚µã‚¤ã‚º N ã¨åˆè‡´ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãšã€ã‚µã‚¤ã‚º N + 0x10 ã®ãƒãƒ£ãƒ³ã‚¯ãŒã‚ã‚‹å ´åˆãã®ã¾ã¾ä½¿ã†ã€‚ |
| Consolidation | 2 ã¤ã® free chunk ã‚’çµ±åˆã™ã‚‹ã“ã¨ |

### tcache bins

glibc v2.26 ä»¥é™ã«è¿½åŠ ã•ã‚ŒãŸ binã€‚å‚ç…§å±€æ‰€æ€§ã‚’é«˜ã‚ã‚‹ç‚ºã« `malloc / free` ã§ä¸€ç•ªæœ€åˆã«å‡¦ç†ã•ã‚Œã‚‹ã®ãŒ tcache bins ã§ã™ã€‚tcache bins ã¯ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x20 ã‹ã‚‰ 0x410 ã¾ã§ã® 64 ç¨®é¡ã® tcache bin ã‚’æŒã¡ã€ãã‚Œãã‚Œå˜æ–¹å‘ãƒªã‚¹ãƒˆã¨ãªã£ã¦ã„ã‚‹ã€‚ãƒªã‚¹ãƒˆã®é•·ã•ã¯ 7 å€‹ã«åˆ¶é™ã•ã‚Œã¦ã„ã¦ tcache ãŒæº€æ¯ã«ãªã‚‹ã¨ä»–ã® bins ã«ç§»ã•ã‚Œã‚‹ã€‚ã‚µã‚¤ã‚ºã”ã¨ã«åˆ†ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ just-fit ã§è¿”ã›ã¾ã™ã€‚

tcache bins ã®å®Ÿä½“ã¯ `tcache_perthread_struct` æ§‹é€ ä½“ã§ã™ã€‚ `entries` ã§å„ãƒªã‚¹ãƒˆã® HEAD ã®ãƒãƒ£ãƒ³ã‚¯ã«ç¹‹ã’ã¦ã€ `counts` ã§ãƒªã‚¹ãƒˆã®é•·ã•ã‚’ç®¡ç†ã—ã€7 å€‹ã«ãªã£ãŸã‚‰å—ã‘ä»˜ã‘ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚ãƒãƒ£ãƒ³ã‚¯ãŒ tcache bin ã«å…¥ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã« `tcache_entry` æ§‹é€ ä½“ãŒ overlap ã•ã‚Œã¦ãƒªã‚¹ãƒˆã«å…¥ã‚Šã¾ã™ã€‚

```c
typedef struct tcache_entry
{
 struct tcache_entry *next;              // æ¬¡ã® tcache_entry ã¸ã®ãƒã‚¤ãƒ³ã‚¿
 struct tcache_perthread_struct *key;    // è¦ªã® tcache_perthread_struct ã‚’æŒ‡ã— double free ã‚’æ¤œçŸ¥ã™ã‚‹ã€‚
} tcache_entry;

typedef struct tcache_perthread_struct
{
 uint16_t counts[TCACHE_MAX_BINS];       // å„ tcache bin ã®é•·ã•ã®ä¸€è¦§
 tcache_entry *entries[TCACHE_MAX_BINS]; // å„ tcache bin ã®æœ€åˆã® tcache ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã®ä¸€è¦§
} tcache_perthread_struct;
```

![tcache.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/cc4e6803-0625-41e0-b5ea-421d971679de/63147349-d1b0-4610-b461-a3fedd4e6846/tcache.png)

### fastbins

glibc-2.3 ã‹ã‚‰ã‚ã‚‹binã€‚å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã¯é »ç¹ã«ç¢ºä¿ãƒ»é–‹æ”¾ãŒèµ·ãã‚„ã™ã„ã®ã§é«˜é€Ÿã«ç®¡ç†ã•ã‚Œã¦ã„ã‚‹ã€‚fastbins ã¯ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x20 ã‹ã‚‰ 0x80 ã¾ã§ 6 ç¨®é¡ã® fastbin ã‚’æŒã¡ã€ãã‚Œãã‚Œå˜æ–¹å‘ãƒªã‚¹ãƒˆã¨ãªã£ã¦ã„ã‚‹ã€‚

fastbins ã®å®Ÿä½“ã¯ `arena` ã«ã‚ã‚‹ `fastbinsY` ã§ã™ã€‚`NFASTBINS == 10` ã‹ã¤ `global_max_fast == 0x80`

```c
struct malloc_state
{
  ...
  int have_fastchunks;
  mfastbinptr fastbinsY[NFASTBINS];
  ...
};
```

![fastbin.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/cc4e6803-0625-41e0-b5ea-421d971679de/25a5fec4-6a06-403e-9a24-54a161ec858f/fastbin.png)

### unsortedbin

tcache ã‚„ fastbins ã®ãŠã“ã¼ã‚Œã‚„ fastbins ã® consolidation ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã‚’ unsortedbin ãŒç®¡ç†ã—ã¾ã™ã€‚unsortedbin ã¯ 1 ã¤ã®åŒæ–¹å‘ãƒªã‚¹ãƒˆã¨ãªã£ã¦ã„ã¾ã™ã€‚unsortedbin ã§ã‚½ãƒ¼ãƒˆãŒèµ·ã“ã‚‹ã¨ smallbins ã‹ largebins ã«ç¹‹ãŒã‚Œã‚‹ã€‚

unsortedbin ã®å…ˆé ­ãƒ»æœ«å°¾ã¯ `bin_at(1)` ã¤ã¾ã‚Š `arena` ã® `bins[0]` ã¨ `bins[1]` ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚

```c
/* The otherwise unindexable 1-bin is used to hold unsorted chunks. */
#define unsorted_chunks(M)          (bin_at (M, 1))
```

### smallbins

unsortedbin ã«å…¥ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã§å°ã•ã„ãƒãƒ£ãƒ³ã‚¯ã¯ smallbins ã«ç¹‹ãŒã‚Œã¾ã™ã€‚smallbins ã¯ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x20 ã‹ã‚‰ 0x3f0 ã¾ã§ 62 ç¨®é¡ã® smallbin ã‚’æŒã¡ã€ãã‚Œãã‚ŒåŒæ–¹å‘ãƒªã‚¹ãƒˆã¨ãªã£ã¦ã„ã‚‹ã€‚

smallbins ã®å…ˆé ­ãƒ»æœ«å°¾ã¯ `bin_at(2)` ã‹ã‚‰ `bin_at(63)` ã¾ã§ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚

```c
#define SMALLBIN_WIDTH    MALLOC_ALIGNMENT
#define SMALLBIN_CORRECTION (MALLOC_ALIGNMENT > CHUNK_HDR_SZ)

#define smallbin_index(sz) \
  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) >> 4) : (((unsigned) (sz)) >> 3))\
   + SMALLBIN_CORRECTION)
```

![smallbin.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/cc4e6803-0625-41e0-b5ea-421d971679de/3c9f200d-9dd1-42ed-aada-b012fb710d2c/smallbin.png)

### largebins

å¤§ããªã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ã‚‚ 16 ãƒã‚¤ãƒˆã”ã¨ã«ç®¡ç†ã™ã‚‹ã®ã¯ç¾å®Ÿçš„ã§ã¯ãªã„ã€‚ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚‹ã«ã¤ã‚Œã¦å¹…ã‚‚æŒ‡æ•°çš„ã«å¤§ããã™ã‚‹ã“ã¨ã§ãƒªã‚¹ãƒˆã®æ•°ã‚’å¹³å‡åŒ–ã—ã€æœ€æ‚ªè¨ˆç®—é‡ã‚’æ¸›ã‚‰ã™ã€‚largebins ã¯ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ 0x400 ~ 0x430, 0x440 ~ 0x470, â€¦, 0x1000000 ~ 0x1fffff0, 0x2000000 ~ ã® 63 ç¨®é¡ã® largebin ã‚’æŒã¡ã€ãã‚Œãã‚Œã‚µã‚¤ã‚ºã«å¿œã˜ã¦é †åºç«‹ã¦ãŸåŒæ–¹å‘ãƒªã‚¹ãƒˆã¨ãªã£ã¦ã„ã‚‹ã€‚ã“ã‚Œã¯åŒæ–¹å‘ãƒªã‚¹ãƒˆã®ãƒ¡ãƒ³ãƒã«åŠ ãˆã¦ `fd_nextsize` `bk_nextsize` ãŒã‚ã‚Šã€ãã‚Œãã‚Œãƒãƒ£ãƒ³ã‚¯ã®å¹…ã®ä¸­ã§æ¬¡ã«å¤§ããªãƒãƒ£ãƒ³ã‚¯ã¨æ¬¡ã«å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãŒæ ¼ç´ã•ã‚Œã‚‹ã€‚

largebins ã®å…ˆé ­ãƒ»æœ«å°¾ã¯ `bin_at(64)` ã‹ã‚‰ `bin_at(126)` ã¾ã§ã«æ ¼ç´ã•ã‚Œã‚‹ã€‚

largebins ã‹ã‚‰ç¢ºä¿ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªã¯ `last_remainder` ã¯ã‚»ãƒƒãƒˆã•ã‚Œãªã„ã€‚

```c
#define largebin_index_64(sz)                                                \
  (((((unsigned long) (sz)) >> 6) <= 48) ?  48 + (((unsigned long) (sz)) >> 6) :\
   ((((unsigned long) (sz)) >> 9) <= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\
   ((((unsigned long) (sz)) >> 12) <= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\
   ((((unsigned long) (sz)) >> 15) <= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\
   ((((unsigned long) (sz)) >> 18) <= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\
   126)

#define largebin_index(sz) \
  (SIZE_SZ == 8 ? largebin_index_64 (sz)                                     \
   : MALLOC_ALIGNMENT == 16 ? largebin_index_32_big (sz)                     \
   : largebin_index_32 (sz))
```

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/cc4e6803-0625-41e0-b5ea-421d971679de/190e200a-45d3-424c-b673-e77e3ab2be4b/Untitled.png)

![largebin.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/cc4e6803-0625-41e0-b5ea-421d971679de/b50040ea-22c2-4be8-b1f5-ec777157cf75/largebin.png)

## ã‚¢ãƒªãƒ¼ãƒŠ

ãƒ¡ãƒ¢ãƒªãƒ—ãƒ¼ãƒ«ã‚’ç®¡ç†ã™ã‚‹ç‚ºã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ malloc_par

ãƒ¡ãƒ¢ãƒªãƒ—ãƒ¼ãƒ«ã¯ã‚¢ãƒªãƒ¼ãƒŠã¨ã„ã†æ©Ÿæ§‹ã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã‚‹ã€‚ã‚¢ãƒªãƒ¼ãƒŠã¯ `malloc_state` æ§‹é€ ä½“ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

```c
/* addressing -- note that bin_at(0) does not exist */
#define bin_at(m, i) \
  (mbinptr) (((char *) &((m)->bins[((i) - 1) * 2]))			      \
             - offsetof (struct malloc_chunk, fd))

struct malloc_state
{
  ...
  mchunkptr bins[NBINS * 2 - 2];
  unsigned int binmap[BINMAPSIZE];
  ...
};
```

```c
struct malloc_state
{
  __libc_lock_define (, mutex);
  int flags;

  int have_fastchunks;
  mfastbinptr fastbinsY[NFASTBINS];

  mchunkptr top;

  mchunkptr last_remainder;

  mchunkptr bins[NBINS * 2 - 2];
  unsigned int binmap[BINMAPSIZE];

  struct malloc_state *next;
  struct malloc_state *next_free;

  INTERNAL_SIZE_T attached_threads;

  INTERNAL_SIZE_T system_mem;
  INTERNAL_SIZE_T max_system_mem;
};
```

```c
struct malloc_par
{
  /* Tunable parameters */
  unsigned long trim_threshold;
  INTERNAL_SIZE_T top_pad;
  INTERNAL_SIZE_T mmap_threshold;
  INTERNAL_SIZE_T arena_test;
  INTERNAL_SIZE_T arena_max;
#if HAVE_TUNABLES
  /* Transparent Large Page support.  */
  INTERNAL_SIZE_T thp_pagesize;
  /* A value different than 0 means to align mmap allocation to hp_pagesize
     add hp_flags on flags.  */
  INTERNAL_SIZE_T hp_pagesize;
  int hp_flags;
#endif
  /* Memory map support */
  int n_mmaps;
  int n_mmaps_max;
  int max_n_mmaps;
  /* the mmap_threshold is dynamic, until the user sets
     it manually, at which point we need to disable any
     dynamic behavior. */
  int no_dyn_threshold;
  /* Statistics */
  INTERNAL_SIZE_T mmapped_mem;
  INTERNAL_SIZE_T max_mmapped_mem;
  /* First address handed out by MORECORE/sbrk.  */
  char *sbrk_base;
#if USE_TCACHE
  /* Maximum number of buckets to use.  */
  size_t tcache_bins;
  size_t tcache_max_bytes;
  /* Maximum number of chunks in each bucket.  */
  size_t tcache_count;
  /* Maximum number of chunks to remove from the unsorted list, which
     aren't used to prefill the cache.  */
  size_t tcache_unsorted_limit;
#endif
};
```

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | èª¬æ˜ |
| --- | --- |
| mutex | arena ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ serialize ã™ã‚‹ |
| flag | ãƒ’ãƒ¼ãƒ—ãƒ¡ãƒ¢ãƒªãŒé€£ç¶šã§ã‚ã‚‹ã‹ |
| have_fastchunks | fastbins ãŒç©ºã§ã¯ãªã„ã“ã¨ã‚’è¡¨ã™çœŸå½å€¤ |
| binmap | smallbins largebinsã§ç´ æ—©ãè¦‹ã¤ã‘ã‚‹ç‚ºã«ä½¿ã‚ã‚Œã‚‹ãƒ“ãƒƒãƒˆãƒ™ã‚¯ã‚¿ã§ã™ |
| next | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ arena ã®å˜æ–¹å‘å¾ªç’°ãƒªã‚¹ãƒˆã€‚next_free ã‚‚ç©ºã„ã¦ã‚‹ arena ã®å˜æ–¹å‘é€£çµãƒªã‚¹ãƒˆã§ã™ã€‚ |
| attached_threads | arena ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã®æ•° |
| system_mem | arena ã«ã‚ˆã£ã¦ç¾åœ¨ç¢ºä¿ã•ã‚Œã¦ã„ã‚‹æ›¸ãè¾¼ã¿å¯èƒ½ãªãƒ¡ãƒ¢ãƒªã®åˆè¨ˆå€¤ã€‚max_system_mem ã¯ãã®æœ€å¤§å€¤ã§ã™ã€‚ |

arena ã¯ malloc ã®ç‚ºã ã‘ã«ä½¿ã‚ã‚Œã‚‹ã€‚

### malloc hooks

ã“ã‚Œã‚‰ã®ãƒ•ãƒƒã‚¯ã¯ heap exploit ã«ãŠã„ã¦éå¸¸ã«æœ‰ç”¨ã§ã—ãŸãŒ glibc >= 2.34 ã§å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚

- `__malloc_hook` / `__free_hook` / `__realloc_hook`
- `__after_morecore_hook`
- `__malloc_initialize_hook`
- `__memalign_hook`
- `_dl_open_hook`

# ãƒ’ãƒ¼ãƒ—é ˜åŸŸã§ã®æ›¸ãæ›ãˆ

ãƒ’ãƒ¼ãƒ—é ˜åŸŸã«ãŠã„ã¦ã¯ `fd` `bk` ã®æ›¸ãæ›ãˆãŒç›®æ¨™ã§ã™ã€‚ã“ã‚ŒãŒã§ãã‚Œã° free list ã®ãƒªã‚¹ãƒˆæ§‹é€ ã‚’å£Šã™ã“ã¨ãŒã§ãã¾ã™ã€‚

### Heap based Buffer Overflow

ã‚„ã‚‹ã ã‘

ãƒ’ãƒ¼ãƒ—ä¸Šã®ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’åˆ©ç”¨ã—ã¦ã€é–¢æ•°ã®æˆ»ã‚Šã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã‚’æ›¸ãæ›ãˆã‚‹

- [ãƒ’ãƒ¼ãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚‹GOT overwriteã‚’ã‚„ã£ã¦ã¿ã‚‹ - ã‚‚ã‚‚ã„ã‚ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼](https://inaz2.hatenablog.com/entry/2014/05/14/011448)
- [ãƒ’ãƒ¼ãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚‹C++ vtable overwriteã‚’ã‚„ã£ã¦ã¿ã‚‹ - ã‚‚ã‚‚ã„ã‚ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼](https://inaz2.hatenablog.com/entry/2014/05/15/012621)

### Use After Free

ã‚„ã‚‹ã ã‘

Use After Free

è§£æ”¾ã—ãŸé ˜åŸŸã‚’èª¤ã£ã¦ä½¿ç”¨ã—ã¦ã—ã¾ã†Use After Freeã‚’åˆ©ç”¨ã—ã€åŒã˜é ˜åŸŸã«æ‚ªæ„ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºä¿ã—ã¦åˆ©ç”¨ã•ã›ã‚‹äº‹ã§ã€é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã‚’æ›¸ãæ›ãˆã‚‹ã€‚

- [use-after-freeã«ã‚ˆã‚‹GOT overwriteã‚’ã‚„ã£ã¦ã¿ã‚‹ - ã‚‚ã‚‚ã„ã‚ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼](https://inaz2.hatenablog.com/entry/2014/06/18/215452)
- [use-after-freeã«ã‚ˆã‚‹C++ vtable overwriteã‚’ã‚„ã£ã¦ã¿ã‚‹ - ã‚‚ã‚‚ã„ã‚ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼](https://inaz2.hatenablog.com/entry/2014/06/18/220735)

### double free

Use After Free ãŒå‡ºæ¥ãªãã¨ã‚‚ double free ã•ã›ã‚Œã°ãƒªã‚¹ãƒˆãŒãƒ«ãƒ¼ãƒ—ã™ã‚‹ã‹ã‚‰é©åˆ‡ã« malloc ã—ãŸé ˜åŸŸã§ã‚‚ fd ã«æ„å›³ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãè¾¼ã‚ã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ä½•å›ã‹ malloc ã™ã‚‹ã¨ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸æ›¸ãæ›ãˆãŒå‡ºæ¥ã‚‹ã€‚

# ãƒ’ãƒ¼ãƒ—é ˜åŸŸã§ã®æ”»æ’ƒæ–¹æ³•

how2heap ã‚’ç†è§£ã™ã‚‹ã®ãŒæœ€ã‚‚æ—©ã„

https://github.com/shellphish/how2heap

[Exploiting Intel Graphics Kernel Extensions on macOS](https://blog.ret2.io/2022/06/29/pwn2own-2021-safari-sandbox-intel-graphics-exploit/)

## tcache poisoning

tcache ã«å…¥ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã® next ã‚’æ›¸ãæ›ãˆã¦ malloc ã™ã‚‹ã“ã¨ã§ AAW ã§ãã‚‹è„†å¼±æ€§ã€‚

æ³¨æ„ã™ã‚‹ã¹ãã¯ tcache ãŒ LIFO ãªãƒªã‚¹ãƒˆãªç‚ºã« malloc free ã‚’ 2 å›ç¹°ã‚Šè¿”ã•ãªã‘ã‚Œã°ãªã‚‰ãªã„

[SECCON Beginners CTF 2020 [Beginners Heap] Writeup &åˆå¿ƒè€…å‘ã‘è§£èª¬ - Qiita](https://qiita.com/hanya1995/items/c29a89737bbd521e67f2)

glibc 2.28 ä»¥å‰ã® tcache ã§ã¯ double free ãŒæ¤œå‡ºã•ã‚Œãªã„ã€‚ã¤ã¾ã‚Šè¦ªã® `tcache_perthread_struct` ã‚’æŒ‡ã™ `key` ãŒãªã„ã€‚

double free ã§ tcache poisoning ã—ã¦ `__free_hook` ã‚’æ›¸ãæ›ãˆã‚‹ã€‚

[SECCON Beginners CTF 2019 - Babyheap - HackMD](https://hackmd.io/@Xornet/H1hYUUR2I)

## ****unsorted bin attack****

## _IO_FILE æ§‹é€ ä½“ã®æ›¸ãæ›ãˆ

```c
struct _IO_FILE
{
  int _flags;                /* High-order word is _IO_MAGIC; rest is flags. */
  /* The following pointers correspond to the C++ streambuf protocol. */
  char *_IO_read_ptr;        /* Current read pointer */
  char *_IO_read_end;        /* End of get area. */
  char *_IO_read_base;        /* Start of putback+get area. */
  char *_IO_write_base;        /* Start of put area. */
  char *_IO_write_ptr;        /* Current put pointer. */
  char *_IO_write_end;        /* End of put area. */
  char *_IO_buf_base;        /* Start of reserve area. */
  char *_IO_buf_end;        /* End of reserve area. */
  /* The following fields are used to support backing up and undo. */
  char *_IO_save_base; /* Pointer to start of non-current get area. */
  char *_IO_backup_base;  /* Pointer to first valid character of backup area */
  char *_IO_save_end; /* Pointer to end of non-current get area. */
  struct _IO_marker *_markers;
  struct _IO_FILE *_chain;
  int _fileno;
  int _flags2;
  __off_t _old_offset; /* This used to be _offset but it's too small.  */
  /* 1+column number of pbase(); 0 is unknown. */
  unsigned short _cur_column;
  signed char _vtable_offset;
  char _shortbuf[1];
  _IO_lock_t *_lock;
#ifdef _IO_USE_OLD_IO_FILE
};

```

```c
struct _IO_FILE_plus
{
  _IO_FILE file;
  const struct _IO_jump_t *vtable;
};

```

```c
struct _IO_jump_t
{
    JUMP_FIELD(size_t, __dummy);
    JUMP_FIELD(size_t, __dummy2);
    JUMP_FIELD(_IO_finish_t, __finish);
    JUMP_FIELD(_IO_overflow_t, __overflow);
    JUMP_FIELD(_IO_underflow_t, __underflow);
    JUMP_FIELD(_IO_underflow_t, __uflow);
    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);
    /* showmany */
    JUMP_FIELD(_IO_xsputn_t, __xsputn);
    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);
    JUMP_FIELD(_IO_seekoff_t, __seekoff);
    JUMP_FIELD(_IO_seekpos_t, __seekpos);
    JUMP_FIELD(_IO_setbuf_t, __setbuf);
    JUMP_FIELD(_IO_sync_t, __sync);
    JUMP_FIELD(_IO_doallocate_t, __doallocate);
    JUMP_FIELD(_IO_read_t, __read);
    JUMP_FIELD(_IO_write_t, __write);
    JUMP_FIELD(_IO_seek_t, __seek);
    JUMP_FIELD(_IO_close_t, __close);
    JUMP_FIELD(_IO_stat_t, __stat);
    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);
    JUMP_FIELD(_IO_imbue_t, __imbue);
#if 0
    get_column;
    set_column;
#endif
};
```

fastbin attack

- [ãƒ’ãƒ¼ãƒ—ç³»å•é¡Œã«ãŠã‘ã‚‹stdout / stderrã‚’åˆ©ç”¨ã—ãŸãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ - CTFã™ã‚‹ã](https://ptr-yudai.hatenablog.com/entry/2019/05/31/235444)
- [Security Fest 2019 - Baby5 (Unsorted Bin) - HackMD](https://hackmd.io/@Xornet/rycqVwQpL)
- [næ—¥1CTFãƒãƒ£ãƒ¬ãƒ³ã‚¸ - HackMD](https://hackmd.io/@Xornet/BkemeSAhU)

[Overview of GLIBC heap exploitation techniques](https://0x434b.dev/overview-of-glibc-heap-exploitation-techniques/)

## ä¿®æ­£æ¸ˆã¿æŠ€è¡“

### House of Prime

fastbins ã®æœ€å¤§ã‚µã‚¤ã‚ºå¤‰æ•°ã‚’ç ´æã•ã›ã¦ã€ç‰¹å®šã®çŠ¶æ³ä¸‹ã§æ”»æ’ƒè€…ãŒ arena æ§‹é€ ä½“ã‚’ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯ã—ã€ãã®çµæœä»»æ„ã®ãƒ¡ãƒ¢ãƒªãƒãƒ£ãƒ³ã‚¯ã‚’è¿”ã™ã‹ã€
ã‚¢ã‚¤ãƒ‡ã‚¢
2å›ã® `free()` ã€1å›ã® `malloc()` ã®å‘¼ã³å‡ºã—ãŒã§ãã‚‹ã¨ã

TODO malloc.c ã‚’æ›¸ãæ›ãˆã¦ãƒ“ãƒ«ãƒ‰ã—ãŸã‚‚ã®ã‚’ä½¿ã£ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬

malloc

- [ã€LCR 1.1ã€‘LibcCodeReading: mallocç·¨[2]=fastbinsãƒ»smallbins - newbie dive into binary (hatenablog.com)](https://smallkirby.hatenablog.com/entry/2019/09/23/001554)
- [mimalloc ã®ãƒ¡ãƒ¢ãƒªç®¡ç† - Qiita](https://qiita.com/methane/items/e88901b7392c10cee2c9)