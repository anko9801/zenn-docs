---
title: "ã€CTF æ¢è¨ªè¨˜ã€‘Stack Exploit æŠ€è¡“"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CTF", "pwn"]
published: true
---

pwn ã¨ã„ã†ã®ã¯ãƒ¡ãƒ¢ãƒªã®æ›¸ãæ›ãˆã‚„èª­ã¿å–ã‚Šãªã©ã®ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è„†å¼±æ€§ã‚’ç”¨ã„ã¦æ„å›³ã—ãªã„å‹•ä½œã‚’å¼•ãèµ·ã“ã•ã›ã‚‹ç«¶æŠ€ã§æœ€ã‚‚ãƒãƒƒã‚­ãƒ³ã‚°ã£ã½ã„åˆ†é‡ã§ã™ã€‚

- [Stack Exploits](https://zenn.dev/anko/articles/ctf-stack-exploits)
- [Heap Exploits](https://zenn.dev/anko/articles/ctf-heap-exploits)

ä»Šå›ã¯ãªãœä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã¨ã„ã†ã‚‚ã®ãŒå‡ºæ¥ã‚‹ã®ã‹ã‹ã‚‰å§‹ã¾ã‚Šã€Stack é ˜åŸŸã«é–¢ã™ã‚‹æ”»æ’ƒã®è©±ã‚’ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## pwn ã§ã‚„ã‚‹ã“ã¨
pwn ã«ã¯ã‚·ã‚§ãƒ«èµ·å‹•ã‚„æ¨©é™æ˜‡æ ¼ã€ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã®è„±å‡ºãªã©å•é¡Œã®ã‚´ãƒ¼ãƒ«ã¯å¤šå²ã«æ¸¡ã‚Šã¾ã™ãŒã€ã©ã®å•é¡Œã§ã‚‚ã¾ãšã‚„ã‚‹ã¹ãã“ã¨ã¯ 1 ã¤ã ã‘ã§ã™ã€‚

**ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚«ã‚¦ãƒ³ã‚¿ã‚’å¥ªå–ã™ã‚‹ã“ã¨**

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚«ã‚¦ãƒ³ã‚¿ã¯æ¬¡ã«å®Ÿè¡Œã™ã‚‹å‘½ä»¤ã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ ¼ç´ã—ã¦ã„ã‚‹ãƒ¬ã‚¸ã‚¹ã‚¿ã§ã€x86-64 ã§ã¯ ripã€ARM ã‚„ RISC-V ã§ã¯ pc ã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚«ã‚¦ãƒ³ã‚¿ã‚’è‡ªç”±ã«æ›¸ãæ›ãˆã‚‰ã‚Œã‚Œã°ã€å®Ÿè¡Œé ˜åŸŸã«æ›¸ã‹ã‚Œã¦ã‚ã‚‹æ©Ÿæ¢°èªã¯ä½•ã§ã‚‚å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã€ã“ã‚Œã‚’ä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ (ACE; Arbitrary Code Execution) ã¨ã„ã„ã¾ã™ã€‚

ä¸€éƒ¨ã‚’é™¤ã„ãŸã»ã¨ã‚“ã©ã®å‘½ä»¤ã¯å®Ÿè¡Œã•ã‚Œã‚‹ã¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚«ã‚¦ãƒ³ã‚¿ã¯ãã®å‘½ä»¤é•·ã ã‘è¶³ã•ã‚Œã€æ¬¡ã®å‘½ä»¤ã¸ç§»ã‚Šã¾ã™ã€‚åˆ†å²å‘½ä»¤ã‚„ call / ret å‘½ä»¤ãªã©ã®ç‰¹æ®Šãªå‘½ä»¤ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚«ã‚¦ãƒ³ã‚¿ã‚’é›¢ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã¸é£›ã°ã™ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚ã“ã®ã¨ãã‚¹ã‚¿ãƒƒã‚¯é ˜åŸŸã‚„ TLS é ˜åŸŸãªã©ã«æ›¸ãè¾¼ã¾ã‚Œã¦ã„ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸é£›ã°ã™ã‚ˆã†ãªå‘½ä»¤ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ãã€ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãæ›ãˆã‚‹ã“ã¨ã§æ„å›³ã—ãŸå ´æ‰€ã¸ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚«ã‚¦ãƒ³ã‚¿ã‚’é£›ã°ã™ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚ã“ã‚ŒãŒä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã®æ­£ä½“ã§ã™ã€‚

ã¾ãŸå¤‰æ•°ã‚’æ›¸ãæ›ãˆã‚‹ã“ã¨ã§åˆ†å²å‘½ä»¤ã§ã®ãƒ•ãƒ­ãƒ¼ã‚’å¤‰æ›´ã•ã›ã¦æ„å›³ã—ãŸå ´æ‰€ã¸é£›ã°ã™ã“ã¨ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ãªè„†å¼±æ€§ã§ãƒ•ãƒ­ãƒ¼ã‚’å¤‰æ›´ã•ã›ã‚‰ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

- Integer Overflow
- Race Condition
- etc...

ä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã«ã‚ˆã‚Š pwn ã§ã¯æ™®é€šã¯å‘¼ã³å‡ºã›ãªã„é–¢æ•°ã‚’å‘¼ã³å‡ºã—ãŸã‚Šã€ã‚·ã‚§ãƒ«ã‚’å‘¼ã³å‡ºã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿æ›¸ãã—ã¦ãƒ•ãƒ©ã‚°ã‚’å–ã‚Œã¾ã™ã€‚

ã•ã¦ã€ãã®ã‚ˆã†ãªãƒ¡ãƒ¢ãƒªé ˜åŸŸã«æ›¸ã‹ã‚Œã¦ã‚ã‚‹å®Ÿè¡Œã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚

- return address
- é–¢æ•°ã‚¢ãƒ‰ãƒ¬ã‚¹
  - GOT
  - vtable
    - å‹•çš„ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ã‚’å®Ÿç¾ã™ã‚‹ç‚ºã«å‹ã¨å‘¼ã³å‡ºã™é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¯¾å¿œè¡¨ vtable ãŒãƒã‚¤ãƒŠãƒªä¸­ã«ã‚ã‚‹ã€‚
  - ãƒ•ãƒƒã‚¯é–¢æ•°

ã“ã‚Œã‚‰ã‚’è‡ªç”±ã«æ›¸ãæ›ãˆã‚‹æ‰‹æ®µã‚‚å¿…è¦ã§ã™ã€‚ä»»æ„ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã‚ã‚‹ã“ã¨ã€æ›¸ãè¾¼ã‚ã‚‹ã“ã¨ã‚’ãã‚Œãã‚Œ AAR; Arbitrary Address Readã€AAW; Arbitrary Address Write ã¨ã„ã„ã¾ã™ã€‚

AAW ã®ä¾‹ã¨ã—ã¦ã¯

- `gets` ãªã©ã®æ–‡å­—åˆ—å…¥åŠ›ã«ã‚ˆã‚‹ BOF
- `printf` ã«ã‚ˆã‚‹ Format String Bug ã§ã®æ›¸ãæ›ãˆ
- é…åˆ—ã®ç¯„å›²å¤–å‚ç…§
- corrupted heap ã«ã‚ˆã‚‹æ›¸ãæ›ãˆ
- etc...

AAR ã®ä¾‹ã¨ã—ã¦ã¯

- `puts`, `printf` é–¢æ•°ãªã©ã§å‡ºåŠ›ã•ã›ã‚‹
- `_IO_FILE` æ§‹é€ ä½“ã® `IO_write_ptr` ã‚’æ›¸ãæ›ãˆã¦å‡ºåŠ›ã•ã›ã‚‹
- etc...

ã“ã®ã‚ˆã†ãªè„†å¼±æ€§ã‚’é§†ä½¿ã—ã¦ä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã‚’å®Ÿç¾ã•ã›ã¦ã€ãƒ•ãƒ©ã‚°ã‚’ç²å¾—ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚ãƒ•ãƒ©ã‚°ã¯å¤§æŠµãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¾ã‚Œã¦ã„ã‚‹ã®ã§ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚„é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ã€ã‚·ã‚§ãƒ«ã‚’èµ·å‹•ã—ãŸã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚ä¾‹ãˆã°æ¬¡ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§æˆåŠŸã—ã¾ã™ã€‚

- `system("/bin/sh")`
- `execve("/bin/sh", 0, 0)`
- `open("flag")` -> `read()`
- etc...

ã“ã®ã‚ˆã†ã«ã—ã¦ exploit ãŒå®Œäº†ã—ã¾ã™ã€‚

ãŸã ã—å®Ÿéš›ã®å•é¡Œã¯ã•ã¾ã–ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹ã‚„é™å®šã•ã‚ŒãŸè„†å¼±æ€§ãªã©ã«ã‚ˆã£ã¦é˜»ã¾ã‚Œã‚‹ã®ã§ç›´ç·šçš„ã«ã¯ exploit å‡ºæ¥ã¾ã›ã‚“ã€‚ãªã®ã§ã†ã¾ããƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã¨ã„ã†ã“ã¨ã‚‚æ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚

## ã‚¹ã‚¿ãƒƒã‚¯é ˜åŸŸã«ãŠã‘ã‚‹æ›¸ãæ›ãˆæ‰‹æ®µ

### Out of bounds
C è¨€èªã«ãŠã„ã¦é…åˆ—ã®å¤–ã¾ã§å‚ç…§ã™ã‚‹ã“ã¨ãŒã§ãã€åˆ¥ã®å¤‰æ•°ã«ã¾ã§ã‚¢ã‚¯ã‚»ã‚¹å‡ºæ¥ã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã‚Œã‚’é…åˆ—ã®ç¯„å›²å¤–å‚ç…§ (Out of bounds) ã¨ã„ã„ã¾ã™ã€‚

Rust ã‚„ JavaScript ãªã©ã¯å¢ƒç•Œãƒã‚§ãƒƒã‚¯ã¨ã„ã†é…åˆ—ã«æ›¸ãè¾¼ã‚€å‰ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ­£å½“ãªä½ç½®ã«ã‚ã‚‹ã‹ã©ã†ã‹ã‚’æ¤œæŸ»ã™ã‚‹æ©Ÿæ§‹ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚ã£ã¦ç¯„å›²å¤–å‚ç…§ã‚’é˜²ã’ã¾ã™ã€‚

### Buffer Overflow
Buffer Overflow ã¨ã¯é…åˆ—ç¯„å›²å¤–ã¾ã§å…¥åŠ›ã‚’å—ã‘å–ã£ã¦ã—ã¾ã†è„†å¼±æ€§ã§ã€é€šç§° BOF ã¨å‘¼ã°ã‚Œã¾ã™ã€‚

C è¨€èªã§ã¯ `char buf[40]`Â ã¨Â `char buf2[60]` ã‚’å®£è¨€ã—ãŸã¨ãã«æ¬¡ã®é–¢æ•°ãŒè„†å¼±æ€§ã¨æˆã‚Šå¾—ã¾ã™ã€‚

| é–¢æ•° | æŒ™å‹• | è„†å¼±æ€§ |
| --- | --- | :-: |
| `scanf("%s", buf)` | å¢ƒç•Œãƒã‚§ãƒƒã‚¯ã›ãšã«å…¥åŠ›ã™ã‚‹ã€‚ | BOF |
| `scanf("%39s", buf)` | 39 ãƒã‚¤ãƒˆå…¥åŠ›ã—ãŸå¾Œã« NULL ãƒã‚¤ãƒˆã‚’ç½®ãã€‚ | safe |
| `scanf("%40s", buf)` | 40 ãƒã‚¤ãƒˆå…¥åŠ›ã—ãŸå¾Œã« NULL ãƒã‚¤ãƒˆã‚’ç½®ãã€‚ | one-byte BOF |
| `gets(buf)` | å¢ƒç•Œãƒã‚§ãƒƒã‚¯ã›ãšã«å…¥åŠ›ã™ã‚‹ã€‚ | BOF |
| `fgets(buf, 40, stdin)` | 39 ãƒã‚¤ãƒˆå…¥åŠ›ã—ãŸå¾Œã« NULL ãƒã‚¤ãƒˆã‚’ç½®ãã€‚ | safe |
| `read(stdin, buf, 40)` | 40 ãƒã‚¤ãƒˆå…¥åŠ›ã—ãŸå¾Œã« NULL ãƒã‚¤ãƒˆã‚’ç½®ã‹ãªã„ã€‚ | leakable |
| `fread(buf, 1, 40, stdout)` | 40 ãƒã‚¤ãƒˆå…¥åŠ›ã—ãŸå¾Œã« NULL ãƒã‚¤ãƒˆã‚’ç½®ã‹ãªã„ã€‚ | leakable |
| `strcpy(buf, buf2)` | å¢ƒç•Œãƒã‚§ãƒƒã‚¯ã›ãšã«æ–‡å­—åˆ—ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã€‚ | BOF |
| `strncpy(buf, buf2, 40)` | 40 ãƒã‚¤ãƒˆã‚³ãƒ”ãƒ¼ã—ãŸå¾Œã« NULL ãƒã‚¤ãƒˆã‚’ç½®ã‹ãªã„ã€‚ | leakable |
| `memcpy(buf, buf2, 40)` | 40 ãƒã‚¤ãƒˆã‚³ãƒ”ãƒ¼ã—ãŸå¾Œã« NULL ãƒã‚¤ãƒˆã‚’ç½®ã‹ãªã„ã€‚ | leakable |
| `memmove(buf, buf2, 40)` | 40 ãƒã‚¤ãƒˆã‚³ãƒ”ãƒ¼ã—ãŸå¾Œã« NULL ãƒã‚¤ãƒˆã‚’ç½®ã‹ãªã„ã€‚ | leakable |
| `strcat(buf, buf2)` | å¢ƒç•Œãƒã‚§ãƒƒã‚¯ã›ãšã«æ–‡å­—åˆ—ã‚’ `buf` ã«é€£çµã™ã‚‹ã€‚ | BOF |
| `strncat(buf, buf2, 10)` | 10 ãƒã‚¤ãƒˆé€£çµã—ãŸå¾Œã« NULL ãƒã‚¤ãƒˆã‚’ç½®ã‹ãªã„ã€‚ | BOF |
| `sprintf(buf, format, ...)` | æ›¸å¼ã‚’é©ç”¨ã—ãŸæ–‡å­—åˆ—ã‚’å¢ƒç•Œãƒã‚§ãƒƒã‚¯ã›ãšã«å…¥åŠ›ã—ãŸå¾Œã« NULL ãƒã‚¤ãƒˆã‚’ç½®ãã€‚ | BOF |
| `snprintf(buf, 40, format, ...)` | æ›¸å¼ã‚’é©ç”¨ã—ãŸæ–‡å­—åˆ—ã‚’ 39 ãƒã‚¤ãƒˆå…¥åŠ›ã—ãŸå¾Œã« NULL ãƒã‚¤ãƒˆã‚’ç½®ãã€‚ | safe |

ã¡ãªã¿ã« NULL ãƒã‚¤ãƒˆã ã‘ BOF ã§ãã‚‹ã“ã¨ã¯ä¸€è¦‹ exploit ã«ç¹‹ãŒã‚‰ãªã•ãã†ã«è¦‹ãˆã¾ã™ã€‚ã—ã‹ã—ã“ã‚Œã¯ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ä¸‹ä½ 1 ãƒã‚¤ãƒˆã‚’ 0x00 ã«æ›¸ãæ›ãˆã‚‰ã‚Œã‚‹ã¨ã„ã†èƒ½åŠ›ã‚’æŒã¡ã€ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è‹¥å¹²ãšã‚‰ã—ã¦æ›¸ãæ›ãˆå¯èƒ½ãªé ˜åŸŸã¸æŒ‡ã™ã‚ˆã†ã«ãªã‚Œã°ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãæ›ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```c
#include <stdio.h>

int main() {
    char buf[8];
    char target[] = "target value";
    gets(buf);
    printf("%s\n", target);
    return 0;
}
```

```shell
$ gcc bof.c
$ ./a.out

target value
$ ./a.out
AAAAAAAABOF
BOF
```

### Format String Bug

`printf` é–¢æ•°ã®ç¬¬ä¸€å¼•æ•°ã¯æ›¸å¼ (Format String) ã¨ã„ã„ã€`%` ã‹ã‚‰å§‹ã¾ã‚‹ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«ã‚ˆã£ã¦å¼•æ•°ã«å¯¾ã—ã¦æ–‡å­—åˆ—å‡¦ç†ã‚’è¡Œã„ã€åŸ‹ã‚è¾¼ã¿ã¾ã™ã€‚

```c
%[parameter][flags][width][.precision][length]type
```

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å…·ä½“ä¾‹ | èª¬æ˜ |
| --- | --- | --- |
| parameter | `6$` | ç¬¬äºŒå¼•æ•°ä»¥é™ã®å¼•æ•°ã®ç•ªå·ã‚’è¡¨ã™ã€‚é€šå¸¸ã€æ›¸å¼ãŒå‘¼ã°ã‚Œã‚‹åº¦ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã•ã‚Œã‚‹ãŒã“ã‚Œã«ã‚ˆã£ã¦ä¸€æ°—ã«é£›ã°ã™ã“ã¨ãŒå‡ºæ¥ã‚‹ã€‚x86-64 ã§ã¯ 6 ä»¥é™ã¯ã‚¹ã‚¿ãƒƒã‚¯ã‚’æŒ‡ã™ã€‚ |
| width | `40` `*` | å‡ºåŠ›ã™ã‚‹ãƒã‚¤ãƒˆé•·ã‚’è¡¨ã™ã€‚ |
| length | `hh` `h` `l` | å…¥åŠ›ã™ã‚‹é•·ã•ã‚’è¡¨ã™ã€‚å…·ä½“ä¾‹ã¯ãã‚Œãã‚Œ 1, 2, 8 ãƒã‚¤ãƒˆã‚’è¡¨ã—ã¦ã„ã‚‹ã€‚ |
| type | `d` `x` `p` `s` `n` ... | ãƒ‡ãƒ¼ã‚¿ã‚’ã©ã®ã‚ˆã†ã«è§£é‡ˆã™ã‚‹ã‹ã‚„æ›¸ãè¾¼ã¿ãªã©ã‚’è¡¨ã™ã€‚ |

https://en.wikipedia.org/wiki/Printf#Format_placeholder_specification

ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ãªä¾‹ãŒã‚ã‚Šã¾ã™ã€‚

- `%42x` ã¯ unsigned int ã‚’ 16 é€²æ•°ã¨ã—ã¦ 42 æ–‡å­—å‡ºåŠ›ã™ã‚‹ã€‚ä½™ã£ãŸæ–‡å­—ã¯ç©ºç™½ã¨ãªã‚‹ã€‚
- `%6$p` ã¯ç¬¬ 7 å¼•æ•°ã€ã¤ã¾ã‚Šã‚¹ã‚¿ãƒƒã‚¯ä¸Šã®å€¤ã‚’ãƒã‚¤ãƒ³ã‚¿ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ã€‚
- `%s` ã¯å¼•æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰æ–‡å­—åˆ—ã¨ã—ã¦ NULL ãƒã‚¤ãƒˆã¾ã§å‡ºåŠ›ã™ã‚‹ã€‚
- `%hhn` ã¯å¼•æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã“ã‚Œã¾ã§å‡ºåŠ›ã—ãŸæ–‡å­—æ•°ã‚’ 1 ãƒã‚¤ãƒˆæ›¸ãè¾¼ã‚€ã€‚Overflow ã™ã‚‹ã®ã§ä¸€å‘¨ã™ã‚Œã°ä»»æ„ã®å€¤ã‚’æ›¸ãè¾¼ã‚ã‚‹ã€‚

```c
#include <stdio.h>

char target[40] = "target value";

int main() {
    char buf[40];
    fgets(buf, 40, stdin);
    printf(buf, target, target + 1, target + 2);
    printf("%s\n", target);
    return 0;
}
```
```shell
$ gcc fsb.c
$ ./a.out
%p
0x55f90f928020
target value
$ ./a.out
%70x%1$hhn%13x%2$hhn%65519x%3$hn
...
FSB
```

## ã‚¹ã‚¿ãƒƒã‚¯é ˜åŸŸã«ãŠã‘ã‚‹æ”»æ’ƒæ–¹æ³•

### ã‚¢ã‚»ãƒ³ãƒ–ãƒªã¨ ABI
ã‚¢ã‚»ãƒ³ãƒ–ãƒªã¨ã¯æ©Ÿæ¢°èªã‚’äººé–“ã«èª­ã¿ã‚„ã™ãã—ãŸã‚‚ã®ã§ã™ã€‚

ã‚¢ã‚»ãƒ³ãƒ–ãƒªã¨æ©Ÿæ¢°èªã®å¯¾å¿œã‚„ãƒ¬ã‚¸ã‚¹ã‚¿ã®æƒ…å ±ãªã©ã¯ CPU ã®è¦æ ¼æ›¸ã«æ›¸ã‹ã‚Œã¦ã‚ã‚‹ã®ã§ã™ãŒèª­ã‚“ã§ã¿ã‚‹ã¨ã‚ã£ã£ã£ã£ã£ã£ã¡ã‚ƒé•·ã„ã§ã™ã€‚ãªã®ã§ã“ã“ã§ã¯ Stack Exploit ã«ãŠã„ã¦ç‰¹ã«é‡è¦ãªã‚¢ã‚»ãƒ³ãƒ–ãƒªå‘½ä»¤ã¨ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

- [IntelÂ® 64 and IA-32 Architectures Software Developer Manuals](https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html)
- [ARM Architecture Reference Manual](https://documentation-service.arm.com/static/5f8dacc8f86e16515cdb865a)
- [The RISC-V Instruction Set Manual](https://riscv.org/wp-content/uploads/2017/05/riscv-spec-v2.2.pdf)

é–¢æ•°ã‚’å‘¼ã‚“ã ã¨ãã©ã®ã‚ˆã†ãªå‡¦ç†ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã®ã‹ã‚’çŸ¥ã£ã¦ãŠãã¨æ”»æ’ƒã®è¦‹é€šã—ãŒå¤§åˆ†è‰¯ããªã‚‹ã®ã§ãã‚Œé–¢é€£ã®ã‚¢ã‚»ãƒ³ãƒ–ãƒªå‘½ä»¤ã¯æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚

| å‘½ä»¤ | èª¬æ˜ |
| --- | --- |
| `push` | `*rsp = value; rsp += 8` |
| `pop` | `rsp -= 8; register = *rsp` |
| `call` | é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚ŒãŸã¨ãã€æ¬¡ã®å‘½ä»¤ã®å®Ÿè¡Œã‚¢ãƒ‰ãƒ¬ã‚¹ (ãƒªã‚¿ãƒ¼ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹) ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã« push ã—ã¦ãŠãã€å¼•æ•°ã¯æ¬¡ã®ã‚ˆã†ã«ã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚ |
| `ret` | ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ pop ã—ã¦ rip ã«å…¥ã‚Œã¾ã™ã€‚ |

ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã¯ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã«ç¢ºä¿ã•ã‚Œã‚‹

| ç›®çš„ | x86-64 | ARM | RISC-V |
| --- | --- | --- | --- |
| é–¢æ•°ã®æˆ»ã‚Šå€¤ | rax | r0 | ra |
| syscall ç•ªå· | rax | r7 | a7 |
| ç¬¬ 1 å¼•æ•° | rdi | r0 | a0 |
| ç¬¬ 2 å¼•æ•° | rsi | r1 | a1 |
| ç¬¬ 3 å¼•æ•° | rdx | r2 | a2 |
| ç¬¬ 4 å¼•æ•° | r10 | r3 | a3 |
| ç¬¬ 5 å¼•æ•° | r8 | | a4 |
| ç¬¬ 6 å¼•æ•° | r9 | | a5 |
| ã‚¹ã‚¿ãƒƒã‚¯ãƒã‚¤ãƒ³ã‚¿ | rsp | r13 | sp |
| ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚«ã‚¦ãƒ³ã‚¿ | rip | pc | pc |

### ãƒªã‚¿ãƒ¼ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ›¸ãæ›ãˆ
ãƒªã‚¿ãƒ¼ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãæ›ãˆã‚Œã°å¥½ããªå ´æ‰€ã¸é£›ã°ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

- [å˜ç´”ãªã‚¹ã‚¿ãƒƒã‚¯ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼æ”»æ’ƒã‚’ã‚„ã£ã¦ã¿ã‚‹ - ã‚‚ã‚‚ã„ã‚ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼](https://inaz2.hatenablog.com/entry/2014/03/14/151011)

ä¾‹ãˆã° Out of bounds ã§ãƒªã‚¿ãƒ¼ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ `win()` ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ›¸ãæ›ãˆã‚Œã°å‡¦ç†ãŒçµ‚ã‚ã£ãŸå¾Œã« `win()` ãŒå‘¼ã°ã‚Œã¾ã™ã€‚ãã®å¾Œã‚¹ã‚¿ãƒƒã‚¯ãŒå£Šã‚Œã¦ã—ã¾ã£ãŸã®ã§ç„¡ç†ã‚„ã‚Šãƒªã‚¿ãƒ¼ãƒ³ã™ã‚‹ã¨å¤‰ãªã‚¢ãƒ‰ãƒ¬ã‚¹ã«é£›ã³ã€ãã“ãŒå®Ÿè¡Œé ˜åŸŸã§ã¯ãªã„ã¨ã Segmentation fault ã¨å‡ºã¾ã™ã€‚

```c
#include <stdio.h>

void win() {
    printf("win!\n");
}

int main() {
    void* a[4] = {};
    printf("ret addr: %p\n", a[7]);
    printf("win func: %p\n", win);
    a[7] = win;
    printf("overwrited ret addr: %p\n", a[7]);
    return 0;
}
```
```shell
$ gcc retaddr.c
$ ./a.out
ret addr: 0x7f8b28229d90
win func: 0x55d6655bd189
overwrited ret addr: 0x55d6655bd189
win!
Segmentation fault
```

### ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰

æ©Ÿæ¢°èª (shellcode) ã‚’ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã«åŸ‹ã‚è¾¼ã¿ã€rip ã‚’ãã“ã«é£›ã°ã—ã¾ã™ã€‚ã‚¹ã‚¿ãƒƒã‚¯ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒåˆ†ã‹ã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

- `system("/bin/sh")`
- `execve("/bin/sh", NULL, NULL)`
- `open("flag") -> read() -> write()`
  - chroot ç’°å¢ƒã§ `/bin/sh` ãŒãªã‹ã£ãŸã‚Šã€seccomp ã«ã‚ˆã£ã¦ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’åˆ¶é™ã•ã‚Œã¦ã„ã‚‹ã¨ãã«ä½¿ã„ã¾ã™ã€‚

[å›³å¼ã•ã‚ŒãŸ x86 ã®å‘½ä»¤é›†](https://hikalium.github.io/opv86/)

### GOT overwrite
å®Ÿè¡Œæ™‚ã«ãƒªãƒ³ã‚¯ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (å‹•çš„ãƒ©ã‚¤ãƒ–ãƒ©ãƒª) ã¯ãƒ’ãƒ¼ãƒ—é ˜åŸŸä¸Šã«ãƒ©ãƒ³ãƒ€ãƒ ã«ç½®ã‹ã‚Œã¾ã™ã€‚ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è§£æ±ºã—ã¦å‘¼ã³å‡ºã™ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿæ§‹ãŒ GOT / PLT ã§ã™ã€‚

- GOT (Global Offset Table)
  - æœ€åˆã¯ PLT ã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®è¡¨ã¨ãªã£ã¦ã„ã¦ã€ã‚¢ãƒ‰ãƒ¬ã‚¹è§£æ±ºå¾Œã¯ç›´æ¥ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹
- PLT (Procedure Linkage Table)
  - ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è§£æ±ºã—ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‘¼ã³å‡ºã™é–¢æ•°è¡¨

ã‚ˆã‚Šè©³ç´°ãªå‡¦ç†ã¯é•·ããªã‚‹ã®ã§ç•¥ã—ã¾ã™ã€‚

è¦ã™ã‚‹ã«ã“ã® GOT ã‚’æ›¸ãæ›ãˆã‚‹ã“ã¨ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‘¼ã³å‡ºã—ãŸã¨ãã« rip ã‚’å¥ªå–ã§ãã¾ã™ã€‚

ã¾ãŸ PLT ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒªã‚¿ãƒ¼ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸æ›¸ãè¾¼ã‚€ã“ã¨ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«é£›ã°ã™ã“ã¨ã‚‚ã§ãã€ãã®æ”»æ’ƒæ‰‹æ®µã‚’ ret2plt ã¨ã„ã„ã¾ã™ã€‚

```shell
pwndbg> got

GOT protection: Full RELRO | GOT functions: 3

[0x55a3cb9f2fc0] free@GLIBC_2.2.5 -> 0x7fda9a390740 (free) â—‚â€” endbr64
[0x55a3cb9f2fc8] __stack_chk_fail@GLIBC_2.4 -> 0x7fda9a4213b0 (__stack_chk_fail) â—‚â€” endbr64
[0x55a3cb9f2fd0] malloc@GLIBC_2.2.5 -> 0x7fda9a390130 (malloc) â—‚â€” endbr64
```

### Return-Oriented Programming

ãƒªã‚¿ãƒ¼ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ›¸ãæ›ãˆã‚’æ›´ã«æŠ¼ã—é€²ã‚ã‚‹ã“ã¨ã§ Return-Oriented Programming (ROP) ã¨ãªã‚Šã¾ã™ã€‚

ret å‘½ä»¤ã§çµ‚ã‚ã‚‹å°‘ãªã„å‘½ä»¤åˆ— (Gadget) ãŒæ©Ÿæ¢°èªã®ä¸­ã«ã‚ã‚‹ã®ã§ãã‚Œã‚’ return address ã®æ›¸ãæ›ãˆã§å‘¼ã³å‡ºã™æ”»æ’ƒæ‰‹æ³•ã§ã™ã€‚

å‘¼ã³å‡ºã™é–¢æ•°ã®å¼•æ•°ãŒã‚¹ã‚¿ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã€ãã®å¾Œ 2 ã¤ä»¥ä¸Šã®é–¢æ•°ã‚’å‘¼ã¶å ´åˆã¯å¼•æ•°ãŒ Gadget ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«å¼•æ•°ã‚’å‰Šé™¤ã™ã‚‹ `pop ret` ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’æŒŸã‚€ã€‚

ã¾ãŸ Gadget ã‚’è¦‹ã¤ã‘ã‚‹éš›ã«é‡å®ã™ã‚‹ãƒ„ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚

https://github.com/david942j/one_gadget
https://github.com/JonathanSalwan/ROPgadget

```shell
$ ROPgadget --binary ./chall
Gadgets information
============================================================
0x000000000000121b : add byte ptr [rax], 0 ; add byte ptr [rax], al ; endbr64 ; jmp 0x11a0
0x0000000000001193 : add byte ptr [rax], 0 ; add byte ptr [rax], al ; ret
0x000000000000121c : add byte ptr [rax], al ; add byte ptr [rax], al ; endbr64 ; jmp 0x11a0
0x00000000000014cc : add byte ptr [rax], al ; add byte ptr [rax], al ; endbr64 ; ret
0x0000000000001194 : add byte ptr [rax], al ; add byte ptr [rax], al ; ret
0x0000000000001036 : add byte ptr [rax], al ; add dl, dh ; jmp 0x1020
0x0000000000001210 : add byte ptr [rax], al ; add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax] ; ret
0x000000000000121e : add byte ptr [rax], al ; endbr64 ; jmp 0x11a0
0x00000000000014ce : add byte ptr [rax], al ; endbr64 ; ret
0x00000000000013f6 : add byte ptr [rax], al ; mov eax, dword ptr [rbp - 4] ; leave ; ret
0x0000000000001386 : add byte ptr [rax], al ; pop rbp ; ret
0x0000000000001196 : add byte ptr [rax], al ; ret
0x000000000000100d : add byte ptr [rax], al ; test rax, rax ; je 0x1016 ; call rax
0x0000000000001188 : add byte ptr [rax], al ; test rax, rax ; je 0x1198 ; jmp rax
0x00000000000011c9 : add byte ptr [rax], al ; test rax, rax ; je 0x11d8 ; jmp rax
0x00000000000011d5 : add byte ptr [rax], r8b ; ret
0x0000000000001211 : add byte ptr [rcx], al ; pop rbp ; ret
0x00000000000013c3 : add byte ptr [rdi + 7], bh ; mov eax, 0xffffffff ; jmp 0x13fb
0x0000000000001187 : add byte ptr cs:[rax], al ; test rax, rax ; je 0x1198 ; jmp rax
0x00000000000011c8 : add byte ptr cs:[rax], al ; test rax, rax ; je 0x11d8 ; jmp rax
0x0000000000001038 : add dl, dh ; jmp 0x1020
0x0000000000001212 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax] ; ret
0x0000000000001085 : add eax, 0xf2000000 ; jmp 0x1020
0x0000000000001453 : add eax, 0xfffc87e8 ; dec ecx ; ret
0x00000000000013f3 : add eax, edx ; mov byte ptr [rax], 0 ; mov eax, dword ptr [rbp - 4] ; leave ; ret
0x0000000000001017 : add esp, 8 ; ret
0x0000000000001016 : add rsp, 8 ; ret
0x00000000000011c7 : and eax, 0x4800002e ; test eax, eax ; je 0x11d8 ; jmp rax
0x000000000000103e : call qword ptr [rax - 0x5e1f00d]
0x0000000000001014 : call rax
0x00000000000013c2 : cld ; add byte ptr [rdi + 7], bh ; mov eax, 0xffffffff ; jmp 0x13fb
0x00000000000013fa : cld ; leave ; ret
0x0000000000001223 : cli ; jmp 0x11a0
0x00000000000014d3 : cli ; ret
0x00000000000014db : cli ; sub rsp, 8 ; add rsp, 8 ; ret
0x0000000000001362 : dec ecx ; ret
0x0000000000001220 : endbr64 ; jmp 0x11a0
0x00000000000014d0 : endbr64 ; ret
0x00000000000014ac : fisttp word ptr [rax - 0x7d] ; ret
0x000000000000100b : fldcw word ptr [rdi] ; add byte ptr [rax], al ; test rax, rax ; je 0x1016 ; call rax
0x0000000000001012 : je 0x1016 ; call rax
0x000000000000118d : je 0x1198 ; jmp rax
0x00000000000011ce : je 0x11d8 ; jmp rax
0x00000000000013c4 : jg 0x13cd ; mov eax, 0xffffffff ; jmp 0x13fb
0x000000000000103a : jmp 0x1020
0x0000000000001224 : jmp 0x11a0
0x0000000000001339 : jmp 0x12a2
0x00000000000012ca : jmp 0x1323
0x000000000000128e : jmp 0x1363
0x00000000000013cb : jmp 0x13fb
0x0000000000001441 : jmp 0x143f
0x000000000000118f : jmp rax
0x0000000000001384 : jne 0x1386 ; add byte ptr [rax], al ; pop rbp ; ret
0x0000000000001363 : leave ; ret
0x00000000000011d1 : loopne 0x1239 ; nop dword ptr [rax + rax] ; ret
0x00000000000013f5 : mov byte ptr [rax], 0 ; mov eax, dword ptr [rbp - 4] ; leave ; ret
0x000000000000120c : mov byte ptr [rip + 0x2dfd], 1 ; pop rbp ; ret
0x0000000000001289 : mov eax, 0xffffffff ; jmp 0x1363
0x00000000000013c6 : mov eax, 0xffffffff ; jmp 0x13fb
0x00000000000013f8 : mov eax, dword ptr [rbp - 4] ; leave ; ret
0x00000000000011d3 : nop dword ptr [rax + rax] ; ret
0x0000000000001191 : nop dword ptr [rax] ; ret
0x00000000000011d2 : nop word ptr [rax + rax] ; ret
0x00000000000011cf : or bh, bh ; loopne 0x1239 ; nop dword ptr [rax + rax] ; ret
0x00000000000014bc : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
0x00000000000014be : pop r13 ; pop r14 ; pop r15 ; ret
0x00000000000014c0 : pop r14 ; pop r15 ; ret
0x00000000000014c2 : pop r15 ; ret
0x00000000000014bb : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
0x00000000000014bf : pop rbp ; pop r14 ; pop r15 ; ret
0x0000000000001213 : pop rbp ; ret
0x00000000000014c3 : pop rdi ; ret
0x00000000000014c1 : pop rsi ; pop r15 ; ret
0x00000000000014bd : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret
0x000000000000101a : ret
0x000000000000131f : retf 0x1088
0x00000000000013f4 : rol dh, 1 ; add byte ptr [rax], al ; mov eax, dword ptr [rbp - 4] ; leave ; ret
0x0000000000001011 : sal byte ptr [rdx + rax - 1], 0xd0 ; add rsp, 8 ; ret
0x000000000000105b : sar edi, 0xff ; call qword ptr [rax - 0x5e1f00d]
0x000000000000120e : std ; sub eax, 0x5d010000 ; ret
0x000000000000120f : sub eax, 0x5d010000 ; ret
0x00000000000014dd : sub esp, 8 ; add rsp, 8 ; ret
0x00000000000014dc : sub rsp, 8 ; add rsp, 8 ; ret
0x0000000000001010 : test eax, eax ; je 0x1016 ; call rax
0x000000000000118b : test eax, eax ; je 0x1198 ; jmp rax
0x00000000000011cc : test eax, eax ; je 0x11d8 ; jmp rax
0x000000000000100f : test rax, rax ; je 0x1016 ; call rax
0x000000000000118a : test rax, rax ; je 0x1198 ; jmp rax
0x00000000000011cb : test rax, rax ; je 0x11d8 ; jmp rax

Unique gadgets found: 89

$ one_gadget ./libc.so.6
0x4f2c5 execve("/bin/sh", rsp+0x40, environ)
constraints:
  rsp & 0xf == 0
  rcx == NULL

0x4f322 execve("/bin/sh", rsp+0x40, environ)
constraints:
  [rsp+0x40] == NULL

0x10a38c execve("/bin/sh", rsp+0x70, environ)
constraints:
  [rsp+0x70] == NULL
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹

ã‚¹ã‚¿ãƒƒã‚¯é ˜åŸŸã‚„ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã¨ã—ã¦ NX, ASLR, RELRO, PIE, Stack Canary ãªã©ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹ (Mitigations) ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã‚‰ã‚’ ELF ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª¿ã¹ã¦ãã‚Œã‚‹ checksec ã¨ã„ã†ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚ã‚Šã¾ã™ã€‚pwndbg ã® `checksec` ã‚³ãƒãƒ³ãƒ‰ã‚‚ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¨ã—ã¦ã‚ã‚Šã¾ã™ã€‚

https://github.com/slimm609/checksec.sh

```shell
$ checksec --file=a.out
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable   FILE
Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   38) Symbols       No    0               0    a.out
```

### Stack Canary

é–¢æ•°å‘¼ã³å‡ºã—æ™‚ã« return address ã®æ¬¡ã« Master Canary ã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ (Canary) ã‚’é…ç½®ã—ã€return å‰ã« Canary ãŒå¤‰åŒ–ã—ãŸã‹ `__stack_chk_fail` é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦æ¤œè¨¼ã—ã€å¤‰ã‚ã£ã¦ã„ãŸã‚‰ä¾‹å¤–ã‚’é€å‡ºã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦é€£ç¶šçš„ã«æ›¸ãè¾¼ã‚€ BOF ã‚’æ¤œçŸ¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã‚’å›é¿ã—ã¦ BOF ã™ã‚‹ã«ã¯ Canary ã‚’èª­ã¿å‡ºã—ãŸã‚Šã€ 1 ãƒã‚¤ãƒˆãšã¤ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã™ã‚‹ã“ã¨ã§ Canary ã‚’æ‰‹ã«å…¥ã‚Œã¦ BOF æ™‚ã«æ›¸ãè¾¼ã‚ã°æ¤œæŸ»ã«ã²ã£ã‹ã‹ã‚Šã¾ã›ã‚“ã€‚

ã¾ãŸ Master Canary ã¯ TLS (Thread Local Storage) ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚(x86-64 ã§ã¯ fs:0x28)
ã“ã‚Œè‡ªä½“ã‚’æ›¸ãæ›ãˆã‚‹ã¨ã„ã†æ”»æ’ƒæ‰‹æ³•ã‚’ Master Canary Forging ã¨ã„ã„ã¾ã™ã€‚potetisensei ã®è§£èª¬ã‚’è¼‰ã›ã¦ãŠãã¾ã™ã€‚

https://www.youtube.com/watch?v=UTC2iWxQ4qc

### No eXecute bit
No eXecute bit (NX bit) ã¯èª­ã¿æ›¸ãã®ãƒ•ãƒ©ã‚°ã®ä»–ã« CPU ãŒç‰¹å®šã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å®Ÿè¡Œã§ããªã„ã‚ˆã†ã«ã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ä¸Šã§ W^X (Write xor Execute) ãŒæˆã‚Šç«‹ã¤ã‚ˆã†ã«ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ã“ã¨ã§ shellcode ãŒé›£ã—ããªã‚Šã¾ã—ãŸã€‚

ã“ã‚Œã‚’å›é¿ã—ã¦ shellcode ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ RWX ã®ãƒ¡ãƒ¢ãƒªé ˜åŸŸã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ ret2plt ã‚„ ret2libc ã«ã‚ˆã£ã¦ `mmap()` `mprotect()` ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ä½œã‚Œã‚‹ã®ã§å›é¿ã§ãã¾ã™ã€‚

### RELRO
glibc ãªã©ã®å‹•çš„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒªãƒ³ã‚¯ã™ã‚‹ã¨ãã€lazy binding ã¨ã„ã£ã¦ã‚·ãƒ³ãƒœãƒ«åã®æ¤œç´¢ã¨ã‚¢ãƒ‰ãƒ¬ã‚¹ã®è§£æ±ºã«ã¤ã„ã¦ã¯å‘¼ã³å‡ºã—æ™‚ã¾ã§é…å»¶ã•ã›ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®èµ·å‹•ã‚’æ—©ã‚ã¾ã™ã€‚ãŸã  GOT overwrite ã«å¯¾ã—ã¦èµ·å‹•æ™‚ã«å…¨ã¦è¡Œã„ã€æ›¸ãè¾¼ã¿ç¦æ­¢ã¨ã™ã‚‹ã®ãŒ RELRO (RELocation Read-Only) ã§ã™ã€‚

|  | lazy binding | RELRO |
| --- | --- | --- |
| No RELRO | Yes | No |
| Partial RELRO | Yes | Yes |
| Full RELRO | No | Yes |

### ASLR & PIE
Address Space Layout Randomization (ASLR) ã¯ã‚¹ã‚¿ãƒƒã‚¯ã‚„ãƒ’ãƒ¼ãƒ—ã€å‹•çš„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒç½®ã‹ã‚Œã‚‹ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã™ã‚‹æ©Ÿæ§‹ã§ã™ã€‚

ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•æ™‚ã«ãƒšãƒ¼ã‚¸å˜ä½ (0x1000) ã§ä»®æƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¯¾å¿œãŒã•ã‚Œã¾ã™ã€‚

```
$ cat /proc/<pid>/maps
```

Position-Independent Executables (PIE) ã¯ .text é ˜åŸŸã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã™ã‚‹æ©Ÿæ§‹ã§ã™ã€‚jump ã‚„ call ã¯å…¨ã¦ç›¸å¯¾ã‚¢ãƒ‰ãƒ¬ã‚¹æŒ‡å®šã¨ãªã‚Šã¾ã™ã€‚

ASLR & PIE ã«ã‚ˆã£ã¦ exploit ãŒä¸€æ®µéšé›£ã—ããªã‚Šã¾ã—ãŸã€‚

ãŸã ä¾ç„¶ã¨ã—ã¦ç›¸å¯¾çš„ã«ã¯ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯åŒã˜ã§ã‚ã‚‹ãŸã‚ã€ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ã«ã—ã¦ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- ã‚¹ã‚¿ãƒƒã‚¯ã«ç©ã¾ã‚ŒãŸãƒªã‚¿ãƒ¼ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å€¤ã‹ã‚‰ã€.text é ˜åŸŸã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨ˆç®—ã§ãã‚‹ã€‚ã“ã‚Œã‚’ .text é ˜åŸŸãŒåˆ†ã‹ã‚‹ã¨ .data .bss .plt .got.plt ãªã©ã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚è‰²ã€…ã‚ã‹ã‚‹ã€‚
- ä¸€åº¦å‘¼ã³å‡ºã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªé–¢æ•°ã® GOT ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å€¤ã‹ã‚‰ã€ãã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨ˆç®—ã§ãã‚‹ã€‚
- ã‚¹ã‚¿ãƒƒã‚¯ã«ç©ã¾ã‚ŒãŸsaved ebpã®å€¤ã‹ã‚‰ã€ã‚¹ã‚¿ãƒƒã‚¯é ˜åŸŸã«ç½®ã‹ã‚Œã‚‹ä»–ã®ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨ˆç®—ã§ãã‚‹ã€‚
- ãƒ’ãƒ¼ãƒ—é ˜åŸŸã«ç¢ºä¿ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’æŒ‡ã™ãƒã‚¤ãƒ³ã‚¿ã®å€¤ã‹ã‚‰ã€ãƒ’ãƒ¼ãƒ—é ˜åŸŸã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨ˆç®—ã§ãã‚‹ã€‚

ç‰¹ã« libc ã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ±‚ã‚ã‚‹ã“ã¨ã¯å¤§å¤‰é‡è¦ã§ã€ libc leak ã¨ã„ã„ã¾ã™ã€‚libc leak ã§ãã‚‹ã¨ä¾‹ãˆã°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‘¼ã³å‡ºã—ãŸã‚Š (ret2libc)ã€æ–‡å­—åˆ— `/bin/sh` ã‚‚ libc å†…ã«ã‚ã‚‹ã®ã§ã‚·ã‚§ãƒ«èµ·å‹•ãŒç°¡å˜ã«ãªã‚Šã¾ã™ã€‚

```python
from pwn import *

libc = ELF('libc.so')
system_offset = libc.symbols['system']
sh_offset = next(libc.search('sh\x00'))
binsh_offset = next(libc.search('/bin/sh\x00'))
```

### ASCII-armor

å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ `0x00XXXXXX` ã®ã‚ˆã†ã« `\x00` ã‚’å«ã‚ã‚‹ã“ã¨ã§ BOF ã«ã‚ˆã£ã¦æ›¸ãè¾¼ã‚€ã“ã¨ã‚’é›£ã—ãã™ã‚‹æ©Ÿæ§‹ã§ã™ã€‚

### Control Flow Integrity

ROP, JOP å¯¾ç­–ã¨ã—ã¦å°å…¥ã•ã‚ŒãŸä¸»ã« CPU ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹ã§ã™ã€‚Intel, ARM, RISC-V ã«ãŠã‘ã‚‹ CFI (Control Flow Integrity) æ‹¡å¼µã‚’ã¾ã¨ã‚ã¾ã™ã€‚

- Intel CET Shadow Stack
  - call å‘½ä»¤ã§ return address ã‚’ shadow stack ã« push ã—ã€ret å‘½ä»¤ã§ pop ã—ã¦ä¸€è‡´ã—ãªã‘ã‚Œã°ä¾‹å¤–ã‚’é€å‡ºã™ã‚‹ã€‚æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã›ãšã«é©ç”¨ã§ãã‚‹ã®ãŒå¼·ã¿ã€‚
- Intel CET Indirect Branch Tracking (IBT)
  - jump å…ˆã« endbranch å‘½ä»¤ã‚’åŸ‹ã‚è¾¼ã¿ã€é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã®å…ˆãŒ endbranch å‘½ä»¤ã‚’æŒ‡ã—ã¦ã„ãªã„å ´åˆã«ã¯ä¾‹å¤–ãŒé€å‡ºã•ã‚Œã‚‹æ©Ÿæ§‹ã€‚JOP ã®æ¤œçŸ¥ãŒã§ãã‚‹ã€‚
- ARM Branch Target Identification (BTI)
  - br/blr å‘½ä»¤ã«ã‚ˆã£ã¦ jump ã—ãŸå…ˆãŒ bti å‘½ä»¤ä»¥å¤–ã§ã‚ã‚Œã°ä¾‹å¤–ã‚’é€å‡ºã™ã‚‹æ©Ÿæ§‹ã€‚PTE ã® GP ãƒ“ãƒƒãƒˆãŒç«‹ã£ã¦ã„ã‚‹ã¨ãã«ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²ã§ã® BTI ãŒæœ‰åŠ¹ã«ãªã‚‹ã€‚JOP ã®æ¤œçŸ¥ãŒã§ãã‚‹ã€‚
- ARM Pointer Authentication (PAC)
  - PAC å‘½ä»¤ã§ 64 bit ãƒã‚¤ãƒ³ã‚¿ã®ä¸Šä½ 8 bit ã«ã‚¿ã‚°, 3-23 bit ã«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç½²åã‚’åŸ‹ã‚è¾¼ã¿ã€AUTH å‘½ä»¤ã§èªè¨¼ã—ã€ç„¡åŠ¹ãªç½²åã‚’æŒã¤å ´åˆã«ä¾‹å¤–ãŒé€å‡ºã•ã‚Œã‚‹æ©Ÿæ§‹ã€‚ç½²åã¯ QARMA ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ã€‚ROP ã®æ¤œçŸ¥ãŒã§ãã‚‹ã€‚
- ARM Memory Tagging Extension (MTE)
  - ãƒ¡ãƒ¢ãƒªã«ã‚¿ã‚°ã‚’å‰²ã‚Šå½“ã¦ã€ãƒã‚¤ãƒ³ã‚¿ã®ä¸Šä½ 4 bit ã«ã‚¿ã‚°ã‚’åŸ‹ã‚è¾¼ã¿ã€ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«ãã‚Œã‚‰ãŒä¸ä¸€è‡´ã®å ´åˆã«ã¯ä¾‹å¤–ãŒé€å‡ºã•ã‚Œã‚‹æ©Ÿæ§‹ã€‚Use After Free ã®æ¤œçŸ¥ãŒã§ãã‚‹ã€‚
- RISC-V CFI Shadow Stack
  - ç‰¹æ®Šãªãƒ¡ãƒ¢ãƒªé ˜åŸŸã« Shadow Stack ã‚’ç¢ºä¿ã—ã€return address ã®ã¿ã®èª­ã¿æ›¸ãã‚’ã™ã‚‹ã€‚sspush, sspop, sschkra å‘½ä»¤ã«ã‚ˆã£ã¦ return address ã®ãƒ—ãƒƒã‚·ãƒ¥ã€ãƒãƒƒãƒ—ã€æ¯”è¼ƒã‚’ã—ã€ä¸ä¸€è‡´ãªã‚‰ã°ä¾‹å¤–ã‚’é€å‡ºã™ã‚‹ã€‚
- RISC-V CFI Landing Pads
  - æ–°ã—ã„å‘½ä»¤ lpsll, lpcll å‘½ä»¤ã‚’è¿½åŠ ã—ã¦ jalr å‘½ä»¤ã®åˆ†å²å‰ã¨åˆ†å²å¾Œã§ label ã‚’ç…§åˆã™ã‚‹ã“ã¨ã§æƒ³å®šã•ã‚ŒãŸçµ„ã¿åˆã‚ã›ã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã€ä¸ä¸€è‡´ãªã‚‰ä¾‹å¤–ã‚’é€å‡ºã™ã‚‹ã€‚ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ãƒ„ãƒ¼ãƒ«ãƒã‚§ã‚¤ãƒ³å´ãŒå®Ÿè£…ã™ã‚‹éš›ã«ãƒã‚°ãŒç™ºç”Ÿã—ãã†ãªã“ã¨ãŒæŒ™ã’ã‚‰ã‚Œã‚‹ã€‚

ã“ã‚Œã‚‰ã«ã‚ˆã£ã¦ ROP ã¯ä¸å¯èƒ½ã«ãªã£ãŸã¨ã„ã£ã¦ã‚‚ã„ã„ã§ã—ã‚‡ã†ã€‚

CFI ã‚’ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã§å®Ÿè£…ã™ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ã™ãŒã“ã‚Œã«é–¢ã—ã¦ã¯æ§˜ã€…ãªè„†å¼±æ€§ãŒè¦‹ã¤ã‹ã£ã¦ã„ã‚‹ã®ã§ãã“ã‚’æ”»æ’ƒã™ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã™ã€‚

## ãƒ„ãƒ¼ãƒ«
ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œãƒã‚¤ãƒŠãƒªã‚’å‹•ã‹ã—ã¦è§£æã—ãŸã„ã¨ããƒ‡ãƒãƒƒã‚¬ãƒ¼ãŒé‡å®ã—ã¾ã™ã€‚ELF ã®ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãªãƒ‡ãƒãƒƒã‚¬ãƒ¼ã¯ gdb ã§ã€ä½¿ã„æ–¹ã¯ä»–ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

ã¾ãŸã€gdb ã«æ‹¡å¼µçš„ãªæ©Ÿèƒ½ã‚’ä¸ãˆã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚é–‹ç™ºã•ã‚Œã¦ã„ã¦ã€ç¾åœ¨ã€ä¸»è¦ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚å…¨éƒ¨ã‚»ãƒƒãƒˆã§å…¥ã‚Œã‚‰ã‚Œã‚‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚‚ã‚ã‚Šã¾ã™ã€‚

- gdb-peda
- pwndbg (ã‚³ãƒãƒ³ãƒ‰ãŒè±Šå¯Œã§ãŠã™ã™ã‚)
- gef

https://github.com/apogiatzis/gdb-peda-pwndbg-gef

å¤§æŠµã®å•é¡Œã¯ `nc` ã‚³ãƒãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¦ãƒã‚¤ãƒŠãƒªãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ãªå½¢å¼ã§ä¸»é¡Œã•ã‚Œã€å®Ÿè¡Œãƒã‚¤ãƒŠãƒªã‚„ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚‚é…ã‚‰ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã®é€šä¿¡ã‚’ç°¡å˜ã«å–ã‚Šæ‰±ã„ãŸã„ã€ã¾ãŸãƒã‚¤ãƒŠãƒªã‚’è§£æã—ãŸã„ã¨ã„ã†ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½œã‚‰ã‚ŒãŸ pwntoolsã€ãã—ã¦ãã‚Œã‚’æ”¹è‰¯ã—ãŸ ptrlib ã¨ã„ã† Python ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚ˆã†ãªä¾¿åˆ©ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¤šãã€è¨€èªã¯ Python ãŒé¸ã°ã‚Œã‚„ã™ã„ã§ã™ã€‚

https://github.com/Gallopsled/pwntools
https://github.com/ptr-yudai/ptrlib

pwn ã§ç§ãŒã„ã¤ã‚‚ä½¿ã£ã¦ã„ã‚‹ Python ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚

```python
from pwn import *
import sys

binary_path = './chall'

if len(sys.argv) == 3:
    io = remote(sys.argv[1], int(sys.argv[2]))
else:
    io = process(binary_path)
elf = ELF(binary_path)
# libc = ELF("./libc.so.6")

def wait_for_attach():
    print('attach?')
    raw_input()

payload = b''
io.sendlineafter(b'> ', payload)
io.recvline()
io.interactive()
```

# ã¾ã¨ã‚
ã‚¹ã‚¿ãƒƒã‚¯é ˜åŸŸã«é–¢ã™ã‚‹ exploit ã¯ pwn ã® begginer / easy ãƒ¬ãƒ™ãƒ«ã«å½“ãŸã‚‹ã®ã§è§£ã‘ã‚‹ã‚ˆã†ã«ãªã‚‹ã¨åˆå¿ƒè€…è„±å´ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

æ¬¡ã¯ãƒ’ãƒ¼ãƒ—é ˜åŸŸã«é–¢ã™ã‚‹ exploit ã§ã™ã€‚å°‘ã—é›£ã—ã„ã§ã™ãŒåŸºæœ¬çš„ã«ã¯ã“ã“ã§ã‚„ã£ãŸè€ƒãˆæ–¹ã¨åŒã˜ãªã®ã§ã‚ˆãç†è§£ã—ã¦æŒ‘ã‚“ã§ãã ã•ã„ã€‚
