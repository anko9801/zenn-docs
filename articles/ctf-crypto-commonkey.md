---
title: "ã€CTF æ¢è¨ªè¨˜ã€‘å…±é€šéµæš—å·ã¸ã®æ”»æ’ƒ"
emoji: "ğŸª„"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CTF", "crypto"]
published: true
---

ã“ã®è¨˜äº‹ã¯å„æš—å·ã‚’ç†è§£ã—ã¦è§£èª­ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚·ãƒªãƒ¼ã‚ºã®ä¸€éƒ¨ã§ã™ã€‚ã“ã®ã‚·ãƒªãƒ¼ã‚ºã®ä¸€è¦§ã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

- [Crypto å…¥é–€](https://zenn.dev/anko/articles/ctf-crypto-begginer)
- [å…±é€šéµæš—å·ã¸ã®æ”»æ’ƒ](https://zenn.dev/anko/articles/ctf-crypto-commonkey)
- [ãªãœå…¬é–‹éµæš—å·ã¯å®‰å…¨ãªã®ã‹](https://zenn.dev/anko/articles/ctf-crypto-publickey)
- [RSA æš—å·ã¸ã®æ”»æ’ƒ](https://zenn.dev/anko/articles/ctf-crypto-rsa)
- [æ¥•å††æ›²ç·šæš—å·ã¸ã®æ”»æ’ƒ](https://zenn.dev/anko/articles/ctf-crypto-ellipticcurve)
- [ä¹±æ•°ã¨ãƒãƒƒã‚·ãƒ¥ã¸ã®æ”»æ’ƒ](https://zenn.dev/anko/articles/ctf-crypto-random)
- [æ ¼å­æš—å·ã¸ã®æ”»æ’ƒ](https://zenn.dev/anko/articles/ctf-crypto-lattice)

ä»Šå›ã¯å…±é€šéµæš—å·ã‚’æ”»æ’ƒã™ã‚‹ã“ã¨ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

> **å…±é€šéµæš—å·**
> æš—å·åŒ–ã¨å¾©å·ã§ **åŒã˜éµ** ã‚’ä½¿ã„ã€æš—å·åŒ–ã§ä½¿ã†éµã‚’ **ç§˜å¯†** ã«ã™ã‚‹æ–¹å¼
> ex.) AES, DES, ChaCha20 ãªã©

ã“ã“ã§ã¯ãƒã‚¤ãƒˆåˆ—ã‚’ã‚ã¡ã‚ƒãã¡ã‚ƒä½¿ã†ã®ã§çŸ­ãã™ã‚‹ç‚ºã«è¨˜å·ã‚„ã‚‰ã‚’å°å…¥ã—ã¾ã™ã€‚

> **Def. ãƒã‚¤ãƒˆåˆ—**
> ãƒã‚¤ãƒˆåˆ—ã¨ã¯ãƒ¡ãƒ¢ãƒªä¸Šã§è¡¨ç¾ã•ã‚Œã‚‹ 0 ã¨ 1 ã®ç¾…åˆ—ã§ã‚ã‚‹ã€‚UTF-8 ãªã©ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãªè¦æ ¼ã«ã‚ˆã‚Šãƒã‚¤ãƒˆåˆ—ã¯æ–‡å­—åˆ—ã‚„æ•´æ•°ã€æµ®å‹•å°æ•°ç‚¹ã€å¤šé …å¼ã¨ç›¸äº’å¤‰æ›ã§ãã€åŒä¸€è¦–ã™ã‚‹ã“ã¨ã«ã™ã‚‹ã€‚ã•ã‚‰ã«ãƒã‚¤ãƒˆåˆ— $B, B_1, B_2$ ã«å¯¾ã—ã¦ã„ãã¤ã‹æ¼”ç®—ã‚’å®šç¾©ã™ã‚‹ã€‚
> - ãƒã‚¤ãƒˆåˆ— $B_1, B_2$ ã‚’ãƒ¡ãƒ¢ãƒªä¸Šã§é€£ç¶šã«åŒã˜é †åºã§é…ç½®ã—ãŸãƒã‚¤ãƒˆåˆ—ã‚’ $B_1\|B_2$ ã¨æ›¸ãã€$B_1$ ã¨ $B_2$ ã®é€£çµã¨ã„ã†ã€‚
> - ãƒã‚¤ãƒˆåˆ— $B$ ã®ãƒ“ãƒƒãƒˆé•·ã‚’ $\mathrm{len}(B)$ ã¨æ›¸ãã€‚
> - åŒã˜é•·ã•ã®ãƒã‚¤ãƒˆåˆ— $B_1, B_2$ ã«å¯¾ã—ã€å„ãƒ“ãƒƒãƒˆã«ãŠã„ã¦ XOR æ¼”ç®—ã—ãŸãƒã‚¤ãƒˆåˆ—ã‚’ $B_1\oplus B_2$ ã¨æ›¸ãã€$B_1$ ã¨ $B_2$ ã® XOR ã¨ã„ã†ã€‚
> - $n$-bit ãƒ–ãƒ­ãƒƒã‚¯ã¨ã—ã¦å‰ç½®ãƒ»å¾Œç½®ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹é–¢æ•°ã‚’ãã‚Œãã‚Œ $Z_{f, n}(B), Z_{b, n}(B)$ ã¨æ›¸ãã€‚

## AES
AES (Advanced Encryption Standard) ã¯ 2000 å¹´ã« NIST ãŒå…¬å‹Ÿã—é¸å®šã—ãŸæš—å·æ¨™æº–ã§ã€ 2001 å¹´ 11 æœˆã« [FIPS PUB 197](https://nvlpubs.nist.gov/nistpubs/fips/nist.fips.197.pdf) ã¨ã—ã¦å…¬è¡¨ã•ã‚Œã¾ã—ãŸã€‚

AES ã®é¸å®šã§ã¯æ¬¡ã®ã‚ˆã†ãªæ¡ä»¶ã‚’èª²ã—ã¾ã—ãŸã€‚

- ãƒ–ãƒ­ãƒƒã‚¯æš—å·ã§ãƒ–ãƒ­ãƒƒã‚¯é•·ãŒ 128 ãƒ“ãƒƒãƒˆã§ã‚ã‚‹ã“ã¨
- æš—å·å¼·åº¦ãŒé«˜ãå‡¦ç†ãŒé«˜é€Ÿã«è¡Œãˆã‚‹ã“ã¨
- éµé•·ã¯ 128, 192, 256 ã® 3 ç¨®é¡ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨
- ä»•æ§˜ã¨è¨­è¨ˆåŸºæº–ãŒå®Œå…¨ã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ•ãƒªãƒ¼ã§ä½¿ç”¨ã§ãã‚‹ã“ã¨

AES ã¯ã‚ã‚‹ãƒ©ã‚¦ãƒ³ãƒ‰é–¢æ•°ã‚’ç¹°ã‚Šè¿”ã™ SPN æ§‹é€  (Substitution Permutation Network Structure) ã§åŸºæœ¬çš„ã«æ¬¡ã® 4 ã¤ã®æ“ä½œã‚’ 1 ãƒ©ã‚¦ãƒ³ãƒ‰ã¨ã—ã¦ 10 ãƒ©ã‚¦ãƒ³ãƒ‰ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚

1. AddRoundKey
ç§˜å¯†éµã‹ã‚‰ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã«å¿œã˜ãŸãƒ©ã‚¦ãƒ³ãƒ‰éµã‚’ç”Ÿæˆã— XOR ã‚’å–ã‚‹ã€‚
2. SubBytes (Substitution)
1 ãƒã‚¤ãƒˆã®ç½®æ›è¡¨ S-box ã‚’ç”¨ã„ã¦ãƒã‚¤ãƒˆã”ã¨ã«å¤‰æ›ã—ã¾ã™ã€‚AES ã§ã¯ä¸‹ã® S-box ã‚’ç”¨ã„ã¾ã™ã€‚å˜ç´”ã§ã™ãŒ AES ã®ç½®æ›è¡¨ã¯éç·šå½¢å¤‰æ›ã¨ãªã‚Šã€å·®åˆ†è§£ææ³•ãªã©ã®æ”»æ’ƒã«å¯¾ã—ã¦ã‹ãªã‚Šå¼·ãã€AES ã®å®‰å…¨æ€§ã®è¦ã¨ãªã£ã¦ã„ã¾ã™ã€‚
3. ShiftRows (Permutation)
16 ãƒã‚¤ãƒˆã‚’ 4Ã—4 ã«åˆ†ã‘ã€è¡Œã”ã¨ã«ã‚·ãƒ•ãƒˆã™ã‚‹ã€‚
4. MixColumn (Permutation)
16 ãƒã‚¤ãƒˆã‚’ 4Ã—4 ã«åˆ†ã‘ã€åˆ—ã”ã¨ã«æœ‰é™ä½“ä¸Šã§æ¼”ç®—ã™ã‚‹ã€‚

![](/images/aes.png)

```c
const uint8_t sbox[] = {
  0x63, 0x7c, 0x77, 0x7b, 0xf2, 0x6b, 0x6f, 0xc5, 0x30, 0x01, 0x67, 0x2b, 0xfe, 0xd7, 0xab, 0x76,
  0xca, 0x82, 0xc9, 0x7d, 0xfa, 0x59, 0x47, 0xf0, 0xad, 0xd4, 0xa2, 0xaf, 0x9c, 0xa4, 0x72, 0xc0,
  0xb7, 0xfd, 0x93, 0x26, 0x36, 0x3f, 0xf7, 0xcc, 0x34, 0xa5, 0xe5, 0xf1, 0x71, 0xd8, 0x31, 0x15,
  0x04, 0xc7, 0x23, 0xc3, 0x18, 0x96, 0x05, 0x9a, 0x07, 0x12, 0x80, 0xe2, 0xeb, 0x27, 0xb2, 0x75,
  0x09, 0x83, 0x2c, 0x1a, 0x1b, 0x6e, 0x5a, 0xa0, 0x52, 0x3b, 0xd6, 0xb3, 0x29, 0xe3, 0x2f, 0x84,
  0x53, 0xd1, 0x00, 0xed, 0x20, 0xfc, 0xb1, 0x5b, 0x6a, 0xcb, 0xbe, 0x39, 0x4a, 0x4c, 0x58, 0xcf,
  0xd0, 0xef, 0xaa, 0xfb, 0x43, 0x4d, 0x33, 0x85, 0x45, 0xf9, 0x02, 0x7f, 0x50, 0x3c, 0x9f, 0xa8,
  0x51, 0xa3, 0x40, 0x8f, 0x92, 0x9d, 0x38, 0xf5, 0xbc, 0xb6, 0xda, 0x21, 0x10, 0xff, 0xf3, 0xd2,
  0xcd, 0x0c, 0x13, 0xec, 0x5f, 0x97, 0x44, 0x17, 0xc4, 0xa7, 0x7e, 0x3d, 0x64, 0x5d, 0x19, 0x73,
  0x60, 0x81, 0x4f, 0xdc, 0x22, 0x2a, 0x90, 0x88, 0x46, 0xee, 0xb8, 0x14, 0xde, 0x5e, 0x0b, 0xdb,
  0xe0, 0x32, 0x3a, 0x0a, 0x49, 0x06, 0x24, 0x5c, 0xc2, 0xd3, 0xac, 0x62, 0x91, 0x95, 0xe4, 0x79,
  0xe7, 0xc8, 0x37, 0x6d, 0x8d, 0xd5, 0x4e, 0xa9, 0x6c, 0x56, 0xf4, 0xea, 0x65, 0x7a, 0xae, 0x08,
  0xba, 0x78, 0x25, 0x2e, 0x1c, 0xa6, 0xb4, 0xc6, 0xe8, 0xdd, 0x74, 0x1f, 0x4b, 0xbd, 0x8b, 0x8a,
  0x70, 0x3e, 0xb5, 0x66, 0x48, 0x03, 0xf6, 0x0e, 0x61, 0x35, 0x57, 0xb9, 0x86, 0xc1, 0x1d, 0x9e,
  0xe1, 0xf8, 0x98, 0x11, 0x69, 0xd9, 0x8e, 0x94, 0x9b, 0x1e, 0x87, 0xe9, 0xce, 0x55, 0x28, 0xdf,
  0x8c, 0xa1, 0x89, 0x0d, 0xbf, 0xe6, 0x42, 0x68, 0x41, 0x99, 0x2d, 0x0f, 0xb0, 0x54, 0xbb, 0x16,
};
```

ç´°ã‹ã„å®Ÿè£…ã¯è§£èª¬ã—ã¾ã›ã‚“ã€‚CryptoHack ã‚’è§£ã„ã¦ã‚‹ã¨è‡ªç„¶ã«å®Ÿè£…ã§ãã¾ã™ã€‚

AES-NI: CPU å‘½ä»¤ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§é«˜é€ŸåŒ–

:::message
**ç·´ç¿’å•é¡Œ**
- Hard: AES ã®ãƒ©ã‚¦ãƒ³ãƒ‰å›æ•°ãŒ 2 å›ãªã©å°‘ãªã„å ´åˆã€è§£èª­å‡ºæ¥ã¦ã—ã¾ã„ã¾ã™ã€‚ã©ã†ã™ã‚Œã°è§£èª­ã§ãã‚‹ã§ã—ã‚‡ã†ã‹ã€‚(Pwn2Win CTF 2021 A2S)
:::

### ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
AES ã¯ãƒ–ãƒ­ãƒƒã‚¯æš—å·ãªã®ã§ **16 ãƒã‚¤ãƒˆã”ã¨ã§ã—ã‹** æš—å·åŒ–ã§ãã¾ã›ã‚“ã€‚å¹³æ–‡ã®å§‹ã‚ã‹ã‚‰ 16 ãƒã‚¤ãƒˆãšã¤åˆ‡ã‚Šå‡ºã—ã¦æš—å·åŒ–ã—ã¦ã„ãã¨æœ€å¾Œã«ä½™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚å½“ç„¶ãã‚Œã‚‚æš—å·åŒ–ã—ã¦é€ã‚ŠãŸã„ã®ã§ 16 ãƒã‚¤ãƒˆã«ãªã‚‹ã‚ˆã†ã«é©å½“ãªãƒ‡ãƒ¼ã‚¿ã‚’ãã£ã¤ã‘ã¦æš—å·åŒ–ã—ã¾ã™ã€‚ã“ã®æ“ä½œã‚’ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¨å‘¼ã³ã¾ã™ã€‚

![](/images/padding.png)

AES ã§ã¯ [PKCSÂ #7 Padding](https://datatracker.ietf.org/doc/html/rfc2315#section-10.3) ã¨ã„ã†è¦æ ¼ã§ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã€‚PKCS #7 Padding ã¯æ¬¡ã®ã‚ˆã†ã«ä½™ã£ãŸæ•°ã‚’ãã®ã¾ã¾ãƒã‚¤ãƒˆã«å¤‰æ›ã—ã¦ä½™ã£ãŸæ•°ã ã‘ç¹‹ã’ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚é€†ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸæ–‡å­—åˆ—ã‹ã‚‰å…ƒã®æ–‡å­—åˆ—ã«æˆ»ã™ã¨ãã¯æœ€å¾Œã®ãƒã‚¤ãƒˆã®æ•°ã‚’è¦‹ã¦ãã®æ•°ã ã‘å‰Šã£ãŸã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

å…·ä½“ä¾‹ã¨ã—ã¦ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```python
from Crypto.Util.Padding import pad, unpad

# text -> pad(text, 16)
b''                 -> b'\x10' * 0x10
b'a'                -> b'a' + b'\x0f' * 0xf
b'Cryptography'     -> b'Cryptography\x04\x04\x04\x04'
b'GettingOverIt'    -> b'GettingOverIt\x03\x03\x03'
b'Lycoris Recoil'   -> b'Lycoris Recoil\x02\x02'
b'No Game No Life'  -> b'No Game No Life\x01'
b'Sound! Euphonium' -> b'Sound! Euphonium' + b'\x10' * 0x10

# text -> unpad(text, 16)
b'0123456789ab\x04\x03\x04\x04'    -> error
b'0123456789ab\x04\x04\x03\x03'    -> error
b'0123456789abc\x03\x02\x01'       -> b'0123456789abc\x03\x02'
b'0123456789abcd\x02\x02'          -> b'0123456789abcd'
b'0123456789abcde\x02'             -> error
b'0123456789abcdef'                -> error
b'0123456789abcdef' + b'\x10' * 16 -> b'0123456789abcdef'
```

## æš—å·åˆ©ç”¨ãƒ¢ãƒ¼ãƒ‰
é€šå¸¸ã®æš—å·åŒ–é–¢æ•°ã®ã¿ã§å®Ÿè£…ã™ã‚‹ã¨ã‚¹ãƒˆãƒªãƒ¼ãƒ æš—å·ãŒä½¿ãˆãªã‹ã£ãŸã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«è„†å¼±ãªå±é™ºæ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚’æ”¹å–„ã™ã‚‹ç‚ºã«ä½œã‚‰ã‚ŒãŸã®ãŒæš—å·åˆ©ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚

AES ã®æš—å·åŒ–é–¢æ•°è‡ªä½“ã®è§£èª­ä¸å¯èƒ½æ€§ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã¦æš—å·åˆ©ç”¨ãƒ¢ãƒ¼ãƒ‰ã‚„ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®è„†å¼±æ€§ã«ã‚ˆã‚Šæ”»æ’ƒã§ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ç‰¹ã« CTF ã§ã¯ ECB, CBC, GCM ãƒ¢ãƒ¼ãƒ‰ãŒä½¿ã‚ã‚Œã‚‹ã®ã§ã“ã‚Œã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚ãã®ä»–ã®æš—å·åˆ©ç”¨ãƒ¢ãƒ¼ãƒ‰ã¯ Wikipedia ã‚„ [NIST SP 800-38A Recommendation for Block Cipher Modes of Operation](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-38a.pdf) ãªã©ã‚’å‚ç…§ã™ã‚‹ã¨è‰¯ã„ã§ã™ã€‚

https://ja.wikipedia.org/wiki/%E6%9A%97%E5%8F%B7%E5%88%A9%E7%94%A8%E3%83%A2%E3%83%BC%E3%83%89

### AES-ECB (Electronic CodeBlock)
å¹³æ–‡ã‚’ 16 ãƒã‚¤ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã”ã¨ã«æš—å·åŒ–ã—ã¦æš—å·æ–‡ã‚’ä½œã‚Šã€å¾©å·ã‚‚ãƒ–ãƒ­ãƒƒã‚¯ã”ã¨ã«å¾©å·ã™ã‚‹ã¨ã„ã†æœ€ã‚‚å˜ç´”ãªæš—å·åˆ©ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚

$$
\begin{aligned}
C_i & = E_K(P_i) \\
P_i & = E_K(C_i)
\end{aligned}
$$

![](/images/ECB_encryption.png)
![](/images/ECB_decryption.png)

### ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒ
ä¸€è¦‹ï¾–ï½¼ï½¯ã£ã¦è¨€ã„ãŸããªã‚Šã¾ã™ãŒå„ãƒ–ãƒ­ãƒƒã‚¯ã§ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒãŒå¯èƒ½ã§ã™ã€‚

AES-ECB ã§ã¯ãƒ–ãƒ­ãƒƒã‚¯ã”ã¨ã«å¹³æ–‡ã¨æš—å·æ–‡ãŒå¯¾å¿œã™ã‚‹ã®ã§ã€æš—å·æ–‡ä¸­ã«çŸ¥ã£ã¦ã‚‹ãƒšã‚¢ã®æš—å·æ–‡ã‚’åŸ‹ã‚è¾¼ã‚€ã“ã¨ã§ã©ã®ãƒ–ãƒ­ãƒƒã‚¯ã§ã‚‚æ„å›³ã—ãŸã‚ˆã†ã«æ”¹ã–ã‚“å‡ºæ¥ã¦ã—ã¾ã„ã¾ã™ã€‚

![](/images/aes_ecb.png)

ã“ã‚Œã‚’é˜²ãã«ã¯ãã‚Œãã‚Œã®ãƒ–ãƒ­ãƒƒã‚¯ã«ç´°å·¥ã‚’ä»•è¾¼ã‚“ã§æ„å›³ã—ãŸãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒã‚’ã•ã›ãªã„ã‚ˆã†ã«ã™ã‚Œã°è‰¯ã•ãã†ã§ã™ã€‚ãã®ã‚ˆã†ã«ã—ã¦è€ƒãˆã‚‰ã‚ŒãŸã®ãŒæ¬¡ã§ç´¹ä»‹ã™ã‚‹ CBC ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚

:::message
**ç·´ç¿’å•é¡Œ**
ECB ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒã‚’å¿œç”¨ã—ã¦æ¬¡ã®ã‚ˆã†ãªæ”»æ’ƒãŒã§ãã¾ã™ã€‚
- Medium: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»»æ„ã®æ–‡å­—åˆ— `m` ã‚’ä¸ãˆã‚‹ã¨ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ ECB ãƒ¢ãƒ¼ãƒ‰ã§æš—å·åŒ–ã•ã‚ŒãŸ `Enc(m | flag)` ãŒé€ã‚‰ã‚Œã¦ãã‚‹ã¨ããƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ `flag` ã‚’ç²å¾—ã§ãã‚‹ã€‚ã©ã†ã‚„ã£ã¦ï¼Ÿ
- Medium: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰é€ã‚‰ã‚Œã¦ãã‚‹å¹³æ–‡ã‚’ AES-ECB ã§æš—å·åŒ–ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ä¸Šã§ json ãªã©ã‚ã‚‹å½¢å¼ã«ãŠã„ã¦ç‰¹å®šã®æ„å‘³ã‚’æŒã¤å¹³æ–‡ã®æš—å·åŒ–ã‚’ç¦æ­¢ã—ã¦ã‚‚ãƒã‚¤ãƒ‘ã‚¹ã•ã‚Œã‚‹å±é™ºæ€§ãŒã‚ã‚‹ã€‚ãªãœã‹ã€‚
:::

### AES-CBC (Cipher Block Chaining)
CBC ãƒ¢ãƒ¼ãƒ‰ã¯ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«ã‚ˆã£ã¦ã¯è„†å¼±ã¨ãªã‚Šã†ã‚‹ã®ã§ TLS 1.3 ã§å»ƒæ­¢ã•ã‚Œã¾ã—ãŸã€‚

CBC ãƒ¢ãƒ¼ãƒ‰ã§ã¯éµä»¥å¤–ã«åˆæœŸãƒ™ã‚¯ãƒˆãƒ« IV (Initialization Vector) ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã“ã‚Œã‚’åˆæœŸçŠ¶æ…‹ã¨ã—ã¦å‰ã®æš—å·æ–‡ã¨å¹³æ–‡ã¨æ›ã‘åˆã‚ã›ã¦æš—å·åŒ–ã™ã‚‹ã“ã¨ã‚’ç¹°ã‚Šè¿”ã—ã¦æš—å·åŒ–ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦å„ãƒ–ãƒ­ãƒƒã‚¯ã§ã®ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚

$$
\begin{aligned}
C_i & = \begin{cases}
  IV & (i = 0) \\
  E_K(P_i\oplus C_{i-1}) & (i > 0)
\end{cases} \\
P_i & = E_K(C_i)\oplus C_{i-1}
\end{aligned}
$$

ã—ã‹ã—ã‚ˆãè€ƒãˆã¦ã¿ã‚‹ã¨ä¾ç„¶ã¨ã—ã¦å…¨ä½“ã®ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒã¯å‡ºæ¥ã¦ã—ã¾ã„ã¾ã™ã€‚ãã‚Œã‚’è§£æ±ºã•ã›ã‚‹ã«ã¯åˆå›ã§è©±ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ”¹ã–ã‚“æ¤œçŸ¥: MAC ã‚’ç”¨ã„ã‚‹ã“ã¨ã§æ¤œè¨¼ã‚’è¡Œã„ã€ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’æ¤œçŸ¥ã—ã¾ã™ã€‚

![](/images/CBC_encryption.png)
![](/images/CBC_decryption.png)

### Padding Oracle Attack
Padding Oracle Attack ã¨ã¯ AES-CBC ã«ãŠã„ã¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ã‚’æƒ…å ±æºã¨ã—ã¦å¹³æ–‡ã‚’æ±‚ã‚ã‚‹æ”»æ’ƒã§ã™ã€‚
Oracle ã¯ä¼æ¥­ã® Oracle ã§ã¯ãªãã¦ç¥æ§˜ãŒç™ºã—ãŸè¨€è‘‰; ç¥è¨—ã®ã“ã¨ã§ã™ã€‚

ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ã‹ã©ã†ã‹ã¨ã„ã†ã®ã¯å¹³æ–‡ãŒæ¬¡ã®æ¡ä»¶ã‚’æº€ãŸã™ã‹ã©ã†ã‹ã«å¯¾å¿œã—ã¾ã™ã€‚

```
~~~ ...  ~~~~~~  \x01
~~~ ...  ~~~ \x02\x02
~~~ ...  \x03\x03\x03
...
\x10\x10 ... \x10\x10
```

å¹³æ–‡ãŒä¸Šã®ã‚ˆã†ãªæ–‡å­—åˆ—ã§ã‚ã‚Œã°ã‚¨ãƒ©ãƒ¼ã¯å‡ºãšã€ãã†ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ã€‚

å¾©å·ã¨ã„ã†ã®ã¯æ¬¡ã®ã‚ˆã†ã«è¨ˆç®—ã™ã‚‹ã‚‚ã®ã§ã—ãŸã€‚$\mathrm{Dec}_K(C_n)$ ã¯æ›¸ãæ›ãˆã‚‰ã‚Œãšã€ $C_{n-1}$ ã¯æ›¸ãæ›ãˆã‚‰ã‚Œã‚‹ãªã‚‰ $P_n$ ã‚‚è‡ªç”±ã«æ›¸ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚

$$
P_n = \mathrm{Dec}_K(C_n) \oplus C_{n-1}
$$

ã“ã“ã§ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ã®æƒ…å ±ã‚’ç”¨ã„ã‚‹ã“ã¨ã§æ¡ä»¶ã‚’æº€ãŸã™å¹³æ–‡ $P_n$ ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã€æ¬¡ã®å¼ã‹ã‚‰ $\mathrm{Dec}_K(C_n)$ ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

$$
\mathrm{Dec}_K(C_n) = P_n \oplus C_{n-1}
$$

ãã‚Œã§ã¯ã“ã® $\mathrm{Dec}_K(C_n)$ ã‚’æ±‚ã‚ã‚‹ã“ã¨ã‚’è€ƒãˆã¾ã™ã€‚

ã¾ãšæ¡ä»¶ã®ä¸­ã§ä¸€ç•ªç¢ºç‡ã®é«˜ã„ã‚‚ã®ã¯æœ€å¾Œã®ãƒã‚¤ãƒˆãŒ `\x01` ã®ã¨ããªã®ã§ã€ãã‚Œã‚’ç‹™ã„ã«ã„ãã¾ã™ã€‚

æ¬¡ã®ã‚ˆã†ã« $C_{n-1}$ ã‚’æ›¸ãæ›ãˆãŸ 256 å€‹ã®æš—å·æ–‡ã‚’é€ã‚Šã¾ã™ã€‚(`[A-B]` ã¯ `A` ã‹ã‚‰ `B` ã¾ã§ã®ãã‚Œãã‚Œã®æ–‡å­—ã«ç½®ãæ›ãˆãŸæ–‡å­—åˆ—ã®é›†åˆã¨ã—ã¾ã™ã€‚)

```
\x00\x00 ... \x00[\x00-\xff]
```

256 å›é€ã‚‹ã¨ 254, 255 å›ã¯ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ã§ã™ãŒã€æ¡ä»¶ã‚’æº€ãŸã™ã“ã¨ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„æš—å·æ–‡ãŒå‡ºã¦ãã¾ã™ã€‚ä»Šå›ã¯æº€ãŸã—ãŸæ¡ä»¶ãŒæœ€å¾Œã®ãƒã‚¤ãƒˆãŒ `\x01` ã§ã‚ã‚‹ã¨ãã¨ã—ã¾ã™ã€‚ã“ã®ã¨ãã®æš—å·æ–‡ã¨å¹³æ–‡ã®é–¢ä¿‚ã‚’è€ƒãˆã‚‹ã¨ $\mathrm{Dec}_K(C_n)$ ã®æœ€å¾Œã® 1 ãƒã‚¤ãƒˆãŒåˆ†ã‹ã‚Šã¾ã™ï¼ä¾‹ãˆã°ã‚¨ãƒ©ãƒ¼ã˜ã‚ƒãªã„æš—å·æ–‡ãŒ `\x12` ã ã£ãŸã‚‰ $\mathrm{Dec}_K(C_n)$ ã¯ `\x13` ã¨ãªã‚Šã¾ã™ã€‚

```
C: \x00\x00 ... \x00\x12
P:   ~~~    ...  ~~ \x01
D:   ~~~    ...  ~~ \x13
```

æ¬¡ã« `\x02\x02` ã¨ãªã‚‹å ´åˆã‚’è€ƒãˆã¦ã¿ã¾ã™ã€‚$\mathrm{Dec}_K(C_n)$ ã®æœ€å¾Œã® 1 ãƒã‚¤ãƒˆãŒåˆ†ã‹ã£ã¦ã„ã‚‹ã®ã§æ¬¡ã®ã‚ˆã†ã«æ¢ç´¢ã™ã‚Œã°ã„ã„ã§ã™ã­ã€‚

```
C: \x00\x00 ... \x00[\x00-\xff]\x11
P:   ~~~    ...  ~~  \x02      \x02
D:   ~~~    ...  ~~   ?        \x13
```

ãã†ã—ã¦ã‚¨ãƒ©ãƒ¼ã§ãªã„ã‚‚ã®ãŒè¦‹ã¤ã‹ã£ãŸã‚‰ $\mathrm{Dec}_K(C_n)$ ã®æœ€å¾Œã® 2 ãƒã‚¤ãƒˆç›®ã‚‚åˆ†ã‹ã£ã¦ã—ã¾ã„ã¾ã™ï¼

```
C: \x00\x00 ... \x00\xab\x11
P:   ~~~    ...  ~~ \x02\x02
D:   ~~~    ...  ~~ \xa9\x13
```

ã“ã®ã‚ˆã†ã«ç¹°ã‚Šè¿”ã™ã“ã¨ã§ $\mathrm{Dec}_K(C_n)$ ã®ã™ã¹ã¦ãŒåˆ†ã‹ã‚Šã€å…ƒã® $C_{n-1}$ ã¨ XOR ã™ã‚‹ã“ã¨ã§ $P_n$ ãŒåˆ†ã‹ã‚Šã¾ã™ï¼

ã“ã®ã‚ˆã†ã« Oracle ã‚’åˆ©ç”¨ã—ã¦ AES-CBC ã‚’è§£èª­ã™ã‚‹æ”»æ’ƒã‚’ CBC ãƒ¢ãƒ¼ãƒ‰ã«ãŠã‘ã‚‹ Padding Oracle Attack ã‚ã‚‹ã„ã¯ POODLE Attack (Padding Oracle On Downgraded Legacy Encryption) ã¨è¨€ã„ã¾ã™ã€‚CTF ã§ã¯ Padding Oracle Attack ã‚’ä½¿ã£ã¦ 1 ãƒ–ãƒ­ãƒƒã‚¯åˆ†ã®æš—å·åŒ–/å¾©å·é–¢æ•° $E_k, D_k$ ã‚’ä½œã‚Šã€æš—å·æ–‡ã«é©ç”¨ã—ã¦ã„ãã“ã¨ã§è§£ã„ã¦ã„ãã¾ã™ã€‚

ã•ã‚‰ã«ã“ã‚Œã‚’å¿œç”¨ã—ã¦ BEAST Attack (Browser Exploit Against SSL/TLS) ã¯ TLS ã®è„†å¼±æ€§ã‚’ç”¨ã„ãŸæ”»æ’ƒãŒã§ãã€Cookie ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ç‹™ã†ã“ã¨ãŒã§ãã‚‹ãªã©å®Ÿç”¨çš„ãªæ”»æ’ƒãŒé€šã‚Šã¾ã—ãŸã€‚ç¾åœ¨ã¯ Same Origin Policy ã«ã‚ˆã£ã¦é˜²æ­¢ã•ã‚Œã¾ã—ãŸã€‚

Lucky Thirteen Attack ã§ã¯ Oracle ã§ã¯ãªããƒ‘ãƒ‡ã‚£ãƒ³ã‚°å‡¦ç†ã®å¾®å¦™ãªé…ã‚Œã‚’æ¤œçŸ¥ã—ã¦åŒæ§˜ã®æ”»æ’ƒã‚’ã—ã¾ã™ã€‚([å…ƒè«–æ–‡](https://ieeexplore.ieee.org/iel7/6547086/6547088/06547131.pdf) ã«ã‚ˆã‚‹ã¨ 1 å›ã®æš—å·åŒ–ã§ã¯æ™‚é–“å·® 80ns ç¨‹åº¦ã—ã‹ãªã®ã§æ•°åƒå›ç¹°ã‚Šè¿”ã™ã“ã¨ã§å·®ã‚’æ¤œçŸ¥ã—ã¾ã™ã€‚)

ã¾ã¨ã‚ã‚‹ã¨ CBC ãƒ¢ãƒ¼ãƒ‰è‡ªä½“ã¯å®‰å…¨ãªã®ã§ã™ãŒã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ä½œã‚Šæ–¹ã‚„çµ„ã¿åˆã‚ã›æ–¹ã«ã‚ˆã£ã¦ã¯å®‰å…¨ã§ã¯ãªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚ãªã®ã§ CBC ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ©ç”¨ã™ã‚‹ã¨ãã«ã¯å¤šãã®ã“ã¨ã«æ³¨æ„ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

:::message
**ç·´ç¿’å•é¡Œ**
OFB ãƒ¢ãƒ¼ãƒ‰ã§ Padding Oracle Attack ãŒã§ãã‚‹ã§ã—ã‚‡ã†ã‹
:::

### AES-GCM (Galois/Counter Mode)
AES åˆ©ç”¨ãƒ¢ãƒ¼ãƒ‰ã®ä¸­ã§ TLS 1.3 ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹å”¯ä¸€ã®ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚ã‚¬ãƒ­ã‚¢ä½“ (æœ‰é™ä½“) ä¸Šã§ Counter (CTR) ãƒ¢ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã®ã§ã“ã‚“ãªåå‰ã«ãªã£ã¦ã¾ã™ã€‚

ä»•çµ„ã¿ã¨ã—ã¦ã¯éµã‹ã‚‰ç”Ÿæˆã•ã‚Œã‚‹éµã‚¹ãƒˆãƒªãƒ¼ãƒ ã¨å¹³æ–‡ã‚’ XOR ã™ã‚‹ã“ã¨ã§æš—å·æ–‡ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

![](/images/aes_gcm.png)

ã“ã‚Œã ã‘ã ã¨å¹³æ–‡ãŒçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹ã¨æ„å›³ã—ãŸå¹³æ–‡ã«è‡ªç”±ã«æ›¸ãæ›ãˆã‚‰ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚ãã“ã§æš—å·æ–‡ã®ä»–ã«èªè¨¼ã‚¿ã‚°ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã“ã‚Œã¯æš—å·æ–‡ãŒæ”¹ã–ã‚“ã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’æ¤œçŸ¥ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ”¹ã–ã‚“æ¤œçŸ¥ (MAC; Message Authentication Code) ã¨åŒç­‰ã®æ©Ÿèƒ½ã‚’ã‚‚ã¤ã‚¿ã‚°ã§ã™ã€‚éµãŒåˆ†ã‹ã‚‰ãªã‘ã‚Œã°èªè¨¼ã‚¿ã‚°ã‚’ä¿®æ­£ã§ããªã„ã®ã§æš—å·æ–‡ã‚’æ”¹ã–ã‚“å‡ºæ¥ã¦ã‚‚èªè¨¼ã‚¿ã‚°ãŒä¸€è‡´ã—ãªã„ã“ã¨ã‹ã‚‰æ”¹ã–ã‚“ã‚’æ¤œçŸ¥å‡ºæ¥ã¾ã™ã€‚

ä¸€èˆ¬ã«æš—å·åŒ–ã¨åŒæ™‚ã«å®Œå…¨æ€§ã‚„èªè¨¼æ€§ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®æš—å·æ–¹å¼ãŒè€ƒæ¡ˆã•ã‚Œã€ãã‚Œã‚‰ã‚’ç·ç§°ã—ã¦ AEAD (Authenticated Encryption with Asocciated Data) ã¨å‘¼ã°ã‚Œã¾ã™ã€‚æš—å·ã‚¹ã‚¤ãƒ¼ãƒˆã® MAC ã®éƒ¨åˆ†ã« AEAD ã¨ã„ã†è¡¨è¨˜ãŒã‚ã‚‹ã‚‚ã®ã¯ã€æš—å·ãƒ¢ãƒ¼ãƒ‰ã¨ã—ã¦èªè¨¼ä»˜ãæš—å·ã® GCM ãŒåˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã¾ãš GHASH ã¨ GCTR ã¨ã„ã†æ“ä½œã‚’å®šç¾©ã—ã¾ã™ã€‚

> **Def. GHASH**
> 128-bit ãƒ–ãƒ­ãƒƒã‚¯ã®å…¥åŠ›ã‚’ $X = X_1\|\cdots\|X_n$ã€ $H = E_k(Z_{f, 128}(0))$ ã¨ãŠãã¾ã™ã€‚ã“ã®ã¨ãæ¬¡ã®ã‚ˆã†ã« $\lbrace Y_i\rbrace$ ã‚’ç”Ÿæˆã—ãŸã¨ã GHASH é–¢æ•°ã‚’ $\mathrm{GHASH}_H(X) = Y_n$ ã¨å®šç¾©ã—ã¾ã™ã€‚
>
> $$
\begin{aligned}
Y_0 & = 0 \\
Y_i & = (X_i + Y_{i-1})\cdot H \\
\end{aligned}
$$
>
> ãŸã ã—ã€$\lbrace Y_i\rbrace$ ã¯æœ‰é™ä½“ $\mathbb{F}_{2^{128}} \cong \mathbb{F}_2[x]/(x^{128} + x^7 + x^2 + x + 1)$ ä¸Šã§è¨ˆç®—ã•ã‚Œã¾ã™ã€‚

> **Def. GCTR**
> 128-bit ãƒ–ãƒ­ãƒƒã‚¯ã®å…¥åŠ›ã‚’ $X = X_1\|\cdots\|X_n$ã€éµã‚’ $K$ ã¨ã—ã¦ç”Ÿæˆã—ãŸ $\lbrace Y_i\rbrace$ ã«å¯¾ã—ã¦ $Y = Y_1\|\cdots\|Y_n$ ã¨ã™ã‚‹ã¨ GCTR é–¢æ•°ã‚’ $\mathrm{GCTR}_K(ICB, X) = Y$ ã¨å®šç¾©ã—ã¾ã™ã€‚
>
> $$
Y_i = E_K(ICB + (i-1)) \oplus X_i \qquad (i = 1,\ldots,n)
$$

ãã‚Œã§ã¯å®Ÿéš›ã«ã“ã‚Œã‚‰ã‚’ç”¨ã„ã¦å®Ÿè£…ã—ã¾ã™ã€‚

ã¾ãšæš—å·æ–‡ã‚’è¨ˆç®—ã—ã¾ã™ã€‚$J_0$ ã¨ã„ã†è¦‹æ…£ã‚Œãªã„è¨˜å·ãŒã‚ã‚Šã¾ã™ãŒã€è¦ã™ã‚‹ã«åˆæœŸãƒ™ã‚¯ãƒˆãƒ« $IV$ ã®ãƒãƒƒã‚·ãƒ¥å€¤ã ã¨æ€ãˆã°ã„ã„ã§ã™ã€‚

$$
\begin{aligned}
J_0 & = \begin{cases}
Z_{b, 128}(IV) + 1 & (\mathrm{len}(IV) = 96) \\
\mathrm{GHASH}_H(Z_{b, 128}(IV)\|Z_{f, 128}(\mathrm{len}(IV))) & (\mathrm{len}(IV) \neq 96)
\end{cases} \\
C & = \mathrm{GCTR}_K(J_0 + 1, P)
\end{aligned}
$$

ã“ã‚Œã§æš—å·æ–‡ãŒä½œã‚Œã¾ã—ãŸï¼

èªè¨¼ã‚¿ã‚°ã¯æš—å·æ–‡ $C$ ã¨ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã®èªè¨¼ãƒ‡ãƒ¼ã‚¿ (AAD; Additional Authenticated Data) $A$ ã‚’ç”¨æ„ã—ã¦æŠ•ã’ã‚‹ã¨å‡ºã¦ãã¾ã™ã€‚æ¬¡ã®ã‚ˆã†ã«è¨ˆç®—ã—ã¦å‡ºã¦ããŸ 128 ãƒ“ãƒƒãƒˆã® $T$ ã‚’ä¸Šã‹ã‚‰å¹³æ–‡ã®é•·ã•ã ã‘å–ã£ã¦ããŸã‚‚ã®ãŒèªè¨¼ã‚¿ã‚°ã¨ãªã‚Šã¾ã™ã€‚

$$
T = \mathrm{GCTR}_K(J_0, \mathrm{GHASH}_H(Z_{b, 128}(A)\|Z_{b, 128}(C)\|Z_{f, 64}(\mathrm{len}(A))\|Z_{f, 64}(\mathrm{len}(C))))
$$

å¾©å·ã¯èªè¨¼ã‚¿ã‚°ã‚’åŒæ§˜ã«è¨ˆç®—ã—ã¦é€ã‚‰ã‚Œã¦ããŸã‚¿ã‚°ã¨ä¸€è‡´ã—ãªã‹ã£ãŸã‚‰å¤±æ•—ã€ä¸€è‡´ã—ã¦ãŸã‚‰æ¬¡ã®ã‚ˆã†ã«å¹³æ–‡ã‚’è¨ˆç®—ã—ã¦è¿”ã—ã¾ã™ã€‚

$$
P = \mathrm{GCTR}_K(J_0 + 1, C)
$$

èªè¨¼ã‚¿ã‚°ã‚’æ¸¡ã•ãªã„ã“ã¨ã®ä»–ã«ã‚‚è„†å¼±æ€§ã‚’ç”Ÿã‚€åŸå› ãŒã‚ã‚Šã¾ã™ã€‚

### Nonce ã®ä½¿ã„ã¾ã‚ã—
ãƒŠãƒ³ã‚¹ (Nonce; Number used once) ã¨ã¯ä¸€æ™‚çš„ã«ç”¨ã„ã‚‰ã‚Œã‚‹ä¹±æ•°ã®ã“ã¨ã§ã€ã“ã“ã§ã¯åˆæœŸãƒ™ã‚¯ãƒˆãƒ« $IV$ ã‚’æŒ‡ã—ã¾ã™ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨éµã«å¯¾ã—ã¦ Nonce ãŒãƒ©ãƒ³ãƒ€ãƒ ã§ã¯ãªã„ã¨ã™ã‚‹ã¨ã€ã‚ã‚‹å¹³æ–‡ã¨æš—å·æ–‡ã®ãƒšã‚¢ãŒåˆ†ã‹ã‚Œã° XOR ã‚’å–ã‚‹ã“ã¨ã§å…ˆã»ã©ã®ä¹±æ•°åˆ—ãŒåˆ†ã‹ã‚Šã€ä»»æ„ã®æš—å·æ–‡ã®è§£èª­ãŒå‡ºæ¥ã¦ã—ã¾ã„ã¾ã™ã€‚

ã•ã‚‰ã«èªè¨¼ã‚¿ã‚°ã«ã¤ã„ã¦ã‚‚å·®åˆ†è§£èª­æ³•ã‚’ç”¨ã„ã¦è§£èª­ã§ãã¾ã™ã€‚

https://eprint.iacr.org/2016/475.pdf

:::message
**ç·´ç¿’å•é¡Œ**
- Easy: åŒã˜éµã® AES-ECB ã®æš—å·åŒ–ãŒã§ãã‚‹ã¨ã AES-GCM ã‚’è§£èª­ã§ãã¾ã™ã€‚ã©ã†ã‚„ã£ã¦ï¼Ÿ
:::

### ã•ã‚‰ãªã‚‹æ”»æ’ƒ
- ã‚µã‚¤ãƒ‰ãƒãƒ£ãƒãƒ«æ”»æ’ƒ
å‘¨è¾ºã«æ¼ã‚Œå‡ºã‚‹é›»ç£æ³¢ã‚„ã€å‡¦ç†ã«ã‚ˆã£ã¦ç•°ãªã‚‹æ¶ˆè²»é›»åŠ›ã®å·®ãªã©ã‚’è¦³æ¸¬ã—ã¦èªè¨¼æƒ…å ±ã‚’æ¨æ¸¬ã—ãŸã‚Šã€ä¸æ­£ãªé›»åœ§ã‚’å°åŠ ã™ã‚‹ã“ã¨ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®é˜²å¾¡å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹æ”»æ’ƒã§ã™ã€‚
- å·®åˆ†è§£èª­æ³• (Differential Cryptoanalysis)
åˆã‚ã¦å·®åˆ†è§£èª­æ³•ã«ã‚ˆã£ã¦è§£èª­ã•ã‚ŒãŸæš—å·ã¯ FEAL4 ã§ã™ã€‚
- ç·šå½¢è§£èª­æ³• (Integral Cryptoanalysis)
[traP ã« è¨˜äº‹ãŒã‚ã‚‹ã‚‰ã—ã„](https://trap.jp/post/641/)
- è€é‡å­æ€§
æœ€è¿‘ã ã¨è€é‡å­æ€§ã‚‚è€ƒãˆã‚‹å¿…è¦ãŒå‡ºã¦ãã¾ã—ãŸã€‚é‡å­ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®1ã¤ Grover's algorithm ã«ã‚ˆã£ã¦å…¨æ¢ç´¢ã®è¨ˆç®—é‡ãŒ $2^{K}\to 2^{K/2}$ ã¨æ¸›å°‘ã—ãŸç‚ºã€éµé•·ã‚’å€ã®é•·ã•ã«ã—ãªã„ã¨åŒã˜å®‰å…¨æ€§ã‚’æ‹…ä¿ã§ãã¾ã›ã‚“ã€‚

## ãã®ä»–ã®å…±é€šéµæš—å·
CTFer ã¯ AES ã ã‘ã‚’çŸ¥ã£ã¦ã„ã‚Œã°å…±é€šéµæš—å·ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ãŸã¨è¨€ã£ã¦ã‚‚ã„ã„ã®ã§ã™ãŒã€æš—å·å¥½ãer ãªã‚‰ä»–ã«ã‚‚ã‚ã‚‹ã“ã¨ã‚’è¦šãˆã¦ã„ã£ã¦ã»ã—ã„ã§ã™ã€‚ã¾ãŸã“ã®ä»–ã«ã‚‚ç¾åœ¨ã‚¼ãƒ­çŸ¥è­˜æ€§ã‚„å®Œå…¨æº–åŒå‹æ€§ã€ä½é…å»¶ã€è€é‡å­æ€§ãªã©ã‚’æº€ãŸã—ãŸå…±é€šéµæš—å·ã‚’è¦‹ã¤ã‘ã‚‹ç‚ºã«è­°è«–ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ãƒƒãƒ‰

> **ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ãƒƒãƒ‰ (ãƒãƒ¼ãƒŠãƒ æš—å·)**
> ç–‘ä¼¼ä¹±æ•°ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸæ•°åˆ—ã‚’å…±é€šéµã¨ã—ã¦å…±æœ‰ã—ã€å¹³æ–‡ã«å¯¾ã—ã¦ç¹°ã‚Šè¿”ã—éµã§ XOR ã‚’æ›ã‘ã‚‹æš—å·ã§ã™ã€‚
>
> å…·ä½“çš„ã«ã¯ $i = 0,\ldots, m$ ã¨ã—ã¦ãƒã‚¤ãƒˆã”ã¨ã«åˆ†ã‘ãŸå¹³æ–‡ $P_i$ ã¨ $n$ ãƒã‚¤ãƒˆã®éµ $K_i$ ã¨ã—ã¦æš—å·æ–‡ $C_i = P_i \oplus K_{i \bmod n}$ ã¨è¨ˆç®—ã™ã‚‹ã€‚

é »åº¦è§£æã™ã‚Œã°è§£èª­ã§ãã‚‹ã®ã§ç¾åœ¨ä½¿ã‚ã‚Œã¦ã„ã¾ã›ã‚“ã€‚CTF ã§å‡ºã¦ããŸã‚‰ CyberChef ã¨ã‹ã«ä»»ã›ã‚‹ã¨ã‚ˆã•ãã†ã€‚

### DES
DES ã¯ AES ä»¥å‰ã«ä½¿ã‚ã‚Œã¦ã„ãŸå…±é€šéµæš—å·ã§ã™ã€‚DES ã¯å†…éƒ¨ã§ Feistel æ§‹é€ ã‚’ç”¨ã„ã¦ã„ã¾ã™ã€‚

> **Feistel æ§‹é€ **
> DES ã§ä½¿ã‚ã‚ŒãŸæš—å·åŒ–ã®ç‚ºã®å†…éƒ¨æ§‹é€ ã§ã™ã€‚
>
> æš—å·åŒ–: $R_{r+1} = L_r \oplus F(R_r, k_r)$, $L_{r+1} = R_r$
> å¾©å·: $L_r = R_{r+1} \oplus F(L_{r+1}, k_r)$, $R_r = L_{r+1}$

![](https://upload.wikimedia.org/wikipedia/commons/thumb/d/d2/Feistel.png/220px-Feistel.png)

ãŸã ã— Feistel æ§‹é€ ã¯æ’¹æ‹Œæ€§ãŒã‚ˆããªã„ã“ã¨ãŒçŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚ŒãŒ DES ã®è„†å¼±æ€§ã¨ãªã‚Šã€ãã®å¯¾ç­–ã¨ã—ã¦éµé•·ã‚’ 3 å€ã«ã—ãŸ 3-DES ãŒè€ƒæ¡ˆã•ã‚Œã¾ã—ãŸãŒã€æœ¬è³ªçš„ã«ã¯åŒã˜ã ã‹ã‚‰ã‚ˆã‚Šå¼·ã„å…±é€šéµæš—å·ã‚’æ±‚ã‚ AES ãŒç­–å®šã•ã‚Œã¾ã—ãŸã€‚

### ChaCha20-Poly1305
TLS 1.3 ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹å”¯ä¸€ã®æ”¿åºœæ©Ÿé–¢ã«ä¾ã‚‰ãªã„æš—å·ã§ã™ã€‚
ChaCha20 ãŒã‚¹ãƒˆãƒªãƒ¼ãƒ æš—å·ã§ Poly1305 ãŒ MAC ã§å…¨ä½“ã§ AEAD ã®æš—å·æ–¹å¼ã¨ãªã£ã¦ã„ã¾ã™ã€‚
è©³ç´°ã¯æ¬¡ã®è‰¯è³‡æ–™ã‚’èª­ã¿ã¾ã—ã‚‡ã†ï¼

https://tex2e.github.io/blog/crypto/chacha20poly1305

## ã¾ã¨ã‚
å…±é€šéµæš—å·ã®ä»•çµ„ã¿ã¨ AES ã®æ§‹ç¯‰/æ”»æ’ƒã‚’å­¦ã³ã¾ã—ãŸã€‚ã“ã‚Œã§éµãŒã™ã§ã«å…±æœ‰ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ãªã‚‰èª°ã«ã‚‚çŸ¥ã‚‰ã‚Œãšã«é€šä¿¡ã§ãã¾ã™ã€‚ãŸã ä¸€ç•ªè‚å¿ƒãªéµã‚’èª°ã«ã‚‚çŸ¥ã‚‰ã‚Œãšã«å…±æœ‰ã™ã‚‹æ–¹æ³•ãŒåˆ†ã‹ã‚Šã¾ã›ã‚“ã€‚ã“ã‚Œã‚’è§£æ±ºã™ã‚‹æ–¹æ³•ã‚’æ¬¡ã®ç« ã§å­¦ã³ã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®
- [NIST Special Publication 800-38D Recommendation for Block Cipher Modes of Operation: Galois/Counter Mode (GCM) and GMAC](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-38d.pdf)
- [æš—å·åˆ©ç”¨ãƒ¢ãƒ¼ãƒ‰ - Wikipedia](https://ja.wikipedia.org/wiki/%E6%9A%97%E5%8F%B7%E5%88%A9%E7%94%A8%E3%83%A2%E3%83%BC%E3%83%89)
- https://www.scutum.jp/information/waf_tech_blog/2011/10/waf-blog-008.html
- https://gist.github.com/theoremoon/8bcb9b87dcb1289cf13c9db4431db324
- Al Fardan, N.J. and K.G. Paterson, "Lucky Thirteen: Breaking the TLS and DTLS record protocols", n.d., <https://ieeexplore.ieee.org/iel7/6547086/6547088/06547131.pdf>.
- [GoogleãŒTLSã§ã®æ¡ç”¨ã‚’æå”±ã—ã¦ã„ã‚‹å…±é€šéµæš—å·æ–¹å¼ã€ŒChaChaã€ã«ã¤ã„ã¦ã¾ã¨ã‚ãŸ](https://sonickun.hatenablog.com/entry/2016/04/03/183220)
- [ChaCha, a variant of Salsa20](https://cr.yp.to/chacha/chacha-20080128.pdf)
- [RFC 7539 : ChaCha20 and Poly1305 for IETF Protocols](https://tools.ietf.org/html/rfc7539)
